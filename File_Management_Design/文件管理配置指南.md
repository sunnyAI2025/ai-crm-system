# CRM文件管理配置指南

## 概述

本文档详细说明CRM系统文件管理模块的配置方法，包括存储配置、安全配置、图片处理配置、权限配置和部署配置。

## 1. 应用配置

### 1.1 主配置文件

```yaml
# application-file.yml
file:
  # 文件上传配置
  upload:
    # 上传基础路径
    base-path: ./uploads
    # 最大文件大小 (字节)
    max-size: 52428800  # 50MB
    # 允许的文件类型
    allowed-types: .jpg,.jpeg,.png,.gif,.bmp,.webp,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar,.7z
    # 临时文件目录
    temp-path: ./temp
    # 是否启用文件去重
    enable-deduplication: true
    # 文件清理策略
    cleanup:
      # 临时文件保留时间（小时）
      temp-file-retention: 24
      # 已删除文件保留时间（天）
      deleted-file-retention: 30
      # 自动清理间隔（小时）
      cleanup-interval: 6

  # 存储配置
  storage:
    # 存储类型：local, aliyun, aws, minio
    type: local
    # 基础URL
    base-url: http://localhost:50001/files
    # 本地存储配置
    local:
      base-path: ./uploads
      base-url: http://localhost:50001/files
    # 阿里云OSS配置
    aliyun:
      endpoint: https://oss-cn-hangzhou.aliyuncs.com
      access-key-id: ${ALIYUN_ACCESS_KEY_ID}
      access-key-secret: ${ALIYUN_ACCESS_KEY_SECRET}
      bucket-name: ${ALIYUN_OSS_BUCKET}
      base-url: https://your-bucket.oss-cn-hangzhou.aliyuncs.com
    # AWS S3配置
    aws:
      region: us-east-1
      access-key: ${AWS_ACCESS_KEY}
      secret-key: ${AWS_SECRET_KEY}
      bucket-name: ${AWS_S3_BUCKET}
      base-url: https://s3.amazonaws.com/${AWS_S3_BUCKET}
    # MinIO配置
    minio:
      endpoint: http://localhost:9000
      access-key: ${MINIO_ACCESS_KEY}
      secret-key: ${MINIO_SECRET_KEY}
      bucket-name: crm-files
      base-url: http://localhost:9000/crm-files

  # 图片处理配置
  image:
    # 是否启用缩略图
    thumbnail:
      enabled: true
      # 缩略图尺寸 (宽x高)
      sizes: 150x150,300x300,600x600
      # 缩略图质量 (0.1-1.0)
      quality: 0.85
      # 缩略图格式
      format: jpg
    # 图片压缩配置
    compression:
      enabled: true
      # 压缩质量
      quality: 0.9
      # 最大宽度
      max-width: 2000
      # 最大高度
      max-height: 2000
    # 水印配置
    watermark:
      enabled: false
      text: "CRM System"
      font-size: 20
      font-color: "255,255,255,128"  # RGBA
      position: "bottom-right"  # top-left, top-right, bottom-left, bottom-right, center
      margin: 10

  # 安全配置
  security:
    # 病毒扫描
    virus-scan:
      enabled: true
      # 扫描引擎：clamav, none
      engine: clamav
      # 扫描失败时是否严格模式（拒绝上传）
      strict-mode: false
      # 异步扫描
      async-scan: true
    # 内容检查
    content-check:
      enabled: true
      # 检查文件头
      check-file-header: true
      # 检查脚本内容
      check-script-content: true
    # 文件类型验证
    file-type:
      # 是否严格验证文件类型
      strict-validation: true
      # 黑名单文件扩展名
      blacklist: .exe,.bat,.cmd,.com,.scr,.pif,.msi,.vbs,.js,.jar,.app,.deb,.rpm
    # 访问控制
    access-control:
      # 下载链接有效期（秒）
      download-link-expiration: 3600
      # 是否启用防盗链
      anti-hotlink: true
      # 允许的来源域名
      allowed-origins: localhost,*.yourcompany.com

  # 文件类型特定配置
  file-types:
    avatar:
      max-size: 5242880  # 5MB
      allowed-extensions: .jpg,.jpeg,.png,.webp
      enable-crop: true
      crop-aspect-ratio: 1:1
      enable-compression: true
      compression-quality: 0.85
    document:
      max-size: 52428800  # 50MB
      allowed-extensions: .pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx
      enable-preview: true
      enable-watermark: true
    image:
      max-size: 10485760  # 10MB
      allowed-extensions: .jpg,.jpeg,.png,.gif,.bmp,.webp
      enable-thumbnail: true
      enable-compression: true
      compression-quality: 0.9
    general:
      max-size: 104857600  # 100MB
      allowed-extensions: .txt,.csv,.log,.zip,.rar,.7z

  # 缓存配置
  cache:
    # 缓存类型：redis, caffeine, none
    type: redis
    # 缓存TTL（秒）
    ttl: 3600
    # 热点文件缓存
    hot-files:
      enabled: true
      # 热点文件阈值（访问次数）
      threshold: 10
      # 缓存时间（秒）
      cache-time: 7200

  # 监控配置
  monitoring:
    # 是否启用文件访问监控
    enabled: true
    # 监控指标
    metrics:
      # 上传速率监控
      upload-rate: true
      # 下载速率监控  
      download-rate: true
      # 存储使用率监控
      storage-usage: true
      # 错误率监控
      error-rate: true
    # 告警配置
    alerts:
      # 存储空间使用率告警阈值
      storage-usage-threshold: 80
      # 错误率告警阈值
      error-rate-threshold: 5
      # 大文件上传告警阈值（MB）
      large-file-threshold: 100
```

### 1.2 Spring Boot主配置

```yaml
# application.yml
spring:
  servlet:
    multipart:
      # 启用文件上传
      enabled: true
      # 单个文件最大大小
      max-file-size: 50MB
      # 总文件最大大小
      max-request-size: 100MB
      # 文件写入磁盘的阈值
      file-size-threshold: 2KB
      # 临时文件位置
      location: ${java.io.tmpdir}

  # 静态资源配置
  web:
    resources:
      static-locations: file:${file.upload.base-path}/
      cache:
        period: 3600  # 缓存1小时

# 管理端点配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,file-metrics
  endpoint:
    file-metrics:
      enabled: true
  metrics:
    tags:
      service: file-service
    export:
      prometheus:
        enabled: true

# 定时任务配置
scheduling:
  pool:
    size: 10
  task:
    execution:
      pool:
        core-size: 5
        max-size: 15
        queue-capacity: 100
```

## 2. 存储服务配置

### 2.1 本地存储配置

```yaml
# 本地存储配置
file:
  storage:
    type: local
    local:
      # 存储根目录
      base-path: /var/app/uploads
      # 目录权限
      directory-permissions: 755
      # 文件权限
      file-permissions: 644
      # 是否创建日期子目录
      create-date-directories: true
      # 日期目录格式
      date-directory-format: yyyy/MM/dd
      # 备份配置
      backup:
        enabled: true
        # 备份目录
        backup-path: /var/app/backups
        # 备份策略：daily, weekly, monthly
        strategy: daily
        # 保留备份数量
        retention-count: 30
```

### 2.2 阿里云OSS配置

```yaml
# 阿里云OSS配置
aliyun:
  oss:
    # 地域节点
    endpoint: https://oss-cn-hangzhou.aliyuncs.com
    # 访问密钥
    access-key-id: ${ALIYUN_ACCESS_KEY_ID:}
    access-key-secret: ${ALIYUN_ACCESS_KEY_SECRET:}
    # 存储桶名称
    bucket-name: ${ALIYUN_OSS_BUCKET:crm-files}
    # 基础URL
    base-url: https://${ALIYUN_OSS_BUCKET}.oss-cn-hangzhou.aliyuncs.com
    # 连接配置
    connection:
      # 连接超时时间（毫秒）
      connection-timeout: 50000
      # Socket超时时间（毫秒）
      socket-timeout: 50000
      # 最大连接数
      max-connections: 1024
      # 是否使用Reaper线程
      use-reaper: true
    # 高级配置
    advanced:
      # 是否启用CRC校验
      crc-enabled: true
      # 是否启用MD5校验
      md5-enabled: true
      # 最大重试次数
      max-error-retry: 3
```

### 2.3 AWS S3配置

```yaml
# AWS S3配置
aws:
  s3:
    # 地域
    region: ${AWS_REGION:us-east-1}
    # 访问密钥
    access-key: ${AWS_ACCESS_KEY_ID:}
    secret-key: ${AWS_SECRET_ACCESS_KEY:}
    # 存储桶名称
    bucket-name: ${AWS_S3_BUCKET:crm-files}
    # 基础URL
    base-url: https://s3.${AWS_REGION}.amazonaws.com/${AWS_S3_BUCKET}
    # 传输配置
    transfer:
      # 多部分上传阈值（字节）
      multipart-upload-threshold: 16777216  # 16MB
      # 多部分上传最小部分大小
      minimum-upload-part-size: 5242880    # 5MB
      # 传输管理器线程池大小
      thread-pool-size: 10
    # 客户端配置
    client:
      # 连接超时时间（毫秒）
      connection-timeout: 50000
      # Socket超时时间（毫秒）
      socket-timeout: 50000
      # 最大重试次数
      max-error-retry: 3
```

### 2.4 MinIO配置

```yaml
# MinIO配置
minio:
  # 服务端点
  endpoint: ${MINIO_ENDPOINT:http://localhost:9000}
  # 访问密钥
  access-key: ${MINIO_ACCESS_KEY:minioadmin}
  secret-key: ${MINIO_SECRET_KEY:minioadmin}
  # 存储桶名称
  bucket-name: ${MINIO_BUCKET:crm-files}
  # 基础URL
  base-url: ${MINIO_ENDPOINT}/${MINIO_BUCKET}
  # 连接配置
  connection:
    # HTTP连接超时时间（秒）
    connect-timeout: 10
    # HTTP写超时时间（秒）
    write-timeout: 60
    # HTTP读超时时间（秒）
    read-timeout: 60
  # 是否使用HTTPS
  secure: false
```

## 3. 安全配置

### 3.1 ClamAV病毒扫描配置

```bash
#!/bin/bash
# install_clamav.sh - ClamAV安装脚本

# Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y clamav clamav-daemon clamav-freshclam

# CentOS/RHEL
# sudo yum install -y epel-release
# sudo yum install -y clamav clamav-update clamav-scanner-systemd

# 更新病毒库
sudo freshclam

# 启动ClamAV服务
sudo systemctl enable clamav-daemon
sudo systemctl start clamav-daemon

# 配置ClamAV
sudo tee /etc/clamav/clamd.conf > /dev/null <<EOF
LocalSocket /tmp/clamd.socket
FixStaleSocket true
LocalSocketGroup clamav
LocalSocketMode 666
User clamav
ScanMail true
ScanArchive true
ArchiveBlockEncrypted false
MaxDirectoryRecursion 15
FollowDirectorySymlinks false
FollowFileSymlinks false
ReadTimeout 180
MaxThreads 12
MaxConnectionQueueLength 15
LogSyslog false
LogFile /var/log/clamav/clamav.log
LogTime true
LogFileUnlock false
LogFileMaxSize 0
LogVerbose false
DatabaseDirectory /var/lib/clamav
OfficialDatabaseOnly false
SelfCheck 3600
Foreground false
Debug false
ScanPE true
ScanELF true
ScanOLE2 true
ScanPDF true
ScanSWF true
ScanHTML true
MaxScanSize 100M
MaxFileSize 25M
MaxRecursion 16
MaxFiles 10000
MaxEmbeddedPE 10M
MaxHTMLNormalize 10M
MaxHTMLNoTags 2M
MaxScriptNormalize 5M
MaxZipTypeRcg 1M
EOF

# 重启服务
sudo systemctl restart clamav-daemon
```

### 3.2 Java ClamAV集成配置

```java
// ClamAVConfig.java
@Configuration
@ConditionalOnProperty(name = "file.security.virus-scan.enabled", havingValue = "true")
public class ClamAVConfig {
    
    @Value("${file.security.virus-scan.host:localhost}")
    private String clamavHost;
    
    @Value("${file.security.virus-scan.port:3310}")
    private int clamavPort;
    
    @Value("${file.security.virus-scan.timeout:60000}")
    private int timeout;
    
    @Bean
    public ClamAVClient clamAVClient() {
        return new ClamAVClient(clamavHost, clamavPort, timeout);
    }
}

// ClamAVService.java
@Service
@ConditionalOnBean(ClamAVClient.class)
public class ClamAVService implements VirusScanService {
    
    @Autowired
    private ClamAVClient clamAVClient;
    
    @Override
    public VirusScanResult scanFile(File file) throws VirusScanException {
        try {
            byte[] fileBytes = Files.readAllBytes(file.toPath());
            ScanResult result = clamAVClient.scan(fileBytes);
            
            return VirusScanResult.builder()
                .infected(result.getStatus() == ScanResult.Status.FOUND)
                .virusName(result.getFoundViruses().stream().findFirst().orElse(""))
                .details(result.toString())
                .scanTime(LocalDateTime.now())
                .build();
                
        } catch (Exception e) {
            throw new VirusScanException("病毒扫描失败", e);
        }
    }
    
    @Override
    public VirusScanResult scanFile(MultipartFile file) throws VirusScanException {
        try {
            byte[] fileBytes = file.getBytes();
            ScanResult result = clamAVClient.scan(fileBytes);
            
            return VirusScanResult.builder()
                .infected(result.getStatus() == ScanResult.Status.FOUND)
                .virusName(result.getFoundViruses().stream().findFirst().orElse(""))
                .details(result.toString())
                .scanTime(LocalDateTime.now())
                .build();
                
        } catch (Exception e) {
            throw new VirusScanException("病毒扫描失败", e);
        }
    }
}
```

### 3.3 文件访问控制配置

```java
// FileSecurityConfig.java
@Configuration
public class FileSecurityConfig {
    
    @Bean
    public FileAccessFilter fileAccessFilter() {
        return new FileAccessFilter();
    }
    
    @Bean
    @ConditionalOnProperty(name = "file.security.access-control.anti-hotlink", havingValue = "true")
    public AntiHotlinkFilter antiHotlinkFilter() {
        return new AntiHotlinkFilter();
    }
}

// FileAccessFilter.java
@Component
public class FileAccessFilter implements Filter {
    
    @Value("${file.security.access-control.allowed-origins:}")
    private String allowedOrigins;
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) 
            throws IOException, ServletException {
        
        HttpServletRequest httpRequest = (HttpServletRequest) request;
        HttpServletResponse httpResponse = (HttpServletResponse) response;
        
        // 检查来源
        String origin = httpRequest.getHeader("Origin");
        String referer = httpRequest.getHeader("Referer");
        
        if (isValidOrigin(origin) || isValidReferer(referer)) {
            chain.doFilter(request, response);
        } else {
            httpResponse.setStatus(HttpStatus.FORBIDDEN.value());
            httpResponse.getWriter().write("Access denied");
        }
    }
    
    private boolean isValidOrigin(String origin) {
        if (StringUtils.isEmpty(allowedOrigins) || StringUtils.isEmpty(origin)) {
            return true;
        }
        
        String[] allowed = allowedOrigins.split(",");
        return Arrays.stream(allowed)
                    .anyMatch(domain -> origin.contains(domain.trim()));
    }
    
    private boolean isValidReferer(String referer) {
        // 实现防盗链逻辑
        return true;
    }
}
```

## 4. 性能优化配置

### 4.1 文件上传优化

```yaml
# 文件上传性能优化
file:
  upload:
    # 分块上传配置
    chunked-upload:
      enabled: true
      # 分块大小（字节）
      chunk-size: 2097152  # 2MB
      # 最大并发上传数
      max-concurrent-uploads: 3
      # 分块临时存储路径
      temp-chunk-path: ./temp/chunks
      # 分块过期时间（小时）
      chunk-expiration: 24
    
    # 断点续传配置
    resumable-upload:
      enabled: true
      # 断点信息存储时间（小时）
      resume-info-expiration: 72
      # 最大重试次数
      max-retry-count: 3
    
    # 异步处理配置
    async-processing:
      enabled: true
      # 线程池大小
      thread-pool-size: 10
      # 队列容量
      queue-capacity: 100
      # 处理超时时间（分钟）
      processing-timeout: 30

  # 缓存优化
  cache:
    # 文件元数据缓存
    metadata:
      enabled: true
      # 缓存大小
      max-size: 10000
      # 缓存时间（秒）
      ttl: 3600
    
    # 缩略图缓存
    thumbnail:
      enabled: true
      # 缓存路径
      cache-path: ./cache/thumbnails
      # 缓存大小限制（MB）
      max-cache-size: 1024
      # 缓存清理间隔（小时）
      cleanup-interval: 24

  # 下载优化
  download:
    # 启用分片下载
    range-support: true
    # 下载缓冲区大小（字节）
    buffer-size: 8192
    # 下载限速（字节/秒，0表示不限速）
    rate-limit: 0
```

### 4.2 Nginx配置优化

```nginx
# nginx.conf - 文件服务优化配置
http {
    # 文件上传大小限制
    client_max_body_size 100M;
    
    # 上传超时配置
    client_body_timeout 300;
    client_header_timeout 300;
    
    # 启用sendfile
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    
    # 启用gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;

    # 文件服务upstream
    upstream file_service {
        server localhost:50008;
    }

    server {
        listen 80;
        server_name files.yourcompany.com;

        # 静态文件直接服务
        location /static/ {
            alias /var/app/uploads/;
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header X-Content-Type-Options nosniff;
            add_header X-Frame-Options DENY;
            add_header X-XSS-Protection "1; mode=block";
            
            # 启用缓存
            open_file_cache max=1000 inactive=20s;
            open_file_cache_valid 30s;
            open_file_cache_min_uses 2;
            open_file_cache_errors on;
        }

        # API请求代理到后端
        location /api/files/ {
            proxy_pass http://file_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 上传配置
            proxy_request_buffering off;
            proxy_buffering off;
            proxy_read_timeout 300;
            proxy_connect_timeout 300;
            proxy_send_timeout 300;
        }

        # 缩略图服务
        location /thumbnails/ {
            alias /var/app/uploads/thumbnails/;
            expires 30d;
            add_header Cache-Control "public";
            
            # 缩略图不存在时返回默认图片
            try_files $uri /default-thumbnail.jpg;
        }

        # 防盗链配置
        location ~* \.(jpg|jpeg|png|gif|webp|pdf|doc|docx)$ {
            valid_referers none blocked server_names
                           *.yourcompany.com
                           yourcompany.com;
            if ($invalid_referer) {
                return 403;
            }
            
            alias /var/app/uploads/;
            expires 7d;
            add_header Cache-Control "public";
        }

        # 安全头
        add_header X-Content-Type-Options nosniff;
        add_header X-Frame-Options DENY;
        add_header X-XSS-Protection "1; mode=block";
        add_header Referrer-Policy "strict-origin-when-cross-origin";
    }
}
```

## 5. 监控配置

### 5.1 Prometheus监控配置

```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'file-service'
    static_configs:
      - targets: ['localhost:50008']
    metrics_path: '/actuator/prometheus'
    scrape_interval: 30s
```

### 5.2 Grafana仪表板配置

```json
{
  "dashboard": {
    "title": "文件服务监控",
    "panels": [
      {
        "title": "文件上传速率",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(file_upload_total[5m])",
            "legendFormat": "上传/秒"
          }
        ]
      },
      {
        "title": "文件下载速率", 
        "type": "graph",
        "targets": [
          {
            "expr": "rate(file_download_total[5m])",
            "legendFormat": "下载/秒"
          }
        ]
      },
      {
        "title": "存储使用率",
        "type": "stat",
        "targets": [
          {
            "expr": "file_storage_usage_bytes / file_storage_total_bytes * 100",
            "legendFormat": "使用率%"
          }
        ]
      },
      {
        "title": "错误率",
        "type": "stat",
        "targets": [
          {
            "expr": "rate(file_operation_errors_total[5m]) / rate(file_operation_total[5m]) * 100",
            "legendFormat": "错误率%"
          }
        ]
      }
    ]
  }
}
```

### 5.3 日志配置

```yaml
# logback-spring.xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>
    
    <!-- 文件操作日志 -->
    <appender name="FILE_OPERATION" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/file-operation.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>logs/file-operation.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <maxFileSize>100MB</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <!-- 安全事件日志 -->
    <appender name="SECURITY_EVENT" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/security-event.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>logs/security-event.%d{yyyy-MM-dd}.log</fileNamePattern>
            <maxHistory>90</maxHistory>
        </rollingPolicy>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <!-- Logger配置 -->
    <logger name="com.crm.file" level="INFO" additivity="false">
        <appender-ref ref="FILE_OPERATION"/>
    </logger>
    
    <logger name="com.crm.file.security" level="WARN" additivity="false">
        <appender-ref ref="SECURITY_EVENT"/>
    </logger>
    
    <root level="INFO">
        <appender-ref ref="CONSOLE"/>
    </root>
</configuration>
```

## 6. 部署检查清单

### 6.1 环境准备检查

- [ ] Java 17+ 已安装
- [ ] 存储目录已创建并设置正确权限
- [ ] 临时目录已配置
- [ ] 病毒扫描服务已安装（可选）
- [ ] 监控服务已配置

### 6.2 配置文件检查

- [ ] 文件上传大小限制已配置
- [ ] 存储服务配置正确
- [ ] 安全配置已启用
- [ ] 权限配置已设置
- [ ] 日志配置已优化

### 6.3 功能测试检查

- [ ] 文件上传功能正常
- [ ] 文件下载功能正常
- [ ] 图片处理功能正常
- [ ] 权限控制功能正常
- [ ] 文件删除功能正常

### 6.4 性能测试检查

- [ ] 大文件上传性能正常
- [ ] 并发上传处理正常
- [ ] 下载速度符合要求
- [ ] 内存使用合理
- [ ] 磁盘使用监控正常

### 6.5 安全检查

- [ ] 文件类型验证正常
- [ ] 病毒扫描功能正常
- [ ] 访问权限控制正常
- [ ] 防盗链功能正常
- [ ] 安全日志记录正常

## 7. 故障排查

### 7.1 常见问题

**上传失败**:
```bash
# 检查磁盘空间
df -h

# 检查目录权限
ls -la /var/app/uploads

# 检查Java进程内存
jstat -gc <pid>

# 查看上传日志
tail -f logs/file-operation.log
```

**下载速度慢**:
```bash
# 检查网络带宽
iftop

# 检查磁盘IO
iostat -x 1

# 检查Nginx状态
nginx -t && systemctl status nginx

# 查看缓存命中率
grep "cache" /var/log/nginx/access.log | awk '{print $9}' | sort | uniq -c
```

**病毒扫描问题**:
```bash
# 检查ClamAV状态
systemctl status clamav-daemon

# 更新病毒库
sudo freshclam

# 测试扫描功能
clamscan --infected --remove --recursive /tmp/test/

# 查看扫描日志
tail -f /var/log/clamav/clamav.log
```

通过以上配置，文件管理系统可以提供安全、高效、可靠的文件服务能力。
