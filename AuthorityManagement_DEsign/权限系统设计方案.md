# CRM系统权限系统设计方案

## 概述

本文档详细设计CRM系统的RBAC（Role-Based Access Control）权限系统，包括角色权限矩阵、数据权限隔离规则、权限继承机制和安全控制策略，确保系统的数据安全和功能访问控制。

## 权限体系架构

### 1. 权限模型设计

```
┌─────────────────────────────────────────────────────────────────┐
│                    CRM权限体系架构图                              │
├─────────────────────────────────────────────────────────────────┤
│  用户(User) ←─────→ 角色(Role) ←─────→ 权限(Permission)           │
│       ↓                ↓                    ↓                   │
│  ┌──────────┐    ┌──────────┐        ┌──────────────┐            │
│  │   张明    │    │ 销售经理  │        │ 线索管理权限  │            │
│  │   王芳    │    │ 销售员   │        │ 客户管理权限  │            │
│  │   李强    │    │ 营销专员  │        │ 订单查看权限  │            │
│  └──────────┘    └──────────┘        └──────────────┘            │
│       ↓                ↓                    ↓                   │
│  ┌──────────┐    ┌──────────┐        ┌──────────────┐            │
│  │ 部门数据  │    │ 角色范围  │        │ 操作级别权限  │            │
│  │ 权限隔离  │    │ 权限继承  │        │ 资源访问控制  │            │
│  └──────────┘    └──────────┘        └──────────────┘            │
└─────────────────────────────────────────────────────────────────┘
```

### 2. 权限分层结构

#### 2.1 功能权限层
- **模块权限**: 控制对特定功能模块的访问（如销售管理、营销管理）
- **操作权限**: 控制具体操作类型（查看、创建、编辑、删除）
- **字段权限**: 控制敏感字段的访问（如客户手机号脱敏）

#### 2.2 数据权限层
- **部门数据权限**: 基于部门层级的数据隔离
- **个人数据权限**: 用户只能访问自己负责的数据
- **跨部门数据权限**: 特殊角色可访问多部门数据

#### 2.3 业务权限层
- **工作流权限**: 控制业务流程中的操作权限
- **审批权限**: 控制审批流程的权限
- **导出权限**: 控制数据导出功能的权限

## 角色权限矩阵

### 1. 系统预设角色

#### 1.1 系统管理员 (System Administrator)
**权限范围**: 全系统权限
**数据权限**: 所有部门数据
**核心职责**: 系统配置、用户管理、数据维护

```json
{
  "role_id": 1,
  "role_name": "系统管理员",
  "permissions": {
    "dashboard": {
      "view": true,
      "export": true,
      "configure": true
    },
    "sales": {
      "leads": {
        "view": true,
        "create": true,
        "edit": true,
        "delete": true,
        "assign": true,
        "convert": true,
        "export": true,
        "import": true
      },
      "customers": {
        "view": true,
        "create": true,
        "edit": true,
        "delete": true,
        "merge": true,
        "export": true,
        "import": true
      },
      "orders": {
        "view": true,
        "create": true,
        "edit": true,
        "delete": true,
        "approve": true,
        "export": true,
        "financial": true
      }
    },
    "marketing": {
      "campaigns": {
        "view": true,
        "create": true,
        "edit": true,
        "delete": true,
        "approve": true,
        "budget": true,
        "export": true
      }
    },
    "system": {
      "users": {
        "view": true,
        "create": true,
        "edit": true,
        "delete": true,
        "reset_password": true,
        "manage_status": true
      },
      "roles": {
        "view": true,
        "create": true,
        "edit": true,
        "delete": true,
        "assign": true
      },
      "departments": {
        "view": true,
        "create": true,
        "edit": true,
        "delete": true
      }
    },
    "analytics": {
      "predict": true,
      "recommend": true,
      "report": true,
      "risk": true,
      "sentiment": true,
      "chat": true
    },
    "files": {
      "upload": true,
      "download": true,
      "delete": true,
      "manage": true
    }
  },
  "data_scope": "all_departments",
  "field_permissions": {
    "sensitive_data": true,
    "financial_data": true,
    "personal_data": true
  }
}
```

#### 1.2 销售经理 (Sales Manager)
**权限范围**: 销售模块管理权限
**数据权限**: 本部门及下级部门数据
**核心职责**: 销售团队管理、业绩监控、客户分配

```json
{
  "role_id": 2,
  "role_name": "销售经理",
  "permissions": {
    "dashboard": {
      "view": true,
      "export": true,
      "configure": false
    },
    "sales": {
      "leads": {
        "view": true,
        "create": true,
        "edit": true,
        "delete": true,
        "assign": true,
        "convert": true,
        "export": true,
        "import": false
      },
      "customers": {
        "view": true,
        "create": true,
        "edit": true,
        "delete": true,
        "merge": false,
        "export": true,
        "import": false
      },
      "orders": {
        "view": true,
        "create": true,
        "edit": true,
        "delete": false,
        "approve": true,
        "export": true,
        "financial": false
      }
    },
    "marketing": {
      "campaigns": {
        "view": true,
        "create": false,
        "edit": false,
        "delete": false,
        "approve": false,
        "budget": false,
        "export": true
      }
    },
    "system": {
      "users": {
        "view": true,
        "create": false,
        "edit": false,
        "delete": false,
        "reset_password": false,
        "manage_status": false
      },
      "roles": {
        "view": true,
        "create": false,
        "edit": false,
        "delete": false,
        "assign": false
      },
      "departments": {
        "view": true,
        "create": false,
        "edit": false,
        "delete": false
      }
    },
    "analytics": {
      "predict": true,
      "recommend": true,
      "report": true,
      "risk": true,
      "sentiment": true,
      "chat": true
    },
    "files": {
      "upload": true,
      "download": true,
      "delete": false,
      "manage": false
    }
  },
  "data_scope": "department_and_sub",
  "field_permissions": {
    "sensitive_data": true,
    "financial_data": false,
    "personal_data": true
  }
}
```

#### 1.3 销售员 (Sales Representative)
**权限范围**: 基础销售操作权限
**数据权限**: 个人负责的数据
**核心职责**: 线索跟进、客户维护、订单管理

```json
{
  "role_id": 3,
  "role_name": "销售员",
  "permissions": {
    "dashboard": {
      "view": true,
      "export": false,
      "configure": false
    },
    "sales": {
      "leads": {
        "view": true,
        "create": true,
        "edit": true,
        "delete": false,
        "assign": false,
        "convert": true,
        "export": false,
        "import": false
      },
      "customers": {
        "view": true,
        "create": true,
        "edit": true,
        "delete": false,
        "merge": false,
        "export": false,
        "import": false
      },
      "orders": {
        "view": true,
        "create": true,
        "edit": true,
        "delete": false,
        "approve": false,
        "export": false,
        "financial": false
      }
    },
    "marketing": {
      "campaigns": {
        "view": true,
        "create": false,
        "edit": false,
        "delete": false,
        "approve": false,
        "budget": false,
        "export": false
      }
    },
    "system": {
      "users": {
        "view": false,
        "create": false,
        "edit": false,
        "delete": false,
        "reset_password": false,
        "manage_status": false
      },
      "roles": {
        "view": false,
        "create": false,
        "edit": false,
        "delete": false,
        "assign": false
      },
      "departments": {
        "view": false,
        "create": false,
        "edit": false,
        "delete": false
      }
    },
    "analytics": {
      "predict": false,
      "recommend": true,
      "report": false,
      "risk": false,
      "sentiment": false,
      "chat": true
    },
    "files": {
      "upload": true,
      "download": true,
      "delete": false,
      "manage": false
    }
  },
  "data_scope": "own_data",
  "field_permissions": {
    "sensitive_data": false,
    "financial_data": false,
    "personal_data": true
  }
}
```

#### 1.4 营销经理 (Marketing Manager)
**权限范围**: 营销模块管理权限
**数据权限**: 营销部门数据
**核心职责**: 营销策略制定、活动管理、ROI分析

```json
{
  "role_id": 4,
  "role_name": "营销经理",
  "permissions": {
    "dashboard": {
      "view": true,
      "export": true,
      "configure": false
    },
    "sales": {
      "leads": {
        "view": true,
        "create": false,
        "edit": false,
        "delete": false,
        "assign": false,
        "convert": false,
        "export": true,
        "import": false
      },
      "customers": {
        "view": true,
        "create": false,
        "edit": false,
        "delete": false,
        "merge": false,
        "export": true,
        "import": false
      },
      "orders": {
        "view": true,
        "create": false,
        "edit": false,
        "delete": false,
        "approve": false,
        "export": true,
        "financial": false
      }
    },
    "marketing": {
      "campaigns": {
        "view": true,
        "create": true,
        "edit": true,
        "delete": true,
        "approve": true,
        "budget": true,
        "export": true
      }
    },
    "system": {
      "users": {
        "view": true,
        "create": false,
        "edit": false,
        "delete": false,
        "reset_password": false,
        "manage_status": false
      },
      "roles": {
        "view": false,
        "create": false,
        "edit": false,
        "delete": false,
        "assign": false
      },
      "departments": {
        "view": true,
        "create": false,
        "edit": false,
        "delete": false
      }
    },
    "analytics": {
      "predict": true,
      "recommend": true,
      "report": true,
      "risk": true,
      "sentiment": true,
      "chat": true
    },
    "files": {
      "upload": true,
      "download": true,
      "delete": true,
      "manage": false
    }
  },
  "data_scope": "department_only",
  "field_permissions": {
    "sensitive_data": true,
    "financial_data": true,
    "personal_data": true
  }
}
```

#### 1.5 营销专员 (Marketing Specialist)
**权限范围**: 基础营销操作权限
**数据权限**: 个人负责的营销数据
**核心职责**: 活动执行、数据收集、渠道管理

```json
{
  "role_id": 5,
  "role_name": "营销专员",
  "permissions": {
    "dashboard": {
      "view": true,
      "export": false,
      "configure": false
    },
    "sales": {
      "leads": {
        "view": true,
        "create": false,
        "edit": false,
        "delete": false,
        "assign": false,
        "convert": false,
        "export": false,
        "import": false
      },
      "customers": {
        "view": true,
        "create": false,
        "edit": false,
        "delete": false,
        "merge": false,
        "export": false,
        "import": false
      },
      "orders": {
        "view": false,
        "create": false,
        "edit": false,
        "delete": false,
        "approve": false,
        "export": false,
        "financial": false
      }
    },
    "marketing": {
      "campaigns": {
        "view": true,
        "create": true,
        "edit": true,
        "delete": false,
        "approve": false,
        "budget": false,
        "export": true
      }
    },
    "system": {
      "users": {
        "view": false,
        "create": false,
        "edit": false,
        "delete": false,
        "reset_password": false,
        "manage_status": false
      },
      "roles": {
        "view": false,
        "create": false,
        "edit": false,
        "delete": false,
        "assign": false
      },
      "departments": {
        "view": false,
        "create": false,
        "edit": false,
        "delete": false
      }
    },
    "analytics": {
      "predict": false,
      "recommend": false,
      "report": false,
      "risk": false,
      "sentiment": false,
      "chat": true
    },
    "files": {
      "upload": true,
      "download": true,
      "delete": false,
      "manage": false
    }
  },
  "data_scope": "own_data",
  "field_permissions": {
    "sensitive_data": false,
    "financial_data": false,
    "personal_data": false
  }
}
```

#### 1.6 客服专员 (Customer Service)
**权限范围**: 客户服务权限
**数据权限**: 客户服务相关数据
**核心职责**: 客户咨询、售后服务、问题处理

```json
{
  "role_id": 6,
  "role_name": "客服专员",
  "permissions": {
    "dashboard": {
      "view": true,
      "export": false,
      "configure": false
    },
    "sales": {
      "leads": {
        "view": true,
        "create": true,
        "edit": true,
        "delete": false,
        "assign": false,
        "convert": false,
        "export": false,
        "import": false
      },
      "customers": {
        "view": true,
        "create": false,
        "edit": true,
        "delete": false,
        "merge": false,
        "export": false,
        "import": false
      },
      "orders": {
        "view": true,
        "create": false,
        "edit": true,
        "delete": false,
        "approve": false,
        "export": false,
        "financial": false
      }
    },
    "marketing": {
      "campaigns": {
        "view": true,
        "create": false,
        "edit": false,
        "delete": false,
        "approve": false,
        "budget": false,
        "export": false
      }
    },
    "system": {
      "users": {
        "view": false,
        "create": false,
        "edit": false,
        "delete": false,
        "reset_password": false,
        "manage_status": false
      },
      "roles": {
        "view": false,
        "create": false,
        "edit": false,
        "delete": false,
        "assign": false
      },
      "departments": {
        "view": false,
        "create": false,
        "edit": false,
        "delete": false
      }
    },
    "analytics": {
      "predict": false,
      "recommend": false,
      "report": false,
      "risk": false,
      "sentiment": true,
      "chat": true
    },
    "files": {
      "upload": true,
      "download": true,
      "delete": false,
      "manage": false
    }
  },
  "data_scope": "department_only",
  "field_permissions": {
    "sensitive_data": false,
    "financial_data": false,
    "personal_data": true
  }
}
```

### 2. 权限模板系统

#### 2.1 预设权限模板

**销售类模板**:
```json
{
  "template_id": "sales_template",
  "template_name": "销售类权限模板",
  "description": "适用于销售相关角色的权限模板",
  "permissions": {
    "dashboard": {"view": true},
    "sales": {
      "leads": {"view": true, "create": true, "edit": true},
      "customers": {"view": true, "create": true, "edit": true},
      "orders": {"view": true, "create": true, "edit": true}
    },
    "analytics": {"chat": true, "recommend": true}
  }
}
```

**营销类模板**:
```json
{
  "template_id": "marketing_template",
  "template_name": "营销类权限模板",
  "description": "适用于营销相关角色的权限模板",
  "permissions": {
    "dashboard": {"view": true},
    "marketing": {
      "campaigns": {"view": true, "create": true, "edit": true}
    },
    "sales": {
      "leads": {"view": true},
      "customers": {"view": true}
    },
    "analytics": {"chat": true, "predict": true, "report": true}
  }
}
```

**管理类模板**:
```json
{
  "template_id": "manager_template",
  "template_name": "管理类权限模板",
  "description": "适用于管理岗位的权限模板",
  "permissions": {
    "dashboard": {"view": true, "export": true},
    "sales": {"all": true},
    "marketing": {"all": true},
    "analytics": {"all": true},
    "system": {"users": {"view": true}}
  }
}
```

## 数据权限隔离规则

### 1. 数据范围控制

#### 1.1 数据范围类型
```java
public enum DataScope {
    ALL_DEPARTMENTS("all_departments", "全部数据权限"),
    DEPARTMENT_AND_SUB("department_and_sub", "本部门及下级部门数据"),
    DEPARTMENT_ONLY("department_only", "仅本部门数据"),
    OWN_DATA("own_data", "仅个人数据"),
    CUSTOM("custom", "自定义数据权限");
    
    private final String code;
    private final String description;
}
```

#### 1.2 SQL数据过滤规则

**全部数据权限 (ALL_DEPARTMENTS)**:
```sql
-- 无需添加任何过滤条件
SELECT * FROM leads WHERE status = 1;
```

**本部门及下级部门数据 (DEPARTMENT_AND_SUB)**:
```sql
-- 递归查询部门层级
WITH RECURSIVE dept_tree AS (
    SELECT id, name, parent_id FROM departments WHERE id = #{userDepartmentId}
    UNION ALL
    SELECT d.id, d.name, d.parent_id 
    FROM departments d 
    JOIN dept_tree dt ON d.parent_id = dt.id
)
SELECT l.* FROM leads l 
JOIN users u ON l.assigned_user_id = u.id 
WHERE u.department_id IN (SELECT id FROM dept_tree) 
AND l.status = 1;
```

**仅本部门数据 (DEPARTMENT_ONLY)**:
```sql
-- 限制在当前用户所属部门
SELECT l.* FROM leads l 
JOIN users u ON l.assigned_user_id = u.id 
WHERE u.department_id = #{userDepartmentId} 
AND l.status = 1;
```

**仅个人数据 (OWN_DATA)**:
```sql
-- 只能查看分配给自己的数据
SELECT * FROM leads 
WHERE assigned_user_id = #{currentUserId} 
AND status = 1;
```

### 2. 字段级权限控制

#### 2.1 敏感字段脱敏规则
```java
public class FieldPermissionHandler {
    
    // 手机号脱敏
    public String maskPhone(String phone, boolean hasPermission) {
        if (hasPermission || StringUtils.isEmpty(phone)) {
            return phone;
        }
        return phone.replaceAll("(\\d{3})\\d{4}(\\d{4})", "$1****$2");
    }
    
    // 身份证脱敏
    public String maskIdCard(String idCard, boolean hasPermission) {
        if (hasPermission || StringUtils.isEmpty(idCard)) {
            return idCard;
        }
        return idCard.replaceAll("(\\d{6})\\d{8}(\\d{4})", "$1********$2");
    }
    
    // 金额脱敏
    public String maskAmount(BigDecimal amount, boolean hasPermission) {
        if (hasPermission || amount == null) {
            return amount != null ? amount.toString() : null;
        }
        return "***";
    }
}
```

#### 2.2 字段权限配置
```json
{
  "field_permissions": {
    "leads": {
      "phone": "sensitive_data",
      "email": "personal_data",
      "id_card": "sensitive_data"
    },
    "customers": {
      "phone": "sensitive_data",
      "email": "personal_data",
      "address": "personal_data",
      "id_card": "sensitive_data"
    },
    "orders": {
      "total_amount": "financial_data",
      "paid_amount": "financial_data",
      "unpaid_amount": "financial_data"
    }
  }
}
```

### 3. 动态权限查询

#### 3.1 MyBatis数据权限拦截器
```java
@Component
@Intercepts({@Signature(type = Executor.class, method = "query", args = {MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class})})
public class DataPermissionInterceptor implements Interceptor {
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        Object[] args = invocation.getArgs();
        MappedStatement ms = (MappedStatement) args[0];
        Object parameter = args[1];
        
        // 获取当前用户权限信息
        UserPermissionContext context = SecurityContextHolder.getContext();
        if (context == null || context.getDataScope() == DataScope.ALL_DEPARTMENTS) {
            return invocation.proceed();
        }
        
        // 构建动态SQL条件
        BoundSql boundSql = ms.getBoundSql(parameter);
        String originalSql = boundSql.getSql();
        String modifiedSql = buildDataPermissionSql(originalSql, context);
        
        // 重新构建MappedStatement
        MappedStatement newMs = buildNewMappedStatement(ms, modifiedSql);
        args[0] = newMs;
        
        return invocation.proceed();
    }
    
    private String buildDataPermissionSql(String originalSql, UserPermissionContext context) {
        switch (context.getDataScope()) {
            case DEPARTMENT_AND_SUB:
                return addDepartmentAndSubCondition(originalSql, context.getDepartmentId());
            case DEPARTMENT_ONLY:
                return addDepartmentOnlyCondition(originalSql, context.getDepartmentId());
            case OWN_DATA:
                return addOwnDataCondition(originalSql, context.getUserId());
            default:
                return originalSql;
        }
    }
}
```

## 权限验证机制

### 1. 接口权限验证

#### 1.1 注解式权限控制
```java
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface RequiresPermission {
    String[] value() default {};
    Logical logical() default Logical.AND;
}

@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface RequiresDataScope {
    DataScope[] value() default {};
    String entityIdParam() default "id";
}
```

#### 1.2 权限验证拦截器
```java
@Component
public class PermissionInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        if (!(handler instanceof HandlerMethod)) {
            return true;
        }
        
        HandlerMethod handlerMethod = (HandlerMethod) handler;
        
        // 检查方法级权限注解
        RequiresPermission methodPermission = handlerMethod.getMethodAnnotation(RequiresPermission.class);
        if (methodPermission != null) {
            checkPermission(methodPermission);
        }
        
        // 检查类级权限注解
        RequiresPermission classPermission = handlerMethod.getBeanType().getAnnotation(RequiresPermission.class);
        if (classPermission != null) {
            checkPermission(classPermission);
        }
        
        // 检查数据权限注解
        RequiresDataScope dataScope = handlerMethod.getMethodAnnotation(RequiresDataScope.class);
        if (dataScope != null) {
            checkDataScope(dataScope, request);
        }
        
        return true;
    }
    
    private void checkPermission(RequiresPermission permission) {
        UserPermissionContext context = SecurityContextHolder.getContext();
        String[] permissions = permission.value();
        Logical logical = permission.logical();
        
        if (logical == Logical.AND) {
            for (String perm : permissions) {
                if (!context.hasPermission(perm)) {
                    throw new AccessDeniedException("权限不足: " + perm);
                }
            }
        } else {
            boolean hasAnyPermission = false;
            for (String perm : permissions) {
                if (context.hasPermission(perm)) {
                    hasAnyPermission = true;
                    break;
                }
            }
            if (!hasAnyPermission) {
                throw new AccessDeniedException("权限不足: " + String.join(" OR ", permissions));
            }
        }
    }
}
```

### 2. 前端权限控制

#### 2.1 React权限组件
```jsx
// PermissionWrapper.jsx
import { usePermission } from '@/hooks/usePermission';

const PermissionWrapper = ({ 
  permission, 
  dataScope, 
  fallback = null, 
  children 
}) => {
  const { hasPermission, hasDataScope } = usePermission();
  
  // 检查功能权限
  if (permission && !hasPermission(permission)) {
    return fallback;
  }
  
  // 检查数据权限
  if (dataScope && !hasDataScope(dataScope)) {
    return fallback;
  }
  
  return children;
};

// 使用示例
<PermissionWrapper permission="sales:leads:create">
  <Button type="primary">新增线索</Button>
</PermissionWrapper>

<PermissionWrapper 
  permission="sales:leads:delete" 
  fallback={<span>无权限</span>}
>
  <Button danger>删除</Button>
</PermissionWrapper>
```

#### 2.2 路由权限控制
```jsx
// ProtectedRoute.jsx
import { Navigate } from 'react-router-dom';
import { usePermission } from '@/hooks/usePermission';

const ProtectedRoute = ({ 
  permission, 
  dataScope, 
  children 
}) => {
  const { hasPermission, hasDataScope, loading } = usePermission();
  
  if (loading) {
    return <div>Loading...</div>;
  }
  
  if (permission && !hasPermission(permission)) {
    return <Navigate to="/403" replace />;
  }
  
  if (dataScope && !hasDataScope(dataScope)) {
    return <Navigate to="/403" replace />;
  }
  
  return children;
};

// 路由配置
const routes = [
  {
    path: "/sales/leads",
    element: (
      <ProtectedRoute permission="sales:leads:view">
        <LeadsPage />
      </ProtectedRoute>
    )
  },
  {
    path: "/system/users",
    element: (
      <ProtectedRoute permission="system:users:view">
        <UsersPage />
      </ProtectedRoute>
    )
  }
];
```

### 3. API权限验证示例

#### 3.1 Controller层权限控制
```java
@RestController
@RequestMapping("/api/sales/leads")
@RequiresPermission("sales:leads")
public class LeadsController {
    
    @GetMapping
    @RequiresPermission("sales:leads:view")
    @RequiresDataScope(DataScope.DEPARTMENT_AND_SUB)
    public PageResult<Lead> getLeads(@RequestParam Map<String, Object> params) {
        return leadService.getLeads(params);
    }
    
    @PostMapping
    @RequiresPermission("sales:leads:create")
    public Result<Lead> createLead(@RequestBody CreateLeadRequest request) {
        return leadService.createLead(request);
    }
    
    @PutMapping("/{id}")
    @RequiresPermission("sales:leads:edit")
    @RequiresDataScope(value = DataScope.OWN_DATA, entityIdParam = "id")
    public Result<Lead> updateLead(@PathVariable Long id, @RequestBody UpdateLeadRequest request) {
        return leadService.updateLead(id, request);
    }
    
    @DeleteMapping("/{id}")
    @RequiresPermission("sales:leads:delete")
    @RequiresDataScope(value = DataScope.DEPARTMENT_AND_SUB, entityIdParam = "id")
    public Result<Void> deleteLead(@PathVariable Long id) {
        return leadService.deleteLead(id);
    }
    
    @PostMapping("/batch-assign")
    @RequiresPermission("sales:leads:assign")
    public Result<Void> batchAssignLeads(@RequestBody BatchAssignRequest request) {
        return leadService.batchAssignLeads(request);
    }
}
```

## 权限管理功能

### 1. 角色权限配置

#### 1.1 角色权限设置API
```java
@RestController
@RequestMapping("/api/system/roles")
@RequiresPermission("system:roles")
public class RolePermissionController {
    
    @PutMapping("/{id}/permissions")
    @RequiresPermission("system:roles:edit")
    public Result<Void> updateRolePermissions(
        @PathVariable Long id, 
        @RequestBody RolePermissionUpdateRequest request
    ) {
        roleService.updatePermissions(id, request.getPermissions());
        
        // 刷新在线用户权限缓存
        userPermissionService.refreshUserPermissions(id);
        
        return Result.success();
    }
    
    @PostMapping("/{id}/copy-permissions")
    @RequiresPermission("system:roles:create")
    public Result<Void> copyPermissions(
        @PathVariable Long id, 
        @RequestBody CopyPermissionRequest request
    ) {
        roleService.copyPermissions(id, request.getSourceRoleId());
        return Result.success();
    }
    
    @GetMapping("/permission-templates")
    @RequiresPermission("system:roles:view")
    public Result<List<PermissionTemplate>> getPermissionTemplates() {
        return Result.success(roleService.getPermissionTemplates());
    }
}
```

#### 1.2 权限验证服务
```java
@Service
public class PermissionService {
    
    public boolean hasPermission(Long userId, String permission) {
        UserPermissionContext context = getUserPermissionContext(userId);
        return context.hasPermission(permission);
    }
    
    public boolean hasDataScope(Long userId, DataScope dataScope, Long entityId) {
        UserPermissionContext context = getUserPermissionContext(userId);
        
        switch (context.getDataScope()) {
            case ALL_DEPARTMENTS:
                return true;
            case DEPARTMENT_AND_SUB:
                return isEntityInDepartmentTree(entityId, context.getDepartmentId());
            case DEPARTMENT_ONLY:
                return isEntityInDepartment(entityId, context.getDepartmentId());
            case OWN_DATA:
                return isEntityOwnedByUser(entityId, userId);
            default:
                return false;
        }
    }
    
    public UserPermissionContext getUserPermissionContext(Long userId) {
        // 先从缓存获取
        String cacheKey = "user_permission:" + userId;
        UserPermissionContext context = redisTemplate.opsForValue().get(cacheKey);
        
        if (context == null) {
            // 从数据库加载
            context = loadUserPermissionFromDatabase(userId);
            // 缓存30分钟
            redisTemplate.opsForValue().set(cacheKey, context, Duration.ofMinutes(30));
        }
        
        return context;
    }
    
    private UserPermissionContext loadUserPermissionFromDatabase(Long userId) {
        User user = userMapper.selectById(userId);
        Role role = roleMapper.selectById(user.getRoleId());
        Department department = departmentMapper.selectById(user.getDepartmentId());
        
        return UserPermissionContext.builder()
            .userId(userId)
            .roleId(role.getId())
            .departmentId(department.getId())
            .permissions(JSON.parseObject(role.getPermissions(), Map.class))
            .dataScope(DataScope.valueOf(role.getDataScope()))
            .build();
    }
}
```

### 2. 权限审计日志

#### 2.1 权限变更记录
```java
@Entity
@Table(name = "permission_audit_logs")
public class PermissionAuditLog {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private Long userId;            // 操作用户ID
    private Long targetUserId;      // 目标用户ID
    private Long targetRoleId;      // 目标角色ID
    private String operationType;   // 操作类型：CREATE, UPDATE, DELETE
    private String oldPermissions;  // 旧权限配置
    private String newPermissions;  // 新权限配置
    private String reason;          // 操作原因
    private String ipAddress;       // 操作IP
    private String userAgent;       // 用户代理
    private LocalDateTime createdAt;
}
```

#### 2.2 权限使用统计
```java
@Service
public class PermissionStatisticsService {
    
    @Async
    public void recordPermissionUsage(Long userId, String permission, String resource) {
        PermissionUsageRecord record = PermissionUsageRecord.builder()
            .userId(userId)
            .permission(permission)
            .resource(resource)
            .accessTime(LocalDateTime.now())
            .build();
        
        permissionUsageMapper.insert(record);
        
        // 更新Redis统计数据
        String cacheKey = "permission_usage:" + userId + ":" + permission;
        redisTemplate.opsForValue().increment(cacheKey);
    }
    
    public Map<String, Long> getPermissionUsageStats(Long roleId) {
        List<PermissionUsageRecord> records = permissionUsageMapper.selectByRoleId(roleId);
        
        return records.stream()
            .collect(Collectors.groupingBy(
                PermissionUsageRecord::getPermission,
                Collectors.counting()
            ));
    }
}
```

## 安全控制策略

### 1. 会话管理

#### 1.1 JWT Token安全配置
```java
@Configuration
public class JwtSecurityConfig {
    
    // Token有效期：24小时
    private static final long JWT_EXPIRATION = 24 * 60 * 60 * 1000L;
    
    // 刷新Token有效期：7天
    private static final long REFRESH_TOKEN_EXPIRATION = 7 * 24 * 60 * 60 * 1000L;
    
    public String generateToken(UserPermissionContext context) {
        Date expiration = new Date(System.currentTimeMillis() + JWT_EXPIRATION);
        
        Map<String, Object> claims = new HashMap<>();
        claims.put("userId", context.getUserId());
        claims.put("roleId", context.getRoleId());
        claims.put("departmentId", context.getDepartmentId());
        claims.put("dataScope", context.getDataScope().getCode());
        claims.put("permissions", context.getPermissions());
        
        return Jwts.builder()
            .setClaims(claims)
            .setSubject(context.getUserId().toString())
            .setIssuedAt(new Date())
            .setExpiration(expiration)
            .signWith(SignatureAlgorithm.HS256, jwtSecret)
            .compact();
    }
}
```

#### 1.2 会话并发控制
```java
@Service
public class SessionManager {
    
    // 同一用户最大并发会话数
    private static final int MAX_CONCURRENT_SESSIONS = 3;
    
    public void validateConcurrentSessions(Long userId, String sessionId) {
        String pattern = "user_session:" + userId + ":*";
        Set<String> sessions = redisTemplate.keys(pattern);
        
        if (sessions.size() >= MAX_CONCURRENT_SESSIONS) {
            // 踢掉最早的会话
            String oldestSession = findOldestSession(sessions);
            redisTemplate.delete(oldestSession);
            
            // 通知被踢掉的会话
            webSocketService.notifySessionExpired(oldestSession);
        }
        
        // 记录新会话
        String sessionKey = "user_session:" + userId + ":" + sessionId;
        SessionInfo sessionInfo = SessionInfo.builder()
            .userId(userId)
            .sessionId(sessionId)
            .loginTime(LocalDateTime.now())
            .lastActiveTime(LocalDateTime.now())
            .build();
        
        redisTemplate.opsForValue().set(sessionKey, sessionInfo, Duration.ofDays(7));
    }
}
```

### 2. 权限缓存策略

#### 2.1 多级缓存架构
```java
@Service
public class PermissionCacheService {
    
    // L1缓存：Caffeine本地缓存（5分钟）
    private final Cache<String, UserPermissionContext> localCache = Caffeine.newBuilder()
        .maximumSize(1000)
        .expireAfterWrite(Duration.ofMinutes(5))
        .build();
    
    // L2缓存：Redis分布式缓存（30分钟）
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    public UserPermissionContext getPermissionContext(Long userId) {
        String cacheKey = "permission:" + userId;
        
        // 先查本地缓存
        UserPermissionContext context = localCache.getIfPresent(cacheKey);
        if (context != null) {
            return context;
        }
        
        // 再查Redis缓存
        context = (UserPermissionContext) redisTemplate.opsForValue().get(cacheKey);
        if (context != null) {
            localCache.put(cacheKey, context);
            return context;
        }
        
        // 最后查数据库
        context = loadFromDatabase(userId);
        
        // 更新缓存
        redisTemplate.opsForValue().set(cacheKey, context, Duration.ofMinutes(30));
        localCache.put(cacheKey, context);
        
        return context;
    }
    
    public void evictPermissionCache(Long userId) {
        String cacheKey = "permission:" + userId;
        localCache.invalidate(cacheKey);
        redisTemplate.delete(cacheKey);
    }
    
    public void evictRolePermissionCache(Long roleId) {
        // 查找所有使用该角色的用户
        List<Long> userIds = userMapper.selectUserIdsByRoleId(roleId);
        
        for (Long userId : userIds) {
            evictPermissionCache(userId);
        }
    }
}
```

### 3. 权限变更通知

#### 3.1 实时权限更新
```java
@Component
public class PermissionChangeNotifier {
    
    @EventListener
    @Async
    public void handleRolePermissionChange(RolePermissionChangeEvent event) {
        Long roleId = event.getRoleId();
        
        // 清除相关用户的权限缓存
        permissionCacheService.evictRolePermissionCache(roleId);
        
        // 获取所有使用该角色的在线用户
        List<Long> onlineUserIds = sessionManager.getOnlineUsersByRole(roleId);
        
        for (Long userId : onlineUserIds) {
            // 发送WebSocket通知
            PermissionUpdateMessage message = PermissionUpdateMessage.builder()
                .type("PERMISSION_UPDATE")
                .userId(userId)
                .message("您的权限已更新，请重新登录以获取最新权限")
                .timestamp(LocalDateTime.now())
                .build();
            
            webSocketService.sendToUser(userId, message);
        }
    }
    
    @EventListener
    @Async
    public void handleUserRoleChange(UserRoleChangeEvent event) {
        Long userId = event.getUserId();
        
        // 清除用户权限缓存
        permissionCacheService.evictPermissionCache(userId);
        
        // 强制用户重新登录
        sessionManager.invalidateUserSessions(userId);
        
        // 记录权限变更日志
        PermissionAuditLog auditLog = PermissionAuditLog.builder()
            .userId(event.getOperatorId())
            .targetUserId(userId)
            .operationType("ROLE_CHANGE")
            .oldPermissions(event.getOldRoleId().toString())
            .newPermissions(event.getNewRoleId().toString())
            .reason(event.getReason())
            .createdAt(LocalDateTime.now())
            .build();
        
        auditLogService.saveAuditLog(auditLog);
    }
}
```

## 总结

权限系统设计方案涵盖了以下核心要点：

### 设计特色
- **RBAC权限模型**: 基于角色的访问控制，支持精细化权限管理
- **多层权限控制**: 功能权限、数据权限、字段权限三层控制
- **动态权限验证**: 注解式权限控制 + 拦截器验证
- **数据权限隔离**: 基于部门层级的数据访问控制
- **权限模板系统**: 预设权限模板，支持快速角色配置

### 安全保障
- **会话管理**: JWT Token + 并发会话控制
- **权限缓存**: 多级缓存架构，提升性能
- **审计日志**: 完整的权限变更记录
- **实时更新**: WebSocket实时权限变更通知
- **字段脱敏**: 敏感数据的安全展示

### 开发支持
- **前后端统一**: React权限组件 + Java权限注解
- **动态配置**: JSON格式权限配置，支持灵活扩展
- **批量管理**: 支持批量权限配置和用户管理
- **权限复制**: 支持角色权限复制和模板应用

该权限系统为CRM提供了完整的安全控制机制，确保数据安全和功能访问的精确控制。
