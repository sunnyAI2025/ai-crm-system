# CRM权限系统部署配置指南

## 概述

本文档详细说明如何配置和部署CRM系统的权限模块，包括数据库配置、Spring Security配置、JWT配置、权限缓存配置和前端权限集成。

## 1. 数据库权限表配置

### 1.1 权限相关表结构

```sql
-- 权限审计日志表
CREATE TABLE permission_audit_logs (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL COMMENT '操作用户ID',
    target_id BIGINT COMMENT '目标对象ID（用户ID或角色ID）',
    operation_type VARCHAR(50) NOT NULL COMMENT '操作类型',
    permission VARCHAR(200) COMMENT '权限字符串',
    resource VARCHAR(200) COMMENT '访问资源',
    old_value TEXT COMMENT '旧值',
    new_value TEXT COMMENT '新值',
    status VARCHAR(20) DEFAULT 'SUCCESS' COMMENT '操作状态',
    ip_address VARCHAR(50) COMMENT 'IP地址',
    user_agent TEXT COMMENT '用户代理',
    remark TEXT COMMENT '备注',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间'
);

-- 权限使用统计表
CREATE TABLE permission_usage_stats (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL COMMENT '用户ID',
    permission VARCHAR(200) NOT NULL COMMENT '权限字符串',
    resource VARCHAR(200) COMMENT '访问资源',
    access_count INT DEFAULT 1 COMMENT '访问次数',
    last_access_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '最后访问时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间'
);

-- 会话管理表
CREATE TABLE user_sessions (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL COMMENT '用户ID',
    session_id VARCHAR(100) NOT NULL COMMENT '会话ID',
    token_hash VARCHAR(200) NOT NULL COMMENT 'Token哈希值',
    ip_address VARCHAR(50) COMMENT 'IP地址',
    user_agent TEXT COMMENT '用户代理',
    login_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '登录时间',
    last_active_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '最后活跃时间',
    expires_at TIMESTAMP NOT NULL COMMENT '过期时间',
    status SMALLINT DEFAULT 1 COMMENT '状态：1-活跃，0-已过期',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间'
);

-- 为权限相关表添加索引
CREATE INDEX idx_permission_audit_logs_user_id ON permission_audit_logs(user_id);
CREATE INDEX idx_permission_audit_logs_operation_type ON permission_audit_logs(operation_type);
CREATE INDEX idx_permission_audit_logs_created_at ON permission_audit_logs(created_at);

CREATE INDEX idx_permission_usage_stats_user_id ON permission_usage_stats(user_id);
CREATE INDEX idx_permission_usage_stats_permission ON permission_usage_stats(permission);

CREATE INDEX idx_user_sessions_user_id ON user_sessions(user_id);
CREATE INDEX idx_user_sessions_session_id ON user_sessions(session_id);
CREATE INDEX idx_user_sessions_token_hash ON user_sessions(token_hash);
CREATE INDEX idx_user_sessions_expires_at ON user_sessions(expires_at);
```

### 1.2 默认权限数据初始化

```sql
-- 更新角色表的权限配置
UPDATE roles SET permissions = '{
  "dashboard": {"view": true, "export": true, "configure": true},
  "sales": {
    "leads": {"view": true, "create": true, "edit": true, "delete": true, "assign": true, "convert": true, "export": true, "import": true},
    "customers": {"view": true, "create": true, "edit": true, "delete": true, "merge": true, "export": true, "import": true},
    "orders": {"view": true, "create": true, "edit": true, "delete": true, "approve": true, "export": true, "financial": true}
  },
  "marketing": {
    "campaigns": {"view": true, "create": true, "edit": true, "delete": true, "approve": true, "budget": true, "export": true}
  },
  "system": {
    "users": {"view": true, "create": true, "edit": true, "delete": true, "reset_password": true, "manage_status": true},
    "roles": {"view": true, "create": true, "edit": true, "delete": true, "assign": true},
    "departments": {"view": true, "create": true, "edit": true, "delete": true}
  },
  "analytics": {"predict": true, "recommend": true, "report": true, "risk": true, "sentiment": true, "chat": true},
  "files": {"upload": true, "download": true, "delete": true, "manage": true}
}' WHERE name = '系统管理员';

UPDATE roles SET permissions = '{
  "dashboard": {"view": true, "export": true},
  "sales": {
    "leads": {"view": true, "create": true, "edit": true, "delete": true, "assign": true, "convert": true, "export": true},
    "customers": {"view": true, "create": true, "edit": true, "delete": true, "export": true},
    "orders": {"view": true, "create": true, "edit": true, "approve": true, "export": true}
  },
  "marketing": {
    "campaigns": {"view": true, "export": true}
  },
  "analytics": {"predict": true, "recommend": true, "report": true, "risk": true, "sentiment": true, "chat": true},
  "files": {"upload": true, "download": true}
}' WHERE name = '销售经理';

UPDATE roles SET permissions = '{
  "dashboard": {"view": true},
  "sales": {
    "leads": {"view": true, "create": true, "edit": true, "convert": true},
    "customers": {"view": true, "create": true, "edit": true},
    "orders": {"view": true, "create": true, "edit": true}
  },
  "marketing": {
    "campaigns": {"view": true}
  },
  "analytics": {"recommend": true, "chat": true},
  "files": {"upload": true, "download": true}
}' WHERE name = '销售员';

UPDATE roles SET permissions = '{
  "dashboard": {"view": true, "export": true},
  "sales": {
    "leads": {"view": true, "export": true},
    "customers": {"view": true, "export": true},
    "orders": {"view": true, "export": true}
  },
  "marketing": {
    "campaigns": {"view": true, "create": true, "edit": true, "delete": true, "approve": true, "budget": true, "export": true}
  },
  "analytics": {"predict": true, "recommend": true, "report": true, "risk": true, "sentiment": true, "chat": true},
  "files": {"upload": true, "download": true, "delete": true}
}' WHERE name = '营销经理';

UPDATE roles SET permissions = '{
  "dashboard": {"view": true},
  "sales": {
    "leads": {"view": true},
    "customers": {"view": true}
  },
  "marketing": {
    "campaigns": {"view": true, "create": true, "edit": true, "export": true}
  },
  "analytics": {"chat": true},
  "files": {"upload": true, "download": true}
}' WHERE name = '营销专员';
```

## 2. Spring Security配置

### 2.1 安全配置类

```java
@Configuration
@EnableWebSecurity
@EnableMethodSecurity(prePostEnabled = true, securedEnabled = true)
public class SecurityConfig {
    
    @Autowired
    private JwtAuthenticationEntryPoint jwtAuthenticationEntryPoint;
    
    @Autowired
    private JwtAccessDeniedHandler jwtAccessDeniedHandler;
    
    @Autowired
    private JwtAuthenticationTokenFilter jwtAuthenticationTokenFilter;
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
    
    @Bean
    public AuthenticationManager authenticationManager(
            AuthenticationConfiguration config) throws Exception {
        return config.getAuthenticationManager();
    }
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            // 禁用CSRF
            .csrf().disable()
            
            // 禁用session
            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            
            // 异常处理
            .and()
            .exceptionHandling()
                .authenticationEntryPoint(jwtAuthenticationEntryPoint)
                .accessDeniedHandler(jwtAccessDeniedHandler)
            
            // 权限配置
            .and()
            .authorizeHttpRequests(authz -> authz
                // 允许匿名访问的接口
                .requestMatchers("/api/auth/login", "/api/auth/logout").permitAll()
                .requestMatchers("/api/common/dictionaries").permitAll()
                .requestMatchers("/actuator/health", "/error").permitAll()
                .requestMatchers("/doc.html", "/swagger-ui/**", "/v3/api-docs/**").permitAll()
                
                // 系统管理接口需要管理员权限
                .requestMatchers("/api/system/**").hasAuthority("system:*:*")
                
                // 其他接口需要认证
                .anyRequest().authenticated()
            )
            
            // 添加JWT过滤器
            .addFilterBefore(jwtAuthenticationTokenFilter, UsernamePasswordAuthenticationFilter.class)
            
            // CORS配置
            .cors().configurationSource(corsConfigurationSource());
        
        return http.build();
    }
    
    @Bean
    public CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();
        configuration.setAllowedOriginPatterns(List.of("*"));
        configuration.setAllowedMethods(List.of("GET", "POST", "PUT", "DELETE", "OPTIONS"));
        configuration.setAllowedHeaders(List.of("*"));
        configuration.setAllowCredentials(true);
        configuration.setMaxAge(3600L);
        
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", configuration);
        return source;
    }
}
```

### 2.2 JWT配置

```yaml
# application-security.yml
security:
  jwt:
    # JWT密钥（生产环境应使用环境变量）
    secret: ${JWT_SECRET:crm-system-jwt-secret-key-2024}
    # Token有效期（24小时）
    expiration: 86400
    # 刷新Token有效期（7天）
    refresh-expiration: 604800
    # Token前缀
    token-prefix: "Bearer "
    # 请求头名称
    header-name: "Authorization"
    
  # 会话管理配置
  session:
    # 同一用户最大并发会话数
    max-concurrent-sessions: 3
    # 会话超时时间（30分钟）
    timeout: 1800
    # 踢出策略：false-踢出旧会话，true-阻止新会话
    prevent-login: false
    
  # 密码策略
  password:
    # 最小长度
    min-length: 6
    # 最大长度
    max-length: 20
    # 是否需要包含数字
    require-digit: true
    # 是否需要包含小写字母
    require-lowercase: false
    # 是否需要包含大写字母
    require-uppercase: false
    # 是否需要包含特殊字符
    require-special-char: false
    # 密码过期天数（0表示不过期）
    expire-days: 0
    
  # 登录安全配置
  login:
    # 最大失败次数
    max-failed-attempts: 5
    # 锁定时间（分钟）
    lockout-duration: 30
    # 验证码启用阈值
    captcha-threshold: 3
```

### 2.3 JWT工具类配置

```java
@Component
public class JwtTokenUtil {
    
    @Value("${security.jwt.secret}")
    private String secret;
    
    @Value("${security.jwt.expiration}")
    private Long expiration;
    
    @Value("${security.jwt.refresh-expiration}")
    private Long refreshExpiration;
    
    private static final String CLAIM_KEY_USER_ID = "userId";
    private static final String CLAIM_KEY_ROLE_ID = "roleId";
    private static final String CLAIM_KEY_DEPARTMENT_ID = "departmentId";
    private static final String CLAIM_KEY_DATA_SCOPE = "dataScope";
    private static final String CLAIM_KEY_PERMISSIONS = "permissions";
    
    /**
     * 生成访问Token
     */
    public String generateToken(UserPermissionContext context) {
        Map<String, Object> claims = new HashMap<>();
        claims.put(CLAIM_KEY_USER_ID, context.getUserId());
        claims.put(CLAIM_KEY_ROLE_ID, context.getRoleId());
        claims.put(CLAIM_KEY_DEPARTMENT_ID, context.getDepartmentId());
        claims.put(CLAIM_KEY_DATA_SCOPE, context.getDataScope().getCode());
        claims.put(CLAIM_KEY_PERMISSIONS, context.getPermissionStrings());
        
        return generateToken(claims, context.getUsername(), expiration);
    }
    
    /**
     * 生成刷新Token
     */
    public String generateRefreshToken(String username) {
        return generateToken(new HashMap<>(), username, refreshExpiration);
    }
    
    /**
     * 从Token中获取用户权限上下文
     */
    public UserPermissionContext getPermissionContextFromToken(String token) {
        Claims claims = getClaimsFromToken(token);
        
        UserPermissionContext context = new UserPermissionContext();
        context.setUserId(Long.valueOf(claims.get(CLAIM_KEY_USER_ID).toString()));
        context.setUsername(claims.getSubject());
        context.setRoleId(Long.valueOf(claims.get(CLAIM_KEY_ROLE_ID).toString()));
        context.setDepartmentId(Long.valueOf(claims.get(CLAIM_KEY_DEPARTMENT_ID).toString()));
        context.setDataScope(DataScope.valueOf(claims.get(CLAIM_KEY_DATA_SCOPE).toString()));
        
        @SuppressWarnings("unchecked")
        Set<String> permissions = new HashSet<>((List<String>) claims.get(CLAIM_KEY_PERMISSIONS));
        context.setPermissionStrings(permissions);
        
        return context;
    }
    
    /**
     * 验证Token是否有效
     */
    public Boolean validateToken(String token, String username) {
        final String tokenUsername = getUsernameFromToken(token);
        return (username.equals(tokenUsername) && !isTokenExpired(token));
    }
    
    /**
     * 检查Token是否需要刷新
     */
    public Boolean canTokenBeRefreshed(String token) {
        return !isTokenExpired(token);
    }
    
    /**
     * 刷新Token
     */
    public String refreshToken(String token) {
        final Claims claims = getClaimsFromToken(token);
        claims.setIssuedAt(new Date());
        return generateToken(claims, claims.getSubject(), expiration);
    }
    
    private String generateToken(Map<String, Object> claims, String subject, Long expiration) {
        Date expirationDate = new Date(System.currentTimeMillis() + expiration * 1000);
        
        return Jwts.builder()
                .setClaims(claims)
                .setSubject(subject)
                .setIssuedAt(new Date())
                .setExpiration(expirationDate)
                .signWith(SignatureAlgorithm.HS512, secret)
                .compact();
    }
    
    private Claims getClaimsFromToken(String token) {
        return Jwts.parser()
                .setSigningKey(secret)
                .parseClaimsJws(token)
                .getBody();
    }
}
```

## 3. 权限缓存配置

### 3.1 Redis缓存配置

```yaml
# application-cache.yml
spring:
  redis:
    # Redis服务器地址
    host: ${REDIS_HOST:localhost}
    # Redis服务器端口
    port: ${REDIS_PORT:6379}
    # Redis数据库索引
    database: ${REDIS_DATABASE:0}
    # Redis服务器密码
    password: ${REDIS_PASSWORD:}
    # 连接超时时间
    timeout: 3000ms
    
    # 连接池配置
    lettuce:
      pool:
        # 连接池最大连接数
        max-active: 20
        # 连接池最大空闲连接数
        max-idle: 10
        # 连接池最小空闲连接数
        min-idle: 2
        # 连接池最大阻塞等待时间
        max-wait: -1ms
      # 关闭超时
      shutdown-timeout: 100ms

# 缓存配置
cache:
  # 缓存类型：redis, caffeine, composite
  type: composite
  
  # Redis缓存配置
  redis:
    # 缓存键前缀
    key-prefix: "crm:cache:"
    # 默认TTL（秒）
    default-ttl: 3600
    # 空值TTL（秒）
    null-value-ttl: 300
    
  # Caffeine本地缓存配置
  caffeine:
    # 最大缓存条目数
    maximum-size: 1000
    # 写入后过期时间
    expire-after-write: 30m
    # 访问后过期时间
    expire-after-access: 15m
    
  # 具体缓存配置
  caches:
    # 用户权限缓存
    user-permission:
      ttl: 30m
      max-size: 500
      
    # 角色权限缓存
    role-permission:
      ttl: 1h
      max-size: 100
      
    # 部门数据缓存
    department-tree:
      ttl: 2h
      max-size: 50
      
    # 字典数据缓存
    dictionary:
      ttl: 6h
      max-size: 200
```

### 3.2 缓存配置类

```java
@Configuration
@EnableCaching
public class CacheConfig {
    
    @Autowired
    private RedisConnectionFactory redisConnectionFactory;
    
    @Value("${cache.redis.key-prefix:crm:cache:}")
    private String keyPrefix;
    
    @Value("${cache.redis.default-ttl:3600}")
    private Duration defaultTtl;
    
    @Bean
    @Primary
    public CacheManager cacheManager() {
        // 组合缓存管理器：本地缓存 + Redis缓存
        CompositeCacheManager compositeCacheManager = new CompositeCacheManager();
        
        List<CacheManager> cacheManagers = Arrays.asList(
            caffeineCacheManager(),
            redisCacheManager()
        );
        
        compositeCacheManager.setCacheManagers(cacheManagers);
        compositeCacheManager.setFallbackToNoOpCache(false);
        
        return compositeCacheManager;
    }
    
    @Bean
    public CacheManager caffeineCacheManager() {
        CaffeineCacheManager cacheManager = new CaffeineCacheManager();
        
        // 用户权限缓存：30分钟，最大500条
        Caffeine<Object, Object> userPermissionCaffeine = Caffeine.newBuilder()
            .maximumSize(500)
            .expireAfterWrite(Duration.ofMinutes(30))
            .recordStats();
        
        // 角色权限缓存：1小时，最大100条
        Caffeine<Object, Object> rolePermissionCaffeine = Caffeine.newBuilder()
            .maximumSize(100)
            .expireAfterWrite(Duration.ofHours(1))
            .recordStats();
        
        Map<String, Caffeine<Object, Object>> caches = Map.of(
            "user-permission", userPermissionCaffeine,
            "role-permission", rolePermissionCaffeine
        );
        
        caches.forEach((name, caffeine) -> {
            cacheManager.registerCustomCache(name, caffeine.build());
        });
        
        return cacheManager;
    }
    
    @Bean
    public CacheManager redisCacheManager() {
        RedisCacheConfiguration defaultConfig = RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(defaultTtl)
            .prefixCacheNameWith(keyPrefix)
            .serializeKeysWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new StringRedisSerializer()))
            .serializeValuesWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new GenericJackson2JsonRedisSerializer()));
        
        // 具体缓存配置
        Map<String, RedisCacheConfiguration> cacheConfigurations = Map.of(
            "user-permission", defaultConfig.entryTtl(Duration.ofMinutes(30)),
            "role-permission", defaultConfig.entryTtl(Duration.ofHours(1)),
            "department-tree", defaultConfig.entryTtl(Duration.ofHours(2)),
            "dictionary", defaultConfig.entryTtl(Duration.ofHours(6))
        );
        
        return RedisCacheManager.builder(redisConnectionFactory)
            .cacheDefaults(defaultConfig)
            .withInitialCacheConfigurations(cacheConfigurations)
            .build();
    }
    
    @Bean
    public RedisTemplate<String, Object> redisTemplate() {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(redisConnectionFactory);
        
        // 键序列化
        template.setKeySerializer(new StringRedisSerializer());
        template.setHashKeySerializer(new StringRedisSerializer());
        
        // 值序列化
        GenericJackson2JsonRedisSerializer serializer = new GenericJackson2JsonRedisSerializer();
        template.setValueSerializer(serializer);
        template.setHashValueSerializer(serializer);
        
        template.afterPropertiesSet();
        return template;
    }
}
```

## 4. 方法级权限配置

### 4.1 方法安全配置

```java
@Configuration
@EnableMethodSecurity(
    prePostEnabled = true,   // 启用@PreAuthorize和@PostAuthorize
    securedEnabled = true,   // 启用@Secured
    jsr250Enabled = true     // 启用@RolesAllowed
)
public class MethodSecurityConfig {
    
    @Bean
    public MethodSecurityExpressionHandler methodSecurityExpressionHandler() {
        DefaultMethodSecurityExpressionHandler expressionHandler = 
            new DefaultMethodSecurityExpressionHandler();
        
        // 设置权限评估器
        expressionHandler.setPermissionEvaluator(new CustomPermissionEvaluator());
        
        return expressionHandler;
    }
}
```

### 4.2 自定义权限评估器

```java
@Component
public class CustomPermissionEvaluator implements PermissionEvaluator {
    
    @Autowired
    private PermissionService permissionService;
    
    @Override
    public boolean hasPermission(Authentication authentication, Object targetDomainObject, Object permission) {
        if (authentication == null || !authentication.isAuthenticated()) {
            return false;
        }
        
        UserPermissionContext context = (UserPermissionContext) authentication.getPrincipal();
        String permissionStr = permission.toString();
        
        return context.hasPermission(permissionStr);
    }
    
    @Override
    public boolean hasPermission(Authentication authentication, Serializable targetId, 
                               String targetType, Object permission) {
        if (authentication == null || !authentication.isAuthenticated()) {
            return false;
        }
        
        UserPermissionContext context = (UserPermissionContext) authentication.getPrincipal();
        String permissionStr = permission.toString();
        
        // 检查功能权限
        if (!context.hasPermission(permissionStr)) {
            return false;
        }
        
        // 检查数据权限
        if (targetId != null && targetType != null) {
            return permissionService.hasEntityPermission(
                context.getUserId(),
                context.getDataScope(),
                targetType,
                Long.valueOf(targetId.toString())
            );
        }
        
        return true;
    }
}
```

### 4.3 权限注解使用示例

```java
@RestController
@RequestMapping("/api/sales/leads")
public class LeadsController {
    
    // 基本权限检查
    @PreAuthorize("hasPermission(null, 'sales:leads:view')")
    @GetMapping
    public PageResult<Lead> getLeads(@RequestParam Map<String, Object> params) {
        return leadService.getLeads(params);
    }
    
    // 结合数据权限检查
    @PreAuthorize("hasPermission(#id, 'Lead', 'sales:leads:edit')")
    @PutMapping("/{id}")
    public Result<Lead> updateLead(@PathVariable Long id, @RequestBody UpdateLeadRequest request) {
        return leadService.updateLead(id, request);
    }
    
    // 多权限检查
    @PreAuthorize("hasPermission(null, 'sales:leads:delete') and hasRole('MANAGER')")
    @DeleteMapping("/{id}")
    public Result<Void> deleteLead(@PathVariable Long id) {
        return leadService.deleteLead(id);
    }
    
    // 动态权限检查
    @PreAuthorize("@permissionService.canAccessLead(authentication.principal.userId, #id)")
    @GetMapping("/{id}")
    public Result<Lead> getLeadDetail(@PathVariable Long id) {
        return leadService.getLeadDetail(id);
    }
    
    // 后置权限检查
    @PostAuthorize("hasPermission(returnObject.data, 'Lead', 'sales:leads:view')")
    @GetMapping("/assigned")
    public Result<List<Lead>> getAssignedLeads() {
        return leadService.getAssignedLeads();
    }
}
```

## 5. 权限监控和告警配置

### 5.1 监控配置

```yaml
# application-monitor.yml
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,permission
  endpoint:
    health:
      show-details: always
    permission:
      enabled: true
  metrics:
    tags:
      application: crm-system
      service: permission
    export:
      prometheus:
        enabled: true

# 权限监控配置
permission:
  monitoring:
    enabled: true
    # 权限拒绝告警阈值
    denied-threshold: 10
    # 告警时间窗口（分钟）
    alert-window: 10
    # 异常IP告警阈值
    suspicious-ip-threshold: 20
    # 敏感权限列表
    sensitive-permissions:
      - "system:users:delete"
      - "system:roles:delete"
      - "sales:orders:financial"
      - "analytics:*"
    
  # 审计配置
  audit:
    enabled: true
    # 异步处理
    async: true
    # 日志保留天数
    retention-days: 90
    # 批量写入大小
    batch-size: 100
    # 批量写入间隔（秒）
    batch-interval: 30
```

### 5.2 权限监控端点

```java
@Component
@Endpoint(id = "permission")
public class PermissionEndpoint {
    
    @Autowired
    private PermissionService permissionService;
    
    @Autowired
    private PermissionAuditService auditService;
    
    @ReadOperation
    public Map<String, Object> permission() {
        Map<String, Object> info = new HashMap<>();
        
        // 权限使用统计
        info.put("activeUsers", getActiveUsersCount());
        info.put("onlineUsers", getOnlineUsersCount());
        info.put("permissionDeniedToday", getPermissionDeniedCountToday());
        info.put("topDeniedPermissions", getTopDeniedPermissions());
        
        // 系统权限概览
        info.put("totalRoles", getTotalRolesCount());
        info.put("totalPermissions", getTotalPermissionsCount());
        info.put("avgPermissionsPerRole", getAvgPermissionsPerRole());
        
        return info;
    }
    
    @ReadOperation
    public Map<String, Object> userPermissions(@Selector Long userId) {
        UserPermissionContext context = permissionService.getUserPermissionContext(userId);
        
        Map<String, Object> info = new HashMap<>();
        info.put("userId", context.getUserId());
        info.put("username", context.getUsername());
        info.put("roleName", context.getRoleName());
        info.put("dataScope", context.getDataScope());
        info.put("permissionCount", context.getPermissionStrings().size());
        info.put("permissions", context.getPermissionStrings());
        
        return info;
    }
    
    @WriteOperation
    public Map<String, Object> refreshUserPermissions(@Selector Long userId) {
        permissionService.evictUserPermissionCache(userId);
        return Map.of("message", "用户权限缓存已刷新", "userId", userId);
    }
}
```

## 6. 前端权限集成配置

### 6.1 Webpack配置

```javascript
// webpack.config.js
const path = require('path');

module.exports = {
  resolve: {
    alias: {
      '@': path.resolve(__dirname, 'src'),
      '@/hooks': path.resolve(__dirname, 'src/hooks'),
      '@/components': path.resolve(__dirname, 'src/components'),
      '@/utils': path.resolve(__dirname, 'src/utils'),
      '@/api': path.resolve(__dirname, 'src/api')
    }
  },
  
  // 其他配置...
};
```

### 6.2 API客户端配置

```javascript
// src/api/permission.js
import request from '@/utils/request';

// 获取当前用户权限
export const getUserPermissions = () => {
  return request({
    url: '/api/system/permissions/current',
    method: 'get'
  });
};

// 检查用户权限
export const checkPermission = (userId, permission) => {
  return request({
    url: '/api/system/permissions/check',
    method: 'post',
    data: { userId, permission }
  });
};

// 更新角色权限
export const updateRolePermissions = (roleId, permissions) => {
  return request({
    url: `/api/system/permissions/roles/${roleId}`,
    method: 'put',
    data: permissions
  });
};

// 获取权限审计日志
export const getPermissionAuditLogs = (params) => {
  return request({
    url: '/api/system/permissions/audit-logs',
    method: 'get',
    params
  });
};
```

### 6.3 路由配置

```javascript
// src/router/index.js
import { createBrowserRouter } from 'react-router-dom';
import { PermissionRoute } from '@/components/Permission';

const router = createBrowserRouter([
  {
    path: '/',
    element: <Layout />,
    children: [
      {
        path: 'dashboard',
        element: (
          <PermissionRoute permission="dashboard:view">
            <Dashboard />
          </PermissionRoute>
        )
      },
      {
        path: 'sales',
        children: [
          {
            path: 'leads',
            element: (
              <PermissionRoute permission="sales:leads:view">
                <LeadsPage />
              </PermissionRoute>
            )
          },
          {
            path: 'customers',
            element: (
              <PermissionRoute permission="sales:customers:view">
                <CustomersPage />
              </PermissionRoute>
            )
          }
        ]
      },
      {
        path: 'system',
        children: [
          {
            path: 'users',
            element: (
              <PermissionRoute permission="system:users:view">
                <UsersPage />
              </PermissionRoute>
            )
          },
          {
            path: 'roles',
            element: (
              <PermissionRoute permission="system:roles:view">
                <RolesPage />
              </PermissionRoute>
            )
          }
        ]
      }
    ]
  }
]);

export default router;
```

## 7. 部署检查清单

### 7.1 数据库检查

- [ ] 权限相关表已创建
- [ ] 索引已创建
- [ ] 默认权限数据已初始化
- [ ] 数据库连接正常

### 7.2 应用配置检查

- [ ] JWT密钥已配置
- [ ] Redis连接已配置
- [ ] 缓存配置已启用
- [ ] 权限拦截器已注册

### 7.3 功能测试检查

- [ ] 用户登录功能正常
- [ ] 权限验证功能正常
- [ ] 数据权限隔离正常
- [ ] 字段脱敏功能正常
- [ ] 审计日志记录正常

### 7.4 性能检查

- [ ] 权限缓存命中率 > 80%
- [ ] 权限验证响应时间 < 100ms
- [ ] 内存使用正常
- [ ] 数据库连接池正常

### 7.5 安全检查

- [ ] 敏感信息已加密
- [ ] 默认密码已修改
- [ ] 会话超时配置正常
- [ ] 权限最小化原则已遵循

## 8. 故障排查

### 8.1 常见问题

**权限验证失败**:
```bash
# 检查Token是否有效
curl -H "Authorization: Bearer <token>" http://localhost:50001/api/auth/me

# 检查用户权限
curl -H "Authorization: Bearer <token>" http://localhost:50001/api/system/permissions/current
```

**缓存问题**:
```bash
# 检查Redis连接
redis-cli ping

# 查看权限缓存
redis-cli keys "crm:cache:user-permission:*"

# 清除权限缓存
redis-cli del "crm:cache:user-permission:1"
```

**性能问题**:
```bash
# 查看权限验证指标
curl http://localhost:50001/actuator/metrics/permission.check.duration

# 查看缓存指标
curl http://localhost:50001/actuator/metrics/cache.gets
```

通过以上配置，CRM系统的权限模块可以提供完整的安全控制和良好的性能表现。
