# CRMç³»ç»Ÿå•å…ƒæµ‹è¯•å®æ–½æ–¹æ¡ˆ

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜CRMç³»ç»Ÿçš„å•å…ƒæµ‹è¯•ç­–ç•¥ã€å·¥å…·é€‰æ‹©ã€æµ‹è¯•ç”¨ä¾‹è®¾è®¡å’Œå®æ–½æ­¥éª¤ï¼Œç¡®ä¿ä»£ç è´¨é‡å’Œç³»ç»Ÿç¨³å®šæ€§ã€‚

## æµ‹è¯•ç­–ç•¥

### 1. æµ‹è¯•é‡‘å­—å¡”

```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   E2E Tests     â”‚  (10% - å°‘é‡å…³é”®ä¸šåŠ¡æµç¨‹)
    â”‚   ç«¯åˆ°ç«¯æµ‹è¯•      â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ Integration     â”‚  (20% - æœåŠ¡é—´äº¤äº’)
    â”‚   é›†æˆæµ‹è¯•       â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  Unit Tests     â”‚  (70% - ä¸šåŠ¡é€»è¾‘å•å…ƒ)
    â”‚   å•å…ƒæµ‹è¯•       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

| æµ‹è¯•ç±»å‹ | è¦†ç›–ç‡ç›®æ ‡ | å…³é”®æŒ‡æ ‡ |
|---------|-----------|---------|
| å•å…ƒæµ‹è¯• | 80%+ | è¡Œè¦†ç›–ç‡ã€åˆ†æ”¯è¦†ç›–ç‡ |
| é›†æˆæµ‹è¯• | 60%+ | APIæ¥å£è¦†ç›–ç‡ |
| E2Eæµ‹è¯• | æ ¸å¿ƒæµç¨‹ | å…³é”®ä¸šåŠ¡åœºæ™¯ |

## åç«¯å•å…ƒæµ‹è¯•

### 1. æŠ€æœ¯æ ˆé€‰æ‹©

```xml
<!-- pom.xml - æµ‹è¯•ä¾èµ– -->
<dependencies>
    <!-- Spring Boot Test Starter -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
        <scope>test</scope>
    </dependency>
    
    <!-- JUnit 5 -->
    <dependency>
        <groupId>org.junit.jupiter</groupId>
        <artifactId>junit-jupiter</artifactId>
        <scope>test</scope>
    </dependency>
    
    <!-- Mockito -->
    <dependency>
        <groupId>org.mockito</groupId>
        <artifactId>mockito-core</artifactId>
        <scope>test</scope>
    </dependency>
    
    <!-- TestContainers (é›†æˆæµ‹è¯•ç”¨) -->
    <dependency>
        <groupId>org.testcontainers</groupId>
        <artifactId>junit-jupiter</artifactId>
        <scope>test</scope>
    </dependency>
    <dependency>
        <groupId>org.testcontainers</groupId>
        <artifactId>postgresql</artifactId>
        <scope>test</scope>
    </dependency>
    
    <!-- H2 Database (æµ‹è¯•ç”¨å†…å­˜æ•°æ®åº“) -->
    <dependency>
        <groupId>com.h2database</groupId>
        <artifactId>h2</artifactId>
        <scope>test</scope>
    </dependency>
    
    <!-- WireMock (æ¨¡æ‹Ÿå¤–éƒ¨API) -->
    <dependency>
        <groupId>com.github.tomakehurst</groupId>
        <artifactId>wiremock-jre8</artifactId>
        <scope>test</scope>
    </dependency>
    
    <!-- JsonPath (JSONå“åº”æ–­è¨€) -->
    <dependency>
        <groupId>com.jayway.jsonpath</groupId>
        <artifactId>json-path</artifactId>
        <scope>test</scope>
    </dependency>
</dependencies>
```

### 2. æµ‹è¯•é…ç½®

#### 2.1 æµ‹è¯•é…ç½®æ–‡ä»¶
```yaml
# src/test/resources/application-test.yml
spring:
  profiles:
    active: test
  
  # ä½¿ç”¨H2å†…å­˜æ•°æ®åº“
  datasource:
    url: jdbc:h2:mem:testdb;MODE=PostgreSQL;DATABASE_TO_LOWER=TRUE
    driver-class-name: org.h2.Driver
    username: sa
    password: 
  
  # JPAé…ç½®
  jpa:
    hibernate:
      ddl-auto: create-drop
    show-sql: true
    properties:
      hibernate:
        dialect: org.hibernate.dialect.H2Dialect
        format_sql: true
  
  # Redisé…ç½® (ä½¿ç”¨embedded redis)
  redis:
    host: localhost
    port: 6370  # æµ‹è¯•ä¸“ç”¨ç«¯å£
    
  # ç¦ç”¨å¤–éƒ¨æœåŠ¡
  cloud:
    discovery:
      enabled: false

# æµ‹è¯•ä¸“ç”¨é…ç½®
test:
  # æ¨¡æ‹Ÿå¤–éƒ¨API
  external-apis:
    openai:
      enabled: false
      mock-url: http://localhost:8089
    tencent:
      enabled: false
      mock-url: http://localhost:8089
  
  # æ–‡ä»¶ä¸Šä¼ æµ‹è¯•
  file:
    upload:
      base-path: ./test-uploads
      max-size: 1048576  # 1MB for tests

# æ—¥å¿—é…ç½®
logging:
  level:
    com.crm: DEBUG
    org.springframework.security: DEBUG
    org.hibernate.SQL: DEBUG
```

#### 2.2 æµ‹è¯•åŸºç±»
```java
// src/test/java/com/crm/common/BaseUnitTest.java
@ExtendWith(MockitoExtension.class)
@TestMethodOrder(OrderAnnotation.class)
public abstract class BaseUnitTest {
    
    @BeforeEach
    void setUp() {
        // é€šç”¨æµ‹è¯•åˆå§‹åŒ–
        MockitoAnnotations.openMocks(this);
    }
    
    @AfterEach
    void tearDown() {
        // é€šç”¨æµ‹è¯•æ¸…ç†
        Mockito.reset();
    }
    
    /**
     * åˆ›å»ºæµ‹è¯•ç”¨çš„åˆ†é¡µå‚æ•°
     */
    protected Pageable createPageable(int page, int size) {
        return PageRequest.of(page, size, Sort.by("id").ascending());
    }
    
    /**
     * æ–­è¨€åˆ†é¡µç»“æœ
     */
    protected void assertPageResult(Page<?> page, int expectedSize, long expectedTotal) {
        assertThat(page.getContent()).hasSize(expectedSize);
        assertThat(page.getTotalElements()).isEqualTo(expectedTotal);
    }
}

// src/test/java/com/crm/common/BaseIntegrationTest.java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@ActiveProfiles("test")
@TestMethodOrder(OrderAnnotation.class)
@Transactional
@Rollback
public abstract class BaseIntegrationTest {
    
    @Autowired
    protected TestRestTemplate restTemplate;
    
    @Autowired
    protected TestEntityManager entityManager;
    
    @LocalServerPort
    protected int port;
    
    protected String getBaseUrl() {
        return "http://localhost:" + port + "/api";
    }
    
    /**
     * åˆ›å»ºè®¤è¯Header
     */
    protected HttpHeaders createAuthHeaders(String token) {
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        headers.setBearerAuth(token);
        return headers;
    }
}
```

### 3. å•å…ƒæµ‹è¯•å®æ–½

#### 3.1 Repositoryå±‚æµ‹è¯•
```java
// src/test/java/com/crm/repository/UserRepositoryTest.java
@DataJpaTest
@DisplayName("ç”¨æˆ·Repositoryæµ‹è¯•")
class UserRepositoryTest {
    
    @Autowired
    private TestEntityManager entityManager;
    
    @Autowired
    private UserRepository userRepository;
    
    @Test
    @DisplayName("æ ¹æ®ç”¨æˆ·åæŸ¥æ‰¾ç”¨æˆ·")
    void testFindByUsername() {
        // Given
        User user = User.builder()
            .username("testuser")
            .password("password")
            .name("æµ‹è¯•ç”¨æˆ·")
            .status(1)
            .build();
        entityManager.persistAndFlush(user);
        
        // When
        Optional<User> found = userRepository.findByUsername("testuser");
        
        // Then
        assertThat(found).isPresent();
        assertThat(found.get().getName()).isEqualTo("æµ‹è¯•ç”¨æˆ·");
    }
    
    @Test
    @DisplayName("æ ¹æ®éƒ¨é—¨IDæŸ¥æ‰¾ç”¨æˆ·åˆ—è¡¨")
    void testFindByDepartmentId() {
        // Given
        User user1 = createTestUser("user1", 1L);
        User user2 = createTestUser("user2", 1L);
        User user3 = createTestUser("user3", 2L);
        entityManager.persistAndFlush(user1);
        entityManager.persistAndFlush(user2);
        entityManager.persistAndFlush(user3);
        
        // When
        List<User> users = userRepository.findByDepartmentIdAndStatus(1L, 1);
        
        // Then
        assertThat(users).hasSize(2);
        assertThat(users).extracting(User::getUsername)
            .containsExactlyInAnyOrder("user1", "user2");
    }
    
    @Test
    @DisplayName("åˆ†é¡µæŸ¥è¯¢ç”¨æˆ·")
    void testFindUsersWithPagination() {
        // Given
        for (int i = 1; i <= 15; i++) {
            User user = createTestUser("user" + i, 1L);
            entityManager.persistAndFlush(user);
        }
        
        // When
        Pageable pageable = PageRequest.of(0, 10);
        Page<User> page = userRepository.findByStatus(1, pageable);
        
        // Then
        assertThat(page.getContent()).hasSize(10);
        assertThat(page.getTotalElements()).isEqualTo(15);
        assertThat(page.getTotalPages()).isEqualTo(2);
    }
    
    private User createTestUser(String username, Long departmentId) {
        return User.builder()
            .username(username)
            .password("password")
            .name("æµ‹è¯•ç”¨æˆ·" + username)
            .departmentId(departmentId)
            .status(1)
            .build();
    }
}
```

#### 3.2 Serviceå±‚æµ‹è¯•
```java
// src/test/java/com/crm/service/UserServiceTest.java
@ExtendWith(MockitoExtension.class)
@DisplayName("ç”¨æˆ·Serviceæµ‹è¯•")
class UserServiceTest extends BaseUnitTest {
    
    @Mock
    private UserRepository userRepository;
    
    @Mock
    private PasswordEncoder passwordEncoder;
    
    @Mock
    private DepartmentService departmentService;
    
    @InjectMocks
    private UserServiceImpl userService;
    
    @Test
    @DisplayName("åˆ›å»ºç”¨æˆ·æˆåŠŸ")
    void testCreateUser_Success() {
        // Given
        CreateUserRequest request = CreateUserRequest.builder()
            .username("newuser")
            .password("password123")
            .name("æ–°ç”¨æˆ·")
            .departmentId(1L)
            .roleId(2L)
            .build();
        
        when(userRepository.existsByUsername("newuser")).thenReturn(false);
        when(passwordEncoder.encode("password123")).thenReturn("encoded_password");
        when(departmentService.existsById(1L)).thenReturn(true);
        
        User savedUser = User.builder()
            .id(1L)
            .username("newuser")
            .password("encoded_password")
            .name("æ–°ç”¨æˆ·")
            .departmentId(1L)
            .roleId(2L)
            .status(1)
            .build();
        when(userRepository.save(any(User.class))).thenReturn(savedUser);
        
        // When
        UserResponse result = userService.createUser(request);
        
        // Then
        assertThat(result).isNotNull();
        assertThat(result.getId()).isEqualTo(1L);
        assertThat(result.getUsername()).isEqualTo("newuser");
        assertThat(result.getName()).isEqualTo("æ–°ç”¨æˆ·");
        
        verify(userRepository).existsByUsername("newuser");
        verify(passwordEncoder).encode("password123");
        verify(userRepository).save(any(User.class));
    }
    
    @Test
    @DisplayName("åˆ›å»ºç”¨æˆ·å¤±è´¥ - ç”¨æˆ·åå·²å­˜åœ¨")
    void testCreateUser_UsernameExists() {
        // Given
        CreateUserRequest request = CreateUserRequest.builder()
            .username("existinguser")
            .password("password123")
            .name("æ–°ç”¨æˆ·")
            .build();
        
        when(userRepository.existsByUsername("existinguser")).thenReturn(true);
        
        // When & Then
        assertThatThrownBy(() -> userService.createUser(request))
            .isInstanceOf(BusinessException.class)
            .hasMessageContaining("ç”¨æˆ·åå·²å­˜åœ¨");
        
        verify(userRepository).existsByUsername("existinguser");
        verify(userRepository, never()).save(any(User.class));
    }
    
    @Test
    @DisplayName("åˆ†é¡µæŸ¥è¯¢ç”¨æˆ·")
    void testGetUsers_WithPagination() {
        // Given
        UserQueryRequest query = UserQueryRequest.builder()
            .departmentId(1L)
            .status(1)
            .page(0)
            .size(10)
            .build();
        
        List<User> users = Arrays.asList(
            createTestUser(1L, "user1"),
            createTestUser(2L, "user2")
        );
        Page<User> userPage = new PageImpl<>(users, PageRequest.of(0, 10), 2);
        
        when(userRepository.findByDepartmentIdAndStatus(eq(1L), eq(1), any(Pageable.class)))
            .thenReturn(userPage);
        
        // When
        PageResponse<UserResponse> result = userService.getUsers(query);
        
        // Then
        assertThat(result.getContent()).hasSize(2);
        assertThat(result.getTotalElements()).isEqualTo(2);
        assertThat(result.getContent())
            .extracting(UserResponse::getUsername)
            .containsExactly("user1", "user2");
    }
    
    private User createTestUser(Long id, String username) {
        return User.builder()
            .id(id)
            .username(username)
            .password("password")
            .name("æµ‹è¯•ç”¨æˆ·" + id)
            .status(1)
            .build();
    }
}
```

#### 3.3 Controllerå±‚æµ‹è¯•
```java
// src/test/java/com/crm/controller/UserControllerTest.java
@WebMvcTest(UserController.class)
@DisplayName("ç”¨æˆ·Controlleræµ‹è¯•")
class UserControllerTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @MockBean
    private UserService userService;
    
    @MockBean
    private JwtTokenProvider jwtTokenProvider;
    
    @Test
    @DisplayName("åˆ›å»ºç”¨æˆ· - æˆåŠŸ")
    void testCreateUser_Success() throws Exception {
        // Given
        CreateUserRequest request = CreateUserRequest.builder()
            .username("newuser")
            .password("password123")
            .name("æ–°ç”¨æˆ·")
            .departmentId(1L)
            .roleId(2L)
            .build();
        
        UserResponse response = UserResponse.builder()
            .id(1L)
            .username("newuser")
            .name("æ–°ç”¨æˆ·")
            .departmentId(1L)
            .roleId(2L)
            .build();
        
        when(userService.createUser(any(CreateUserRequest.class))).thenReturn(response);
        
        // When & Then
        mockMvc.perform(post("/api/system/users")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request))
                .header("Authorization", "Bearer " + mockToken))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.code").value(0))
            .andExpect(jsonPath("$.message").value("æ“ä½œæˆåŠŸ"))
            .andExpect(jsonPath("$.data.id").value(1))
            .andExpect(jsonPath("$.data.username").value("newuser"))
            .andExpect(jsonPath("$.data.name").value("æ–°ç”¨æˆ·"));
        
        verify(userService).createUser(any(CreateUserRequest.class));
    }
    
    @Test
    @DisplayName("åˆ›å»ºç”¨æˆ· - å‚æ•°éªŒè¯å¤±è´¥")
    void testCreateUser_ValidationError() throws Exception {
        // Given
        CreateUserRequest request = CreateUserRequest.builder()
            .username("")  // ç©ºç”¨æˆ·å
            .password("123")  // å¯†ç å¤ªçŸ­
            .build();
        
        // When & Then
        mockMvc.perform(post("/api/system/users")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request))
                .header("Authorization", "Bearer " + mockToken))
            .andExpect(status().isBadRequest())
            .andExpect(jsonPath("$.code").value(1001))
            .andExpect(jsonPath("$.message").value("å‚æ•°éªŒè¯å¤±è´¥"));
        
        verify(userService, never()).createUser(any(CreateUserRequest.class));
    }
    
    @Test
    @DisplayName("è·å–ç”¨æˆ·åˆ—è¡¨ - åˆ†é¡µæŸ¥è¯¢")
    void testGetUsers_WithPagination() throws Exception {
        // Given
        List<UserResponse> users = Arrays.asList(
            UserResponse.builder().id(1L).username("user1").name("ç”¨æˆ·1").build(),
            UserResponse.builder().id(2L).username("user2").name("ç”¨æˆ·2").build()
        );
        
        PageResponse<UserResponse> pageResponse = PageResponse.<UserResponse>builder()
            .content(users)
            .page(0)
            .size(10)
            .totalElements(2L)
            .totalPages(1)
            .build();
        
        when(userService.getUsers(any(UserQueryRequest.class))).thenReturn(pageResponse);
        
        // When & Then
        mockMvc.perform(get("/api/system/users")
                .param("page", "0")
                .param("size", "10")
                .param("departmentId", "1")
                .header("Authorization", "Bearer " + mockToken))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.code").value(0))
            .andExpect(jsonPath("$.data.content", hasSize(2)))
            .andExpect(jsonPath("$.data.totalElements").value(2))
            .andExpect(jsonPath("$.data.content[0].username").value("user1"));
    }
}
```

### 4. AIåŠŸèƒ½å•å…ƒæµ‹è¯•

#### 4.1 Python MLæœåŠ¡æµ‹è¯•
```python
# ml-service/tests/test_ml_service.py
import pytest
import pandas as pd
import numpy as np
from unittest.mock import Mock, patch
import sys
import os

# æ·»åŠ é¡¹ç›®è·¯å¾„
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from python_ml_service import app, SalesTrendPredictor, CustomerChurnPredictor

@pytest.fixture
def client():
    """åˆ›å»ºæµ‹è¯•å®¢æˆ·ç«¯"""
    app.config['TESTING'] = True
    with app.test_client() as client:
        yield client

@pytest.fixture
def sample_sales_data():
    """åˆ›å»ºæµ‹è¯•ç”¨é”€å”®æ•°æ®"""
    dates = pd.date_range('2023-01-01', periods=12, freq='M')
    data = pd.DataFrame({
        'date': dates,
        'revenue': np.random.randint(10000, 50000, 12),
        'order_count': np.random.randint(50, 200, 12),
        'unique_customers': np.random.randint(30, 150, 12),
        'avg_order_value': np.random.randint(200, 800, 12)
    })
    return data

@pytest.fixture
def sample_customer_data():
    """åˆ›å»ºæµ‹è¯•ç”¨å®¢æˆ·æ•°æ®"""
    return pd.DataFrame({
        'customer_id': range(1, 101),
        'days_since_last_order': np.random.randint(1, 365, 100),
        'order_frequency': np.random.uniform(0.1, 5.0, 100),
        'avg_order_value': np.random.uniform(100, 1000, 100),
        'total_spent': np.random.uniform(500, 10000, 100),
        'interaction_frequency': np.random.uniform(0.5, 10.0, 100),
        'support_ticket_count': np.random.randint(0, 10, 100),
        'payment_delay': np.random.uniform(0, 30, 100),
        'customer_age': np.random.randint(30, 365, 100)
    })

class TestSalesTrendPredictor:
    """é”€å”®è¶‹åŠ¿é¢„æµ‹æµ‹è¯•"""
    
    def test_init(self):
        """æµ‹è¯•é¢„æµ‹å™¨åˆå§‹åŒ–"""
        predictor = SalesTrendPredictor()
        assert predictor.prophet_model is None
        assert predictor.rf_model is not None
        assert predictor.scaler is not None
    
    def test_train_models(self, sample_sales_data):
        """æµ‹è¯•æ¨¡å‹è®­ç»ƒ"""
        predictor = SalesTrendPredictor()
        predictor.train_models(sample_sales_data)
        
        assert predictor.prophet_model is not None
        assert hasattr(predictor.rf_model, 'feature_importances_')
    
    def test_predict(self, sample_sales_data):
        """æµ‹è¯•é¢„æµ‹åŠŸèƒ½"""
        predictor = SalesTrendPredictor()
        predictor.train_models(sample_sales_data)
        
        result = predictor.predict(future_periods=3)
        
        assert 'prophet_prediction' in result
        assert 'rf_prediction' in result
        assert 'confidence_intervals' in result
        assert len(result['rf_prediction']) == 3

class TestCustomerChurnPredictor:
    """å®¢æˆ·æµå¤±é¢„æµ‹æµ‹è¯•"""
    
    def test_init(self):
        """æµ‹è¯•é¢„æµ‹å™¨åˆå§‹åŒ–"""
        predictor = CustomerChurnPredictor()
        assert predictor.model is not None
        assert predictor.scaler is not None
    
    def test_train(self, sample_customer_data):
        """æµ‹è¯•æ¨¡å‹è®­ç»ƒ"""
        predictor = CustomerChurnPredictor()
        
        # æ·»åŠ æ ‡ç­¾åˆ—
        sample_customer_data['churn'] = np.random.choice([0, 1], size=100)
        
        predictor.train(sample_customer_data)
        assert hasattr(predictor.model, 'feature_importances_')
    
    def test_predict_single(self, sample_customer_data):
        """æµ‹è¯•å•ä¸ªå®¢æˆ·é¢„æµ‹"""
        predictor = CustomerChurnPredictor()
        
        # è®­ç»ƒæ¨¡å‹
        sample_customer_data['churn'] = np.random.choice([0, 1], size=100)
        predictor.train(sample_customer_data)
        
        # é¢„æµ‹
        customer_features = sample_customer_data.iloc[0].drop('churn').to_dict()
        probability = predictor.predict_single(customer_features)
        
        assert 0 <= probability <= 1

class TestMLServiceAPI:
    """MLæœåŠ¡APIæµ‹è¯•"""
    
    def test_health_check(self, client):
        """æµ‹è¯•å¥åº·æ£€æŸ¥æ¥å£"""
        response = client.get('/health')
        assert response.status_code == 200
        
        data = response.get_json()
        assert data['status'] == 'healthy'
    
    def test_model_status(self, client):
        """æµ‹è¯•æ¨¡å‹çŠ¶æ€æ¥å£"""
        response = client.get('/models/status')
        assert response.status_code == 200
        
        data = response.get_json()
        assert 'models' in data
    
    @patch('python_ml_service.redis_client')
    def test_sales_trend_prediction(self, mock_redis, client, sample_sales_data):
        """æµ‹è¯•é”€å”®è¶‹åŠ¿é¢„æµ‹API"""
        # Mock Redis
        mock_redis.exists.return_value = False
        mock_redis.setex.return_value = True
        
        request_data = {
            'training_data': sample_sales_data.to_dict('records'),
            'future_periods': 3,
            'model_version': 'v1.0'
        }
        
        response = client.post('/predict/sales_trend', 
                             json=request_data,
                             content_type='application/json')
        
        assert response.status_code == 200
        data = response.get_json()
        assert 'prophet_prediction' in data
        assert 'rf_prediction' in data
    
    def test_customer_churn_prediction(self, client, sample_customer_data):
        """æµ‹è¯•å®¢æˆ·æµå¤±é¢„æµ‹API"""
        customer_features = sample_customer_data.iloc[0].to_dict()
        
        response = client.post('/predict/customer_churn',
                             json=customer_features,
                             content_type='application/json')
        
        assert response.status_code == 200
        data = response.get_json()
        assert 'churn_probability' in data
        assert 0 <= data['churn_probability'] <= 1

# æµ‹è¯•é…ç½®
pytest_plugins = ['pytest_mock']

if __name__ == '__main__':
    pytest.main(['-v', '--tb=short'])
```

#### 4.2 Java AIæœåŠ¡æµ‹è¯•
```java
// src/test/java/com/crm/analytics/service/PredictionServiceTest.java
@ExtendWith(MockitoExtension.class)
@DisplayName("é¢„æµ‹åˆ†ææœåŠ¡æµ‹è¯•")
class PredictionServiceTest extends BaseUnitTest {
    
    @Mock
    private PythonMLService mlService;
    
    @Mock
    private CRMDataService dataService;
    
    @Mock
    private RedisTemplate<String, Object> redisTemplate;
    
    @Mock
    private ValueOperations<String, Object> valueOperations;
    
    @InjectMocks
    private PredictionServiceImpl predictionService;
    
    @BeforeEach
    void setUp() {
        super.setUp();
        when(redisTemplate.opsForValue()).thenReturn(valueOperations);
    }
    
    @Test
    @DisplayName("é”€å”®è¶‹åŠ¿é¢„æµ‹ - æˆåŠŸ")
    void testPredictSalesTrend_Success() {
        // Given
        PredictionRequest request = PredictionRequest.builder()
            .timeRange("3months")
            .futurePeriods(3)
            .build();
        
        List<SalesData> historicalData = createTestSalesData();
        when(dataService.getSalesData(request)).thenReturn(historicalData);
        
        MLPredictionResult mlResult = MLPredictionResult.builder()
            .prophetPrediction(Arrays.asList(45000.0, 47000.0, 49000.0))
            .rfPrediction(Arrays.asList(44000.0, 46000.0, 48000.0))
            .confidence(0.85)
            .build();
        when(mlService.predict(any(PythonMLRequest.class))).thenReturn(mlResult);
        
        // When
        PredictionResult result = predictionService.predictSalesTrend(request);
        
        // Then
        assertThat(result).isNotNull();
        assertThat(result.getPredictions()).hasSize(3);
        assertThat(result.getConfidence()).isEqualTo(0.85);
        assertThat(result.getAlgorithm()).isEqualTo("prophet+randomforest");
        
        verify(dataService).getSalesData(request);
        verify(mlService).predict(any(PythonMLRequest.class));
        verify(valueOperations).set(anyString(), eq(result), any(Duration.class));
    }
    
    @Test
    @DisplayName("å®¢æˆ·è¡Œä¸ºé¢„æµ‹ - æˆåŠŸ")
    void testPredictCustomerBehavior_Success() {
        // Given
        Long customerId = 1L;
        CustomerFeatureData features = createTestCustomerFeatures();
        when(dataService.getCustomerFeatures(customerId)).thenReturn(features);
        
        Map<String, Double> predictions = Map.of(
            "customer_value", 8500.0,
            "churn_probability", 0.25,
            "purchase_intent", 0.75
        );
        when(mlService.predictMultipleTargets(eq(features), anyList()))
            .thenReturn(predictions);
        
        // When
        CustomerBehaviorPrediction result = predictionService.predictCustomerBehavior(customerId);
        
        // Then
        assertThat(result).isNotNull();
        assertThat(result.getCustomerId()).isEqualTo(customerId);
        assertThat(result.getPredictedValue()).isEqualTo(8500.0);
        assertThat(result.getChurnProbability()).isEqualTo(0.25);
        assertThat(result.getPurchaseIntent()).isEqualTo(0.75);
        
        verify(dataService).getCustomerFeatures(customerId);
        verify(mlService).predictMultipleTargets(eq(features), anyList());
    }
    
    @Test
    @DisplayName("é”€å”®è¶‹åŠ¿é¢„æµ‹ - ç¼“å­˜å‘½ä¸­")
    void testPredictSalesTrend_CacheHit() {
        // Given
        PredictionRequest request = PredictionRequest.builder()
            .timeRange("3months")
            .futurePeriods(3)
            .build();
        
        PredictionResult cachedResult = PredictionResult.builder()
            .predictions(Arrays.asList(45000.0, 47000.0, 49000.0))
            .confidence(0.85)
            .build();
        
        String cacheKey = "prediction:sales:" + request.getCacheKey();
        when(valueOperations.get(cacheKey)).thenReturn(cachedResult);
        
        // When
        PredictionResult result = predictionService.predictSalesTrend(request);
        
        // Then
        assertThat(result).isEqualTo(cachedResult);
        verify(valueOperations).get(cacheKey);
        verify(dataService, never()).getSalesData(any());
        verify(mlService, never()).predict(any());
    }
    
    @Test
    @DisplayName("é¢„æµ‹å¤±è´¥ - MLæœåŠ¡å¼‚å¸¸")
    void testPredictSalesTrend_MLServiceError() {
        // Given
        PredictionRequest request = PredictionRequest.builder()
            .timeRange("3months")
            .futurePeriods(3)
            .build();
        
        List<SalesData> historicalData = createTestSalesData();
        when(dataService.getSalesData(request)).thenReturn(historicalData);
        when(mlService.predict(any(PythonMLRequest.class)))
            .thenThrow(new RuntimeException("MLæœåŠ¡è¿æ¥å¤±è´¥"));
        
        // When & Then
        assertThatThrownBy(() -> predictionService.predictSalesTrend(request))
            .isInstanceOf(ServiceException.class)
            .hasMessageContaining("é¢„æµ‹æœåŠ¡æš‚æ—¶ä¸å¯ç”¨");
        
        verify(dataService).getSalesData(request);
        verify(mlService).predict(any(PythonMLRequest.class));
    }
    
    private List<SalesData> createTestSalesData() {
        return Arrays.asList(
            SalesData.builder().date(LocalDate.now().minusMonths(2)).revenue(40000.0).orderCount(120).build(),
            SalesData.builder().date(LocalDate.now().minusMonths(1)).revenue(42000.0).orderCount(125).build(),
            SalesData.builder().date(LocalDate.now()).revenue(44000.0).orderCount(130).build()
        );
    }
    
    private CustomerFeatureData createTestCustomerFeatures() {
        return CustomerFeatureData.builder()
            .customerId(1L)
            .daysSinceLastOrder(15)
            .orderFrequency(2.5)
            .avgOrderValue(500.0)
            .totalSpent(5000.0)
            .interactionFrequency(1.2)
            .supportTicketCount(1)
            .paymentDelay(2.0)
            .customerAge(180)
            .build();
    }
}
```

### 5. æµ‹è¯•æ•°æ®ç®¡ç†

#### 5.1 æµ‹è¯•æ•°æ®å·¥å‚
```java
// src/test/java/com/crm/factory/TestDataFactory.java
@Component
public class TestDataFactory {
    
    private static final Faker faker = new Faker(new Locale("zh-CN"));
    
    /**
     * åˆ›å»ºæµ‹è¯•ç”¨æˆ·
     */
    public static User createTestUser() {
        return User.builder()
            .username(faker.name().username())
            .password("$2a$10$encrypted_password")
            .name(faker.name().fullName())
            .phone(faker.phoneNumber().cellPhone())
            .departmentId(1L)
            .roleId(2L)
            .status(1)
            .build();
    }
    
    /**
     * åˆ›å»ºæµ‹è¯•çº¿ç´¢
     */
    public static Lead createTestLead() {
        return Lead.builder()
            .name(faker.name().fullName())
            .phone(faker.phoneNumber().cellPhone())
            .businessType("ä¼šè®¡åŸ¹è®­")
            .sourceChannel("SEMæœç´¢")
            .intentionLevel(faker.number().numberBetween(1, 3))
            .assignedUserId(1L)
            .status(1)
            .build();
    }
    
    /**
     * åˆ›å»ºæµ‹è¯•å®¢æˆ·
     */
    public static Customer createTestCustomer() {
        return Customer.builder()
            .name(faker.company().name())
            .contactPerson(faker.name().fullName())
            .phone(faker.phoneNumber().cellPhone())
            .businessType("å­¦å†æå‡")
            .sourceChannel("è¡¨å•å¡«å†™")
            .customerLevel("A")
            .assignedUserId(1L)
            .status(1)
            .build();
    }
    
    /**
     * åˆ›å»ºæµ‹è¯•è®¢å•
     */
    public static Order createTestOrder() {
        return Order.builder()
            .orderNo("ORD" + System.currentTimeMillis())
            .customerId(1L)
            .productName("æ³¨å†Œä¼šè®¡å¸ˆåŸ¹è®­")
            .quantity(1)
            .unitPrice(new BigDecimal("3980.00"))
            .totalAmount(new BigDecimal("3980.00"))
            .orderDate(LocalDateTime.now())
            .assignedUserId(1L)
            .status(1)
            .build();
    }
    
    /**
     * æ‰¹é‡åˆ›å»ºæµ‹è¯•ç”¨æˆ·
     */
    public static List<User> createTestUsers(int count) {
        return IntStream.range(0, count)
            .mapToObj(i -> createTestUser())
            .collect(Collectors.toList());
    }
    
    /**
     * æ‰¹é‡åˆ›å»ºæµ‹è¯•çº¿ç´¢
     */
    public static List<Lead> createTestLeads(int count) {
        return IntStream.range(0, count)
            .mapToObj(i -> createTestLead())
            .collect(Collectors.toList());
    }
}
```

### 6. æµ‹è¯•é…ç½®å’Œè„šæœ¬

#### 6.1 Mavenæµ‹è¯•é…ç½®
```xml
<!-- pom.xml - æµ‹è¯•æ’ä»¶é…ç½® -->
<build>
    <plugins>
        <!-- Surefire Plugin - å•å…ƒæµ‹è¯• -->
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-surefire-plugin</artifactId>
            <version>3.0.0-M9</version>
            <configuration>
                <includes>
                    <include>**/*Test.java</include>
                    <include>**/*Tests.java</include>
                </includes>
                <excludes>
                    <exclude>**/*IntegrationTest.java</exclude>
                </excludes>
                <argLine>-Xmx1024m</argLine>
                <systemPropertyVariables>
                    <spring.profiles.active>test</spring.profiles.active>
                </systemPropertyVariables>
            </configuration>
        </plugin>
        
        <!-- Failsafe Plugin - é›†æˆæµ‹è¯• -->
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-failsafe-plugin</artifactId>
            <version>3.0.0-M9</version>
            <configuration>
                <includes>
                    <include>**/*IntegrationTest.java</include>
                    <include>**/*IT.java</include>
                </includes>
                <systemPropertyVariables>
                    <spring.profiles.active>test</spring.profiles.active>
                </systemPropertyVariables>
            </configuration>
            <executions>
                <execution>
                    <goals>
                        <goal>integration-test</goal>
                        <goal>verify</goal>
                    </goals>
                </execution>
            </executions>
        </plugin>
        
        <!-- JaCoCo Plugin - ä»£ç è¦†ç›–ç‡ -->
        <plugin>
            <groupId>org.jacoco</groupId>
            <artifactId>jacoco-maven-plugin</artifactId>
            <version>0.8.8</version>
            <executions>
                <execution>
                    <goals>
                        <goal>prepare-agent</goal>
                    </goals>
                </execution>
                <execution>
                    <id>report</id>
                    <phase>test</phase>
                    <goals>
                        <goal>report</goal>
                    </goals>
                </execution>
                <execution>
                    <id>check</id>
                    <goals>
                        <goal>check</goal>
                    </goals>
                    <configuration>
                        <rules>
                            <rule>
                                <element>BUNDLE</element>
                                <limits>
                                    <limit>
                                        <counter>LINE</counter>
                                        <value>COVEREDRATIO</value>
                                        <minimum>0.80</minimum>
                                    </limit>
                                </limits>
                            </rule>
                        </rules>
                    </configuration>
                </execution>
            </executions>
        </plugin>
    </plugins>
</build>
```

#### 6.2 æµ‹è¯•è„šæœ¬
```bash
# scripts/run-tests.sh
#!/bin/bash

echo "ğŸ§ª è¿è¡ŒCRMç³»ç»Ÿæµ‹è¯•å¥—ä»¶..."

# è®¾ç½®æµ‹è¯•ç¯å¢ƒ
export SPRING_PROFILES_ACTIVE=test

# æ¸…ç†ä¹‹å‰çš„æµ‹è¯•ç»“æœ
echo "ğŸ§¹ æ¸…ç†æµ‹è¯•ç¯å¢ƒ..."
mvn clean

# è¿è¡Œå•å…ƒæµ‹è¯•
echo "ğŸ”¬ è¿è¡Œå•å…ƒæµ‹è¯•..."
mvn test -Dtest.profile=unit

if [ $? -ne 0 ]; then
    echo "âŒ å•å…ƒæµ‹è¯•å¤±è´¥"
    exit 1
fi

# è¿è¡Œé›†æˆæµ‹è¯•
echo "ğŸ”— è¿è¡Œé›†æˆæµ‹è¯•..."
mvn verify -Dtest.profile=integration

if [ $? -ne 0 ]; then
    echo "âŒ é›†æˆæµ‹è¯•å¤±è´¥"
    exit 1
fi

# ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
echo "ğŸ“Š ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š..."
mvn jacoco:report

# æ£€æŸ¥è¦†ç›–ç‡
echo "ğŸ“ˆ æ£€æŸ¥ä»£ç è¦†ç›–ç‡..."
mvn jacoco:check

echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼"
echo "ğŸ“‹ æµ‹è¯•æŠ¥å‘Šä½ç½®: target/site/jacoco/index.html"
```

### 7. æŒç»­é›†æˆé…ç½®

#### 7.1 GitHub Actionsé…ç½®
```yaml
# .github/workflows/test.yml
name: Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      redis:
        image: redis:6.2
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
    
    - name: Install Python dependencies
      run: |
        cd ml-service
        pip install -r requirements.txt
    
    - name: Run unit tests
      run: mvn test
    
    - name: Run integration tests
      run: mvn verify
    
    - name: Generate test report
      run: mvn jacoco:report
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./target/site/jacoco/jacoco.xml
```

è¿™ä¸ªå•å…ƒæµ‹è¯•å®æ–½æ–¹æ¡ˆä¸ºCRMç³»ç»Ÿæä¾›äº†å®Œæ•´çš„æµ‹è¯•ç­–ç•¥ï¼Œè¦†ç›–äº†Repositoryã€Serviceã€Controllerå„ä¸ªå±‚çº§ï¼Œä»¥åŠAIåŠŸèƒ½çš„æµ‹è¯•ã€‚æ¥ä¸‹æ¥æˆ‘å°†è¡¥å……é›†æˆæµ‹è¯•æ–¹æ¡ˆã€‚
