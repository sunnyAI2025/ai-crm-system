# CRM系统单元测试实施方案

## 概述

本文档详细说明CRM系统的单元测试策略、工具选择、测试用例设计和实施步骤，确保代码质量和系统稳定性。

## 测试策略

### 1. 测试金字塔

```
    ┌─────────────────┐
    │   E2E Tests     │  (10% - 少量关键业务流程)
    │   端到端测试      │
    ├─────────────────┤
    │ Integration     │  (20% - 服务间交互)
    │   集成测试       │
    ├─────────────────┤
    │  Unit Tests     │  (70% - 业务逻辑单元)
    │   单元测试       │
    └─────────────────┘
```

### 2. 测试覆盖率目标

| 测试类型 | 覆盖率目标 | 关键指标 |
|---------|-----------|---------|
| 单元测试 | 80%+ | 行覆盖率、分支覆盖率 |
| 集成测试 | 60%+ | API接口覆盖率 |
| E2E测试 | 核心流程 | 关键业务场景 |

## 后端单元测试

### 1. 技术栈选择

```xml
<!-- pom.xml - 测试依赖 -->
<dependencies>
    <!-- Spring Boot Test Starter -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
        <scope>test</scope>
    </dependency>
    
    <!-- JUnit 5 -->
    <dependency>
        <groupId>org.junit.jupiter</groupId>
        <artifactId>junit-jupiter</artifactId>
        <scope>test</scope>
    </dependency>
    
    <!-- Mockito -->
    <dependency>
        <groupId>org.mockito</groupId>
        <artifactId>mockito-core</artifactId>
        <scope>test</scope>
    </dependency>
    
    <!-- TestContainers (集成测试用) -->
    <dependency>
        <groupId>org.testcontainers</groupId>
        <artifactId>junit-jupiter</artifactId>
        <scope>test</scope>
    </dependency>
    <dependency>
        <groupId>org.testcontainers</groupId>
        <artifactId>postgresql</artifactId>
        <scope>test</scope>
    </dependency>
    
    <!-- H2 Database (测试用内存数据库) -->
    <dependency>
        <groupId>com.h2database</groupId>
        <artifactId>h2</artifactId>
        <scope>test</scope>
    </dependency>
    
    <!-- WireMock (模拟外部API) -->
    <dependency>
        <groupId>com.github.tomakehurst</groupId>
        <artifactId>wiremock-jre8</artifactId>
        <scope>test</scope>
    </dependency>
    
    <!-- JsonPath (JSON响应断言) -->
    <dependency>
        <groupId>com.jayway.jsonpath</groupId>
        <artifactId>json-path</artifactId>
        <scope>test</scope>
    </dependency>
</dependencies>
```

### 2. 测试配置

#### 2.1 测试配置文件
```yaml
# src/test/resources/application-test.yml
spring:
  profiles:
    active: test
  
  # 使用H2内存数据库
  datasource:
    url: jdbc:h2:mem:testdb;MODE=PostgreSQL;DATABASE_TO_LOWER=TRUE
    driver-class-name: org.h2.Driver
    username: sa
    password: 
  
  # JPA配置
  jpa:
    hibernate:
      ddl-auto: create-drop
    show-sql: true
    properties:
      hibernate:
        dialect: org.hibernate.dialect.H2Dialect
        format_sql: true
  
  # Redis配置 (使用embedded redis)
  redis:
    host: localhost
    port: 6370  # 测试专用端口
    
  # 禁用外部服务
  cloud:
    discovery:
      enabled: false

# 测试专用配置
test:
  # 模拟外部API
  external-apis:
    openai:
      enabled: false
      mock-url: http://localhost:8089
    tencent:
      enabled: false
      mock-url: http://localhost:8089
  
  # 文件上传测试
  file:
    upload:
      base-path: ./test-uploads
      max-size: 1048576  # 1MB for tests

# 日志配置
logging:
  level:
    com.crm: DEBUG
    org.springframework.security: DEBUG
    org.hibernate.SQL: DEBUG
```

#### 2.2 测试基类
```java
// src/test/java/com/crm/common/BaseUnitTest.java
@ExtendWith(MockitoExtension.class)
@TestMethodOrder(OrderAnnotation.class)
public abstract class BaseUnitTest {
    
    @BeforeEach
    void setUp() {
        // 通用测试初始化
        MockitoAnnotations.openMocks(this);
    }
    
    @AfterEach
    void tearDown() {
        // 通用测试清理
        Mockito.reset();
    }
    
    /**
     * 创建测试用的分页参数
     */
    protected Pageable createPageable(int page, int size) {
        return PageRequest.of(page, size, Sort.by("id").ascending());
    }
    
    /**
     * 断言分页结果
     */
    protected void assertPageResult(Page<?> page, int expectedSize, long expectedTotal) {
        assertThat(page.getContent()).hasSize(expectedSize);
        assertThat(page.getTotalElements()).isEqualTo(expectedTotal);
    }
}

// src/test/java/com/crm/common/BaseIntegrationTest.java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@ActiveProfiles("test")
@TestMethodOrder(OrderAnnotation.class)
@Transactional
@Rollback
public abstract class BaseIntegrationTest {
    
    @Autowired
    protected TestRestTemplate restTemplate;
    
    @Autowired
    protected TestEntityManager entityManager;
    
    @LocalServerPort
    protected int port;
    
    protected String getBaseUrl() {
        return "http://localhost:" + port + "/api";
    }
    
    /**
     * 创建认证Header
     */
    protected HttpHeaders createAuthHeaders(String token) {
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        headers.setBearerAuth(token);
        return headers;
    }
}
```

### 3. 单元测试实施

#### 3.1 Repository层测试
```java
// src/test/java/com/crm/repository/UserRepositoryTest.java
@DataJpaTest
@DisplayName("用户Repository测试")
class UserRepositoryTest {
    
    @Autowired
    private TestEntityManager entityManager;
    
    @Autowired
    private UserRepository userRepository;
    
    @Test
    @DisplayName("根据用户名查找用户")
    void testFindByUsername() {
        // Given
        User user = User.builder()
            .username("testuser")
            .password("password")
            .name("测试用户")
            .status(1)
            .build();
        entityManager.persistAndFlush(user);
        
        // When
        Optional<User> found = userRepository.findByUsername("testuser");
        
        // Then
        assertThat(found).isPresent();
        assertThat(found.get().getName()).isEqualTo("测试用户");
    }
    
    @Test
    @DisplayName("根据部门ID查找用户列表")
    void testFindByDepartmentId() {
        // Given
        User user1 = createTestUser("user1", 1L);
        User user2 = createTestUser("user2", 1L);
        User user3 = createTestUser("user3", 2L);
        entityManager.persistAndFlush(user1);
        entityManager.persistAndFlush(user2);
        entityManager.persistAndFlush(user3);
        
        // When
        List<User> users = userRepository.findByDepartmentIdAndStatus(1L, 1);
        
        // Then
        assertThat(users).hasSize(2);
        assertThat(users).extracting(User::getUsername)
            .containsExactlyInAnyOrder("user1", "user2");
    }
    
    @Test
    @DisplayName("分页查询用户")
    void testFindUsersWithPagination() {
        // Given
        for (int i = 1; i <= 15; i++) {
            User user = createTestUser("user" + i, 1L);
            entityManager.persistAndFlush(user);
        }
        
        // When
        Pageable pageable = PageRequest.of(0, 10);
        Page<User> page = userRepository.findByStatus(1, pageable);
        
        // Then
        assertThat(page.getContent()).hasSize(10);
        assertThat(page.getTotalElements()).isEqualTo(15);
        assertThat(page.getTotalPages()).isEqualTo(2);
    }
    
    private User createTestUser(String username, Long departmentId) {
        return User.builder()
            .username(username)
            .password("password")
            .name("测试用户" + username)
            .departmentId(departmentId)
            .status(1)
            .build();
    }
}
```

#### 3.2 Service层测试
```java
// src/test/java/com/crm/service/UserServiceTest.java
@ExtendWith(MockitoExtension.class)
@DisplayName("用户Service测试")
class UserServiceTest extends BaseUnitTest {
    
    @Mock
    private UserRepository userRepository;
    
    @Mock
    private PasswordEncoder passwordEncoder;
    
    @Mock
    private DepartmentService departmentService;
    
    @InjectMocks
    private UserServiceImpl userService;
    
    @Test
    @DisplayName("创建用户成功")
    void testCreateUser_Success() {
        // Given
        CreateUserRequest request = CreateUserRequest.builder()
            .username("newuser")
            .password("password123")
            .name("新用户")
            .departmentId(1L)
            .roleId(2L)
            .build();
        
        when(userRepository.existsByUsername("newuser")).thenReturn(false);
        when(passwordEncoder.encode("password123")).thenReturn("encoded_password");
        when(departmentService.existsById(1L)).thenReturn(true);
        
        User savedUser = User.builder()
            .id(1L)
            .username("newuser")
            .password("encoded_password")
            .name("新用户")
            .departmentId(1L)
            .roleId(2L)
            .status(1)
            .build();
        when(userRepository.save(any(User.class))).thenReturn(savedUser);
        
        // When
        UserResponse result = userService.createUser(request);
        
        // Then
        assertThat(result).isNotNull();
        assertThat(result.getId()).isEqualTo(1L);
        assertThat(result.getUsername()).isEqualTo("newuser");
        assertThat(result.getName()).isEqualTo("新用户");
        
        verify(userRepository).existsByUsername("newuser");
        verify(passwordEncoder).encode("password123");
        verify(userRepository).save(any(User.class));
    }
    
    @Test
    @DisplayName("创建用户失败 - 用户名已存在")
    void testCreateUser_UsernameExists() {
        // Given
        CreateUserRequest request = CreateUserRequest.builder()
            .username("existinguser")
            .password("password123")
            .name("新用户")
            .build();
        
        when(userRepository.existsByUsername("existinguser")).thenReturn(true);
        
        // When & Then
        assertThatThrownBy(() -> userService.createUser(request))
            .isInstanceOf(BusinessException.class)
            .hasMessageContaining("用户名已存在");
        
        verify(userRepository).existsByUsername("existinguser");
        verify(userRepository, never()).save(any(User.class));
    }
    
    @Test
    @DisplayName("分页查询用户")
    void testGetUsers_WithPagination() {
        // Given
        UserQueryRequest query = UserQueryRequest.builder()
            .departmentId(1L)
            .status(1)
            .page(0)
            .size(10)
            .build();
        
        List<User> users = Arrays.asList(
            createTestUser(1L, "user1"),
            createTestUser(2L, "user2")
        );
        Page<User> userPage = new PageImpl<>(users, PageRequest.of(0, 10), 2);
        
        when(userRepository.findByDepartmentIdAndStatus(eq(1L), eq(1), any(Pageable.class)))
            .thenReturn(userPage);
        
        // When
        PageResponse<UserResponse> result = userService.getUsers(query);
        
        // Then
        assertThat(result.getContent()).hasSize(2);
        assertThat(result.getTotalElements()).isEqualTo(2);
        assertThat(result.getContent())
            .extracting(UserResponse::getUsername)
            .containsExactly("user1", "user2");
    }
    
    private User createTestUser(Long id, String username) {
        return User.builder()
            .id(id)
            .username(username)
            .password("password")
            .name("测试用户" + id)
            .status(1)
            .build();
    }
}
```

#### 3.3 Controller层测试
```java
// src/test/java/com/crm/controller/UserControllerTest.java
@WebMvcTest(UserController.class)
@DisplayName("用户Controller测试")
class UserControllerTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @MockBean
    private UserService userService;
    
    @MockBean
    private JwtTokenProvider jwtTokenProvider;
    
    @Test
    @DisplayName("创建用户 - 成功")
    void testCreateUser_Success() throws Exception {
        // Given
        CreateUserRequest request = CreateUserRequest.builder()
            .username("newuser")
            .password("password123")
            .name("新用户")
            .departmentId(1L)
            .roleId(2L)
            .build();
        
        UserResponse response = UserResponse.builder()
            .id(1L)
            .username("newuser")
            .name("新用户")
            .departmentId(1L)
            .roleId(2L)
            .build();
        
        when(userService.createUser(any(CreateUserRequest.class))).thenReturn(response);
        
        // When & Then
        mockMvc.perform(post("/api/system/users")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request))
                .header("Authorization", "Bearer " + mockToken))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.code").value(0))
            .andExpect(jsonPath("$.message").value("操作成功"))
            .andExpect(jsonPath("$.data.id").value(1))
            .andExpect(jsonPath("$.data.username").value("newuser"))
            .andExpect(jsonPath("$.data.name").value("新用户"));
        
        verify(userService).createUser(any(CreateUserRequest.class));
    }
    
    @Test
    @DisplayName("创建用户 - 参数验证失败")
    void testCreateUser_ValidationError() throws Exception {
        // Given
        CreateUserRequest request = CreateUserRequest.builder()
            .username("")  // 空用户名
            .password("123")  // 密码太短
            .build();
        
        // When & Then
        mockMvc.perform(post("/api/system/users")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request))
                .header("Authorization", "Bearer " + mockToken))
            .andExpect(status().isBadRequest())
            .andExpect(jsonPath("$.code").value(1001))
            .andExpect(jsonPath("$.message").value("参数验证失败"));
        
        verify(userService, never()).createUser(any(CreateUserRequest.class));
    }
    
    @Test
    @DisplayName("获取用户列表 - 分页查询")
    void testGetUsers_WithPagination() throws Exception {
        // Given
        List<UserResponse> users = Arrays.asList(
            UserResponse.builder().id(1L).username("user1").name("用户1").build(),
            UserResponse.builder().id(2L).username("user2").name("用户2").build()
        );
        
        PageResponse<UserResponse> pageResponse = PageResponse.<UserResponse>builder()
            .content(users)
            .page(0)
            .size(10)
            .totalElements(2L)
            .totalPages(1)
            .build();
        
        when(userService.getUsers(any(UserQueryRequest.class))).thenReturn(pageResponse);
        
        // When & Then
        mockMvc.perform(get("/api/system/users")
                .param("page", "0")
                .param("size", "10")
                .param("departmentId", "1")
                .header("Authorization", "Bearer " + mockToken))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.code").value(0))
            .andExpect(jsonPath("$.data.content", hasSize(2)))
            .andExpect(jsonPath("$.data.totalElements").value(2))
            .andExpect(jsonPath("$.data.content[0].username").value("user1"));
    }
}
```

### 4. AI功能单元测试

#### 4.1 Python ML服务测试
```python
# ml-service/tests/test_ml_service.py
import pytest
import pandas as pd
import numpy as np
from unittest.mock import Mock, patch
import sys
import os

# 添加项目路径
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from python_ml_service import app, SalesTrendPredictor, CustomerChurnPredictor

@pytest.fixture
def client():
    """创建测试客户端"""
    app.config['TESTING'] = True
    with app.test_client() as client:
        yield client

@pytest.fixture
def sample_sales_data():
    """创建测试用销售数据"""
    dates = pd.date_range('2023-01-01', periods=12, freq='M')
    data = pd.DataFrame({
        'date': dates,
        'revenue': np.random.randint(10000, 50000, 12),
        'order_count': np.random.randint(50, 200, 12),
        'unique_customers': np.random.randint(30, 150, 12),
        'avg_order_value': np.random.randint(200, 800, 12)
    })
    return data

@pytest.fixture
def sample_customer_data():
    """创建测试用客户数据"""
    return pd.DataFrame({
        'customer_id': range(1, 101),
        'days_since_last_order': np.random.randint(1, 365, 100),
        'order_frequency': np.random.uniform(0.1, 5.0, 100),
        'avg_order_value': np.random.uniform(100, 1000, 100),
        'total_spent': np.random.uniform(500, 10000, 100),
        'interaction_frequency': np.random.uniform(0.5, 10.0, 100),
        'support_ticket_count': np.random.randint(0, 10, 100),
        'payment_delay': np.random.uniform(0, 30, 100),
        'customer_age': np.random.randint(30, 365, 100)
    })

class TestSalesTrendPredictor:
    """销售趋势预测测试"""
    
    def test_init(self):
        """测试预测器初始化"""
        predictor = SalesTrendPredictor()
        assert predictor.prophet_model is None
        assert predictor.rf_model is not None
        assert predictor.scaler is not None
    
    def test_train_models(self, sample_sales_data):
        """测试模型训练"""
        predictor = SalesTrendPredictor()
        predictor.train_models(sample_sales_data)
        
        assert predictor.prophet_model is not None
        assert hasattr(predictor.rf_model, 'feature_importances_')
    
    def test_predict(self, sample_sales_data):
        """测试预测功能"""
        predictor = SalesTrendPredictor()
        predictor.train_models(sample_sales_data)
        
        result = predictor.predict(future_periods=3)
        
        assert 'prophet_prediction' in result
        assert 'rf_prediction' in result
        assert 'confidence_intervals' in result
        assert len(result['rf_prediction']) == 3

class TestCustomerChurnPredictor:
    """客户流失预测测试"""
    
    def test_init(self):
        """测试预测器初始化"""
        predictor = CustomerChurnPredictor()
        assert predictor.model is not None
        assert predictor.scaler is not None
    
    def test_train(self, sample_customer_data):
        """测试模型训练"""
        predictor = CustomerChurnPredictor()
        
        # 添加标签列
        sample_customer_data['churn'] = np.random.choice([0, 1], size=100)
        
        predictor.train(sample_customer_data)
        assert hasattr(predictor.model, 'feature_importances_')
    
    def test_predict_single(self, sample_customer_data):
        """测试单个客户预测"""
        predictor = CustomerChurnPredictor()
        
        # 训练模型
        sample_customer_data['churn'] = np.random.choice([0, 1], size=100)
        predictor.train(sample_customer_data)
        
        # 预测
        customer_features = sample_customer_data.iloc[0].drop('churn').to_dict()
        probability = predictor.predict_single(customer_features)
        
        assert 0 <= probability <= 1

class TestMLServiceAPI:
    """ML服务API测试"""
    
    def test_health_check(self, client):
        """测试健康检查接口"""
        response = client.get('/health')
        assert response.status_code == 200
        
        data = response.get_json()
        assert data['status'] == 'healthy'
    
    def test_model_status(self, client):
        """测试模型状态接口"""
        response = client.get('/models/status')
        assert response.status_code == 200
        
        data = response.get_json()
        assert 'models' in data
    
    @patch('python_ml_service.redis_client')
    def test_sales_trend_prediction(self, mock_redis, client, sample_sales_data):
        """测试销售趋势预测API"""
        # Mock Redis
        mock_redis.exists.return_value = False
        mock_redis.setex.return_value = True
        
        request_data = {
            'training_data': sample_sales_data.to_dict('records'),
            'future_periods': 3,
            'model_version': 'v1.0'
        }
        
        response = client.post('/predict/sales_trend', 
                             json=request_data,
                             content_type='application/json')
        
        assert response.status_code == 200
        data = response.get_json()
        assert 'prophet_prediction' in data
        assert 'rf_prediction' in data
    
    def test_customer_churn_prediction(self, client, sample_customer_data):
        """测试客户流失预测API"""
        customer_features = sample_customer_data.iloc[0].to_dict()
        
        response = client.post('/predict/customer_churn',
                             json=customer_features,
                             content_type='application/json')
        
        assert response.status_code == 200
        data = response.get_json()
        assert 'churn_probability' in data
        assert 0 <= data['churn_probability'] <= 1

# 测试配置
pytest_plugins = ['pytest_mock']

if __name__ == '__main__':
    pytest.main(['-v', '--tb=short'])
```

#### 4.2 Java AI服务测试
```java
// src/test/java/com/crm/analytics/service/PredictionServiceTest.java
@ExtendWith(MockitoExtension.class)
@DisplayName("预测分析服务测试")
class PredictionServiceTest extends BaseUnitTest {
    
    @Mock
    private PythonMLService mlService;
    
    @Mock
    private CRMDataService dataService;
    
    @Mock
    private RedisTemplate<String, Object> redisTemplate;
    
    @Mock
    private ValueOperations<String, Object> valueOperations;
    
    @InjectMocks
    private PredictionServiceImpl predictionService;
    
    @BeforeEach
    void setUp() {
        super.setUp();
        when(redisTemplate.opsForValue()).thenReturn(valueOperations);
    }
    
    @Test
    @DisplayName("销售趋势预测 - 成功")
    void testPredictSalesTrend_Success() {
        // Given
        PredictionRequest request = PredictionRequest.builder()
            .timeRange("3months")
            .futurePeriods(3)
            .build();
        
        List<SalesData> historicalData = createTestSalesData();
        when(dataService.getSalesData(request)).thenReturn(historicalData);
        
        MLPredictionResult mlResult = MLPredictionResult.builder()
            .prophetPrediction(Arrays.asList(45000.0, 47000.0, 49000.0))
            .rfPrediction(Arrays.asList(44000.0, 46000.0, 48000.0))
            .confidence(0.85)
            .build();
        when(mlService.predict(any(PythonMLRequest.class))).thenReturn(mlResult);
        
        // When
        PredictionResult result = predictionService.predictSalesTrend(request);
        
        // Then
        assertThat(result).isNotNull();
        assertThat(result.getPredictions()).hasSize(3);
        assertThat(result.getConfidence()).isEqualTo(0.85);
        assertThat(result.getAlgorithm()).isEqualTo("prophet+randomforest");
        
        verify(dataService).getSalesData(request);
        verify(mlService).predict(any(PythonMLRequest.class));
        verify(valueOperations).set(anyString(), eq(result), any(Duration.class));
    }
    
    @Test
    @DisplayName("客户行为预测 - 成功")
    void testPredictCustomerBehavior_Success() {
        // Given
        Long customerId = 1L;
        CustomerFeatureData features = createTestCustomerFeatures();
        when(dataService.getCustomerFeatures(customerId)).thenReturn(features);
        
        Map<String, Double> predictions = Map.of(
            "customer_value", 8500.0,
            "churn_probability", 0.25,
            "purchase_intent", 0.75
        );
        when(mlService.predictMultipleTargets(eq(features), anyList()))
            .thenReturn(predictions);
        
        // When
        CustomerBehaviorPrediction result = predictionService.predictCustomerBehavior(customerId);
        
        // Then
        assertThat(result).isNotNull();
        assertThat(result.getCustomerId()).isEqualTo(customerId);
        assertThat(result.getPredictedValue()).isEqualTo(8500.0);
        assertThat(result.getChurnProbability()).isEqualTo(0.25);
        assertThat(result.getPurchaseIntent()).isEqualTo(0.75);
        
        verify(dataService).getCustomerFeatures(customerId);
        verify(mlService).predictMultipleTargets(eq(features), anyList());
    }
    
    @Test
    @DisplayName("销售趋势预测 - 缓存命中")
    void testPredictSalesTrend_CacheHit() {
        // Given
        PredictionRequest request = PredictionRequest.builder()
            .timeRange("3months")
            .futurePeriods(3)
            .build();
        
        PredictionResult cachedResult = PredictionResult.builder()
            .predictions(Arrays.asList(45000.0, 47000.0, 49000.0))
            .confidence(0.85)
            .build();
        
        String cacheKey = "prediction:sales:" + request.getCacheKey();
        when(valueOperations.get(cacheKey)).thenReturn(cachedResult);
        
        // When
        PredictionResult result = predictionService.predictSalesTrend(request);
        
        // Then
        assertThat(result).isEqualTo(cachedResult);
        verify(valueOperations).get(cacheKey);
        verify(dataService, never()).getSalesData(any());
        verify(mlService, never()).predict(any());
    }
    
    @Test
    @DisplayName("预测失败 - ML服务异常")
    void testPredictSalesTrend_MLServiceError() {
        // Given
        PredictionRequest request = PredictionRequest.builder()
            .timeRange("3months")
            .futurePeriods(3)
            .build();
        
        List<SalesData> historicalData = createTestSalesData();
        when(dataService.getSalesData(request)).thenReturn(historicalData);
        when(mlService.predict(any(PythonMLRequest.class)))
            .thenThrow(new RuntimeException("ML服务连接失败"));
        
        // When & Then
        assertThatThrownBy(() -> predictionService.predictSalesTrend(request))
            .isInstanceOf(ServiceException.class)
            .hasMessageContaining("预测服务暂时不可用");
        
        verify(dataService).getSalesData(request);
        verify(mlService).predict(any(PythonMLRequest.class));
    }
    
    private List<SalesData> createTestSalesData() {
        return Arrays.asList(
            SalesData.builder().date(LocalDate.now().minusMonths(2)).revenue(40000.0).orderCount(120).build(),
            SalesData.builder().date(LocalDate.now().minusMonths(1)).revenue(42000.0).orderCount(125).build(),
            SalesData.builder().date(LocalDate.now()).revenue(44000.0).orderCount(130).build()
        );
    }
    
    private CustomerFeatureData createTestCustomerFeatures() {
        return CustomerFeatureData.builder()
            .customerId(1L)
            .daysSinceLastOrder(15)
            .orderFrequency(2.5)
            .avgOrderValue(500.0)
            .totalSpent(5000.0)
            .interactionFrequency(1.2)
            .supportTicketCount(1)
            .paymentDelay(2.0)
            .customerAge(180)
            .build();
    }
}
```

### 5. 测试数据管理

#### 5.1 测试数据工厂
```java
// src/test/java/com/crm/factory/TestDataFactory.java
@Component
public class TestDataFactory {
    
    private static final Faker faker = new Faker(new Locale("zh-CN"));
    
    /**
     * 创建测试用户
     */
    public static User createTestUser() {
        return User.builder()
            .username(faker.name().username())
            .password("$2a$10$encrypted_password")
            .name(faker.name().fullName())
            .phone(faker.phoneNumber().cellPhone())
            .departmentId(1L)
            .roleId(2L)
            .status(1)
            .build();
    }
    
    /**
     * 创建测试线索
     */
    public static Lead createTestLead() {
        return Lead.builder()
            .name(faker.name().fullName())
            .phone(faker.phoneNumber().cellPhone())
            .businessType("会计培训")
            .sourceChannel("SEM搜索")
            .intentionLevel(faker.number().numberBetween(1, 3))
            .assignedUserId(1L)
            .status(1)
            .build();
    }
    
    /**
     * 创建测试客户
     */
    public static Customer createTestCustomer() {
        return Customer.builder()
            .name(faker.company().name())
            .contactPerson(faker.name().fullName())
            .phone(faker.phoneNumber().cellPhone())
            .businessType("学历提升")
            .sourceChannel("表单填写")
            .customerLevel("A")
            .assignedUserId(1L)
            .status(1)
            .build();
    }
    
    /**
     * 创建测试订单
     */
    public static Order createTestOrder() {
        return Order.builder()
            .orderNo("ORD" + System.currentTimeMillis())
            .customerId(1L)
            .productName("注册会计师培训")
            .quantity(1)
            .unitPrice(new BigDecimal("3980.00"))
            .totalAmount(new BigDecimal("3980.00"))
            .orderDate(LocalDateTime.now())
            .assignedUserId(1L)
            .status(1)
            .build();
    }
    
    /**
     * 批量创建测试用户
     */
    public static List<User> createTestUsers(int count) {
        return IntStream.range(0, count)
            .mapToObj(i -> createTestUser())
            .collect(Collectors.toList());
    }
    
    /**
     * 批量创建测试线索
     */
    public static List<Lead> createTestLeads(int count) {
        return IntStream.range(0, count)
            .mapToObj(i -> createTestLead())
            .collect(Collectors.toList());
    }
}
```

### 6. 测试配置和脚本

#### 6.1 Maven测试配置
```xml
<!-- pom.xml - 测试插件配置 -->
<build>
    <plugins>
        <!-- Surefire Plugin - 单元测试 -->
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-surefire-plugin</artifactId>
            <version>3.0.0-M9</version>
            <configuration>
                <includes>
                    <include>**/*Test.java</include>
                    <include>**/*Tests.java</include>
                </includes>
                <excludes>
                    <exclude>**/*IntegrationTest.java</exclude>
                </excludes>
                <argLine>-Xmx1024m</argLine>
                <systemPropertyVariables>
                    <spring.profiles.active>test</spring.profiles.active>
                </systemPropertyVariables>
            </configuration>
        </plugin>
        
        <!-- Failsafe Plugin - 集成测试 -->
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-failsafe-plugin</artifactId>
            <version>3.0.0-M9</version>
            <configuration>
                <includes>
                    <include>**/*IntegrationTest.java</include>
                    <include>**/*IT.java</include>
                </includes>
                <systemPropertyVariables>
                    <spring.profiles.active>test</spring.profiles.active>
                </systemPropertyVariables>
            </configuration>
            <executions>
                <execution>
                    <goals>
                        <goal>integration-test</goal>
                        <goal>verify</goal>
                    </goals>
                </execution>
            </executions>
        </plugin>
        
        <!-- JaCoCo Plugin - 代码覆盖率 -->
        <plugin>
            <groupId>org.jacoco</groupId>
            <artifactId>jacoco-maven-plugin</artifactId>
            <version>0.8.8</version>
            <executions>
                <execution>
                    <goals>
                        <goal>prepare-agent</goal>
                    </goals>
                </execution>
                <execution>
                    <id>report</id>
                    <phase>test</phase>
                    <goals>
                        <goal>report</goal>
                    </goals>
                </execution>
                <execution>
                    <id>check</id>
                    <goals>
                        <goal>check</goal>
                    </goals>
                    <configuration>
                        <rules>
                            <rule>
                                <element>BUNDLE</element>
                                <limits>
                                    <limit>
                                        <counter>LINE</counter>
                                        <value>COVEREDRATIO</value>
                                        <minimum>0.80</minimum>
                                    </limit>
                                </limits>
                            </rule>
                        </rules>
                    </configuration>
                </execution>
            </executions>
        </plugin>
    </plugins>
</build>
```

#### 6.2 测试脚本
```bash
# scripts/run-tests.sh
#!/bin/bash

echo "🧪 运行CRM系统测试套件..."

# 设置测试环境
export SPRING_PROFILES_ACTIVE=test

# 清理之前的测试结果
echo "🧹 清理测试环境..."
mvn clean

# 运行单元测试
echo "🔬 运行单元测试..."
mvn test -Dtest.profile=unit

if [ $? -ne 0 ]; then
    echo "❌ 单元测试失败"
    exit 1
fi

# 运行集成测试
echo "🔗 运行集成测试..."
mvn verify -Dtest.profile=integration

if [ $? -ne 0 ]; then
    echo "❌ 集成测试失败"
    exit 1
fi

# 生成测试报告
echo "📊 生成测试报告..."
mvn jacoco:report

# 检查覆盖率
echo "📈 检查代码覆盖率..."
mvn jacoco:check

echo "✅ 所有测试通过！"
echo "📋 测试报告位置: target/site/jacoco/index.html"
```

### 7. 持续集成配置

#### 7.1 GitHub Actions配置
```yaml
# .github/workflows/test.yml
name: Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      redis:
        image: redis:6.2
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
    
    - name: Install Python dependencies
      run: |
        cd ml-service
        pip install -r requirements.txt
    
    - name: Run unit tests
      run: mvn test
    
    - name: Run integration tests
      run: mvn verify
    
    - name: Generate test report
      run: mvn jacoco:report
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./target/site/jacoco/jacoco.xml
```

这个单元测试实施方案为CRM系统提供了完整的测试策略，覆盖了Repository、Service、Controller各个层级，以及AI功能的测试。接下来我将补充集成测试方案。
