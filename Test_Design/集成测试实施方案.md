# CRM系统集成测试实施方案

## 概述

本文档详细说明CRM系统的集成测试策略，包括API集成测试、微服务间通信测试、数据库集成测试和端到端测试，确保系统各组件协同工作正常。

## 集成测试策略

### 1. 测试层次划分

```
┌─────────────────────────────────────────────────────────────┐
│                     集成测试金字塔                            │
├─────────────────────────────────────────────────────────────┤
│  E2E Tests          │ 端到端业务流程测试                      │
│  (UI + API)         │ - 完整业务场景                         │
├─────────────────────────────────────────────────────────────┤
│  Service Integration│ 微服务间集成测试                        │
│  Tests              │ - 服务间通信                           │
│                     │ - 数据一致性                           │
├─────────────────────────────────────────────────────────────┤
│  API Integration    │ API接口集成测试                        │
│  Tests              │ - 接口功能验证                         │
│                     │ - 数据库交互                           │
├─────────────────────────────────────────────────────────────┤
│  Database           │ 数据访问层集成测试                      │
│  Integration Tests  │ - Repository测试                       │
│                     │ - 事务验证                             │
└─────────────────────────────────────────────────────────────┘
```

### 2. 测试环境配置

#### 2.1 测试容器配置
```java
// src/test/java/com/crm/config/TestContainersConfig.java
@TestConfiguration
public class TestContainersConfig {
    
    @Container
    static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:14")
            .withDatabaseName("crm_test")
            .withUsername("test")
            .withPassword("test")
            .withReuse(true);
    
    @Container
    static GenericContainer<?> redis = new GenericContainer<>("redis:6.2")
            .withExposedPorts(6379)
            .withReuse(true);
    
    @DynamicPropertySource
    static void configureProperties(DynamicPropertyRegistry registry) {
        // 数据库配置
        registry.add("spring.datasource.url", postgres::getJdbcUrl);
        registry.add("spring.datasource.username", postgres::getUsername);
        registry.add("spring.datasource.password", postgres::getPassword);
        
        // Redis配置
        registry.add("spring.redis.host", redis::getHost);
        registry.add("spring.redis.port", () -> redis.getMappedPort(6379));
    }
    
    @Bean
    @Primary
    public RestTemplate testRestTemplate() {
        return new RestTemplate();
    }
}
```

#### 2.2 集成测试基类
```java
// src/test/java/com/crm/common/BaseIntegrationTest.java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@ActiveProfiles("integration-test")
@TestMethodOrder(OrderAnnotation.class)
@Transactional
@Rollback
@Import(TestContainersConfig.class)
public abstract class BaseIntegrationTest {
    
    @Autowired
    protected TestRestTemplate restTemplate;
    
    @Autowired
    protected TestEntityManager entityManager;
    
    @Autowired
    protected JwtTokenProvider jwtTokenProvider;
    
    @LocalServerPort
    protected int port;
    
    protected String adminToken;
    protected String userToken;
    
    @BeforeEach
    void setUpIntegrationTest() {
        // 创建测试用户和Token
        createTestUsers();
        adminToken = createToken("admin", Arrays.asList("ROLE_ADMIN"));
        userToken = createToken("user", Arrays.asList("ROLE_USER"));
    }
    
    protected String getBaseUrl() {
        return "http://localhost:" + port + "/api";
    }
    
    protected HttpHeaders createAuthHeaders(String token) {
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        headers.setBearerAuth(token);
        return headers;
    }
    
    protected HttpHeaders createAdminHeaders() {
        return createAuthHeaders(adminToken);
    }
    
    protected HttpHeaders createUserHeaders() {
        return createAuthHeaders(userToken);
    }
    
    protected String createToken(String username, List<String> roles) {
        UserDetails userDetails = User.builder()
            .username(username)
            .password("password")
            .authorities(roles.stream()
                .map(SimpleGrantedAuthority::new)
                .collect(Collectors.toList()))
            .build();
        return jwtTokenProvider.generateToken(userDetails);
    }
    
    protected void createTestUsers() {
        // 创建测试用户数据
        entityManager.persistAndFlush(TestDataFactory.createAdminUser());
        entityManager.persistAndFlush(TestDataFactory.createNormalUser());
    }
    
    protected <T> ResponseEntity<T> postRequest(String url, Object request, Class<T> responseType, HttpHeaders headers) {
        HttpEntity<Object> entity = new HttpEntity<>(request, headers);
        return restTemplate.postForEntity(getBaseUrl() + url, entity, responseType);
    }
    
    protected <T> ResponseEntity<T> getRequest(String url, Class<T> responseType, HttpHeaders headers) {
        HttpEntity<Void> entity = new HttpEntity<>(headers);
        return restTemplate.exchange(getBaseUrl() + url, HttpMethod.GET, entity, responseType);
    }
    
    protected <T> ResponseEntity<T> putRequest(String url, Object request, Class<T> responseType, HttpHeaders headers) {
        HttpEntity<Object> entity = new HttpEntity<>(request, headers);
        return restTemplate.exchange(getBaseUrl() + url, HttpMethod.PUT, entity, responseType);
    }
    
    protected ResponseEntity<Void> deleteRequest(String url, HttpHeaders headers) {
        HttpEntity<Void> entity = new HttpEntity<>(headers);
        return restTemplate.exchange(getBaseUrl() + url, HttpMethod.DELETE, entity, Void.class);
    }
}
```

## API集成测试

### 1. 认证模块集成测试
```java
// src/test/java/com/crm/integration/AuthIntegrationTest.java
@DisplayName("认证模块集成测试")
class AuthIntegrationTest extends BaseIntegrationTest {
    
    @Test
    @DisplayName("用户登录成功")
    @Order(1)
    void testLogin_Success() {
        // Given
        LoginRequest request = LoginRequest.builder()
            .username("admin")
            .password("admin123")
            .build();
        
        // When
        ResponseEntity<ApiResponse<LoginResponse>> response = postRequest(
            "/auth/login", 
            request, 
            new ParameterizedTypeReference<ApiResponse<LoginResponse>>() {}.getType(),
            new HttpHeaders()
        );
        
        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody().getCode()).isEqualTo(0);
        assertThat(response.getBody().getData().getToken()).isNotBlank();
        assertThat(response.getBody().getData().getUser().getUsername()).isEqualTo("admin");
    }
    
    @Test
    @DisplayName("用户登录失败 - 密码错误")
    @Order(2)
    void testLogin_WrongPassword() {
        // Given
        LoginRequest request = LoginRequest.builder()
            .username("admin")
            .password("wrongpassword")
            .build();
        
        // When
        ResponseEntity<ApiResponse<Object>> response = postRequest(
            "/auth/login", 
            request, 
            new ParameterizedTypeReference<ApiResponse<Object>>() {}.getType(),
            new HttpHeaders()
        );
        
        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.UNAUTHORIZED);
        assertThat(response.getBody().getCode()).isEqualTo(1002);
        assertThat(response.getBody().getMessage()).contains("用户名或密码错误");
    }
    
    @Test
    @DisplayName("获取当前用户信息")
    @Order(3)
    void testGetCurrentUser() {
        // When
        ResponseEntity<ApiResponse<UserResponse>> response = getRequest(
            "/auth/me",
            new ParameterizedTypeReference<ApiResponse<UserResponse>>() {}.getType(),
            createAdminHeaders()
        );
        
        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody().getCode()).isEqualTo(0);
        assertThat(response.getBody().getData().getUsername()).isEqualTo("admin");
    }
    
    @Test
    @DisplayName("Token刷新")
    @Order(4)
    void testRefreshToken() {
        // When
        ResponseEntity<ApiResponse<TokenResponse>> response = postRequest(
            "/auth/refresh",
            null,
            new ParameterizedTypeReference<ApiResponse<TokenResponse>>() {}.getType(),
            createAdminHeaders()
        );
        
        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody().getCode()).isEqualTo(0);
        assertThat(response.getBody().getData().getToken()).isNotBlank();
        assertThat(response.getBody().getData().getExpiresIn()).isGreaterThan(0);
    }
    
    @Test
    @DisplayName("用户登出")
    @Order(5)
    void testLogout() {
        // When
        ResponseEntity<ApiResponse<Object>> response = postRequest(
            "/auth/logout",
            null,
            new ParameterizedTypeReference<ApiResponse<Object>>() {}.getType(),
            createAdminHeaders()
        );
        
        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody().getCode()).isEqualTo(0);
    }
}
```

### 2. 用户管理集成测试
```java
// src/test/java/com/crm/integration/UserManagementIntegrationTest.java
@DisplayName("用户管理集成测试")
class UserManagementIntegrationTest extends BaseIntegrationTest {
    
    @Test
    @DisplayName("创建用户 - 完整流程")
    @Order(1)
    void testCreateUser_FullWorkflow() {
        // Given
        CreateUserRequest request = CreateUserRequest.builder()
            .username("newuser")
            .password("password123")
            .name("新用户")
            .phone("13800138001")
            .departmentId(1L)
            .roleId(2L)
            .build();
        
        // When - 创建用户
        ResponseEntity<ApiResponse<UserResponse>> createResponse = postRequest(
            "/system/users",
            request,
            new ParameterizedTypeReference<ApiResponse<UserResponse>>() {}.getType(),
            createAdminHeaders()
        );
        
        // Then - 验证创建成功
        assertThat(createResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(createResponse.getBody().getCode()).isEqualTo(0);
        
        UserResponse createdUser = createResponse.getBody().getData();
        assertThat(createdUser.getId()).isNotNull();
        assertThat(createdUser.getUsername()).isEqualTo("newuser");
        assertThat(createdUser.getName()).isEqualTo("新用户");
        
        // When - 查询用户详情
        ResponseEntity<ApiResponse<UserResponse>> getResponse = getRequest(
            "/system/users/" + createdUser.getId(),
            new ParameterizedTypeReference<ApiResponse<UserResponse>>() {}.getType(),
            createAdminHeaders()
        );
        
        // Then - 验证查询成功
        assertThat(getResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
        UserResponse retrievedUser = getResponse.getBody().getData();
        assertThat(retrievedUser.getUsername()).isEqualTo("newuser");
        assertThat(retrievedUser.getDepartmentId()).isEqualTo(1L);
        
        // When - 更新用户信息
        UpdateUserRequest updateRequest = UpdateUserRequest.builder()
            .name("更新后的用户")
            .phone("13800138002")
            .build();
        
        ResponseEntity<ApiResponse<UserResponse>> updateResponse = putRequest(
            "/system/users/" + createdUser.getId(),
            updateRequest,
            new ParameterizedTypeReference<ApiResponse<UserResponse>>() {}.getType(),
            createAdminHeaders()
        );
        
        // Then - 验证更新成功
        assertThat(updateResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
        UserResponse updatedUser = updateResponse.getBody().getData();
        assertThat(updatedUser.getName()).isEqualTo("更新后的用户");
        assertThat(updatedUser.getPhone()).isEqualTo("13800138002");
    }
    
    @Test
    @DisplayName("用户列表查询 - 分页和筛选")
    @Order(2)
    void testGetUsers_PaginationAndFilter() {
        // Given - 创建测试数据
        createTestUsersInDatabase();
        
        // When - 分页查询
        String queryUrl = "/system/users?page=0&size=5&departmentId=1&status=1";
        ResponseEntity<ApiResponse<PageResponse<UserResponse>>> response = getRequest(
            queryUrl,
            new ParameterizedTypeReference<ApiResponse<PageResponse<UserResponse>>>() {}.getType(),
            createAdminHeaders()
        );
        
        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        PageResponse<UserResponse> pageData = response.getBody().getData();
        assertThat(pageData.getContent()).hasSizeLessThanOrEqualTo(5);
        assertThat(pageData.getPage()).isEqualTo(0);
        assertThat(pageData.getSize()).isEqualTo(5);
        
        // 验证筛选条件
        pageData.getContent().forEach(user -> {
            assertThat(user.getDepartmentId()).isEqualTo(1L);
            assertThat(user.getStatus()).isEqualTo(1);
        });
    }
    
    @Test
    @DisplayName("用户权限验证 - 非管理员无法创建用户")
    @Order(3)
    void testCreateUser_PermissionDenied() {
        // Given
        CreateUserRequest request = CreateUserRequest.builder()
            .username("unauthorized")
            .password("password123")
            .name("未授权用户")
            .build();
        
        // When - 使用普通用户Token
        ResponseEntity<ApiResponse<Object>> response = postRequest(
            "/system/users",
            request,
            new ParameterizedTypeReference<ApiResponse<Object>>() {}.getType(),
            createUserHeaders()
        );
        
        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.FORBIDDEN);
        assertThat(response.getBody().getCode()).isEqualTo(1003);
    }
    
    private void createTestUsersInDatabase() {
        for (int i = 1; i <= 10; i++) {
            User user = TestDataFactory.createTestUser();
            user.setUsername("testuser" + i);
            user.setDepartmentId(i % 2 == 0 ? 1L : 2L);
            entityManager.persistAndFlush(user);
        }
    }
}
```

### 3. 业务流程集成测试
```java
// src/test/java/com/crm/integration/SalesWorkflowIntegrationTest.java
@DisplayName("销售业务流程集成测试")
class SalesWorkflowIntegrationTest extends BaseIntegrationTest {
    
    @Test
    @DisplayName("完整销售流程 - 线索转客户转订单")
    @Order(1)
    void testCompleteSalesWorkflow() {
        // Step 1: 创建线索
        CreateLeadRequest leadRequest = CreateLeadRequest.builder()
            .name("张三")
            .phone("13800138001")
            .businessType("会计培训")
            .sourceChannel("SEM搜索")
            .intentionLevel(1)
            .build();
        
        ResponseEntity<ApiResponse<LeadResponse>> leadResponse = postRequest(
            "/sales/leads",
            leadRequest,
            new ParameterizedTypeReference<ApiResponse<LeadResponse>>() {}.getType(),
            createUserHeaders()
        );
        
        assertThat(leadResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
        LeadResponse createdLead = leadResponse.getBody().getData();
        
        // Step 2: 添加跟踪记录
        CreateTrackingRequest trackingRequest = CreateTrackingRequest.builder()
            .leadId(createdLead.getId())
            .content("首次电话沟通，客户表示有兴趣")
            .nextFollowTime(LocalDateTime.now().plusDays(3))
            .build();
        
        ResponseEntity<ApiResponse<TrackingResponse>> trackingResponse = postRequest(
            "/sales/leads/" + createdLead.getId() + "/tracking",
            trackingRequest,
            new ParameterizedTypeReference<ApiResponse<TrackingResponse>>() {}.getType(),
            createUserHeaders()
        );
        
        assertThat(trackingResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
        
        // Step 3: 线索转化为客户
        ConvertLeadRequest convertRequest = ConvertLeadRequest.builder()
            .leadId(createdLead.getId())
            .customerType("个人")
            .customerLevel("A")
            .build();
        
        ResponseEntity<ApiResponse<CustomerResponse>> convertResponse = postRequest(
            "/sales/leads/" + createdLead.getId() + "/convert",
            convertRequest,
            new ParameterizedTypeReference<ApiResponse<CustomerResponse>>() {}.getType(),
            createUserHeaders()
        );
        
        assertThat(convertResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
        CustomerResponse createdCustomer = convertResponse.getBody().getData();
        assertThat(createdCustomer.getName()).isEqualTo("张三");
        assertThat(createdCustomer.getPhone()).isEqualTo("13800138001");
        
        // Step 4: 为客户创建订单
        CreateOrderRequest orderRequest = CreateOrderRequest.builder()
            .customerId(createdCustomer.getId())
            .productName("注册会计师培训")
            .quantity(1)
            .unitPrice(new BigDecimal("3980.00"))
            .totalAmount(new BigDecimal("3980.00"))
            .serviceStartDate(LocalDate.now().plusDays(7))
            .serviceEndDate(LocalDate.now().plusDays(37))
            .build();
        
        ResponseEntity<ApiResponse<OrderResponse>> orderResponse = postRequest(
            "/sales/orders",
            orderRequest,
            new ParameterizedTypeReference<ApiResponse<OrderResponse>>() {}.getType(),
            createUserHeaders()
        );
        
        assertThat(orderResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
        OrderResponse createdOrder = orderResponse.getBody().getData();
        assertThat(createdOrder.getCustomerId()).isEqualTo(createdCustomer.getId());
        assertThat(createdOrder.getTotalAmount()).isEqualTo(new BigDecimal("3980.00"));
        
        // Step 5: 添加支付记录
        CreatePaymentRequest paymentRequest = CreatePaymentRequest.builder()
            .orderId(createdOrder.getId())
            .paymentAmount(new BigDecimal("1000.00"))
            .paymentMethod("银行转账")
            .paymentDate(LocalDateTime.now())
            .build();
        
        ResponseEntity<ApiResponse<PaymentResponse>> paymentResponse = postRequest(
            "/sales/orders/" + createdOrder.getId() + "/payments",
            paymentRequest,
            new ParameterizedTypeReference<ApiResponse<PaymentResponse>>() {}.getType(),
            createUserHeaders()
        );
        
        assertThat(paymentResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
        
        // Step 6: 验证订单状态更新
        ResponseEntity<ApiResponse<OrderResponse>> orderDetailResponse = getRequest(
            "/sales/orders/" + createdOrder.getId(),
            new ParameterizedTypeReference<ApiResponse<OrderResponse>>() {}.getType(),
            createUserHeaders()
        );
        
        OrderResponse updatedOrder = orderDetailResponse.getBody().getData();
        assertThat(updatedOrder.getPaymentStatus()).isEqualTo(2); // 部分付款
        assertThat(updatedOrder.getPaidAmount()).isEqualTo(new BigDecimal("1000.00"));
    }
    
    @Test
    @DisplayName("批量操作 - 线索批量分配")
    @Order(2)
    void testBatchAssignLeads() {
        // Given - 创建多个线索
        List<Long> leadIds = new ArrayList<>();
        for (int i = 0; i < 5; i++) {
            CreateLeadRequest request = CreateLeadRequest.builder()
                .name("测试线索" + i)
                .phone("1380013800" + i)
                .businessType("学历提升")
                .sourceChannel("表单填写")
                .build();
            
            ResponseEntity<ApiResponse<LeadResponse>> response = postRequest(
                "/sales/leads",
                request,
                new ParameterizedTypeReference<ApiResponse<LeadResponse>>() {}.getType(),
                createUserHeaders()
            );
            
            leadIds.add(response.getBody().getData().getId());
        }
        
        // When - 批量分配
        BatchAssignRequest batchRequest = BatchAssignRequest.builder()
            .leadIds(leadIds)
            .assignedUserId(2L)
            .build();
        
        ResponseEntity<ApiResponse<BatchOperationResult>> batchResponse = postRequest(
            "/sales/leads/batch-assign",
            batchRequest,
            new ParameterizedTypeReference<ApiResponse<BatchOperationResult>>() {}.getType(),
            createAdminHeaders()
        );
        
        // Then
        assertThat(batchResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
        BatchOperationResult result = batchResponse.getBody().getData();
        assertThat(result.getSuccessCount()).isEqualTo(5);
        assertThat(result.getFailureCount()).isEqualTo(0);
        
        // 验证分配结果
        leadIds.forEach(leadId -> {
            ResponseEntity<ApiResponse<LeadResponse>> leadResponse = getRequest(
                "/sales/leads/" + leadId,
                new ParameterizedTypeReference<ApiResponse<LeadResponse>>() {}.getType(),
                createUserHeaders()
            );
            
            assertThat(leadResponse.getBody().getData().getAssignedUserId()).isEqualTo(2L);
        });
    }
}
```

## 微服务集成测试

### 1. 微服务间通信测试
```java
// src/test/java/com/crm/integration/MicroserviceIntegrationTest.java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@ActiveProfiles("integration-test")
@DisplayName("微服务间通信集成测试")
class MicroserviceIntegrationTest {
    
    @Autowired
    private TestRestTemplate restTemplate;
    
    @LocalServerPort
    private int gatewayPort;
    
    @Container
    static WireMockContainer wiremock = new WireMockContainer("wiremock/wiremock:2.35.0")
            .withMappingFromResource("user-service", "wiremock/user-service.json")
            .withMappingFromResource("sales-service", "wiremock/sales-service.json");
    
    @DynamicPropertySource
    static void configureProperties(DynamicPropertyRegistry registry) {
        registry.add("services.user-service.url", 
            () -> "http://localhost:" + wiremock.getMappedPort(8080));
        registry.add("services.sales-service.url", 
            () -> "http://localhost:" + wiremock.getMappedPort(8080));
    }
    
    @Test
    @DisplayName("API网关路由测试")
    void testGatewayRouting() {
        // Given
        String gatewayUrl = "http://localhost:" + gatewayPort;
        
        // When - 测试用户服务路由
        ResponseEntity<String> userResponse = restTemplate.getForEntity(
            gatewayUrl + "/api/system/users/1", String.class);
        
        // Then
        assertThat(userResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
        
        // When - 测试销售服务路由
        ResponseEntity<String> salesResponse = restTemplate.getForEntity(
            gatewayUrl + "/api/sales/leads", String.class);
        
        // Then
        assertThat(salesResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
    }
    
    @Test
    @DisplayName("服务间调用测试")
    void testServiceToServiceCommunication() {
        // Given - Mock用户服务返回
        wiremock.stubFor(get(urlEqualTo("/api/users/1"))
            .willReturn(aResponse()
                .withStatus(200)
                .withHeader("Content-Type", "application/json")
                .withBody("""
                    {
                        "code": 0,
                        "data": {
                            "id": 1,
                            "username": "testuser",
                            "name": "测试用户",
                            "departmentId": 1
                        }
                    }
                    """)));
        
        // When - 销售服务调用用户服务
        CreateLeadRequest request = CreateLeadRequest.builder()
            .name("测试线索")
            .phone("13800138001")
            .assignedUserId(1L)
            .build();
        
        ResponseEntity<ApiResponse<LeadResponse>> response = restTemplate.postForEntity(
            "http://localhost:" + gatewayPort + "/api/sales/leads",
            request,
            new ParameterizedTypeReference<ApiResponse<LeadResponse>>() {}.getType()
        );
        
        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody().getData().getAssignedUserId()).isEqualTo(1L);
        
        // 验证服务间调用
        wiremock.verify(getRequestedFor(urlEqualTo("/api/users/1")));
    }
    
    @Test
    @DisplayName("断路器测试")
    void testCircuitBreaker() {
        // Given - Mock服务故障
        wiremock.stubFor(get(urlEqualTo("/api/users/1"))
            .willReturn(aResponse()
                .withStatus(500)
                .withFixedDelay(3000))); // 3秒延迟
        
        // When - 多次调用触发断路器
        for (int i = 0; i < 5; i++) {
            try {
                restTemplate.getForEntity(
                    "http://localhost:" + gatewayPort + "/api/system/users/1",
                    String.class);
            } catch (Exception e) {
                // 忽略异常
            }
        }
        
        // Then - 验证断路器开启后的降级响应
        ResponseEntity<String> response = restTemplate.getForEntity(
            "http://localhost:" + gatewayPort + "/api/system/users/1",
            String.class);
        
        // 根据实际断路器配置验证响应
        assertThat(response.getStatusCode()).isIn(
            HttpStatus.SERVICE_UNAVAILABLE, 
            HttpStatus.TOO_MANY_REQUESTS
        );
    }
}
```

### 2. 事务集成测试
```java
// src/test/java/com/crm/integration/TransactionIntegrationTest.java
@DisplayName("事务集成测试")
class TransactionIntegrationTest extends BaseIntegrationTest {
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private LeadService leadService;
    
    @Autowired
    private CustomerService customerService;
    
    @Test
    @DisplayName("分布式事务 - 线索转客户事务测试")
    void testLeadToCustomerTransaction() {
        // Given
        Lead lead = TestDataFactory.createTestLead();
        entityManager.persistAndFlush(lead);
        
        ConvertLeadRequest request = ConvertLeadRequest.builder()
            .leadId(lead.getId())
            .customerType("企业")
            .customerLevel("A")
            .build();
        
        // When
        assertThatCode(() -> {
            Customer customer = customerService.convertFromLead(request);
            assertThat(customer).isNotNull();
            
            // 验证事务后的状态
            Lead updatedLead = entityManager.find(Lead.class, lead.getId());
            assertThat(updatedLead.getStatus()).isEqualTo(3); // 已转化
            
            Customer createdCustomer = entityManager.find(Customer.class, customer.getId());
            assertThat(createdCustomer).isNotNull();
            assertThat(createdCustomer.getSourceLeadId()).isEqualTo(lead.getId());
        }).doesNotThrowAnyException();
    }
    
    @Test
    @DisplayName("事务回滚测试 - 数据完整性约束违反")
    void testTransactionRollback() {
        // Given - 创建重复用户名的请求
        CreateUserRequest request1 = CreateUserRequest.builder()
            .username("duplicate")
            .password("password123")
            .name("用户1")
            .build();
        
        CreateUserRequest request2 = CreateUserRequest.builder()
            .username("duplicate") // 相同用户名
            .password("password456")
            .name("用户2")
            .build();
        
        // When - 第一个用户创建成功
        assertThatCode(() -> userService.createUser(request1))
            .doesNotThrowAnyException();
        
        // When - 第二个用户创建失败，触发回滚
        assertThatThrownBy(() -> userService.createUser(request2))
            .isInstanceOf(BusinessException.class)
            .hasMessageContaining("用户名已存在");
        
        // Then - 验证只有一个用户存在
        List<User> users = entityManager.getEntityManager()
            .createQuery("SELECT u FROM User u WHERE u.username = :username", User.class)
            .setParameter("username", "duplicate")
            .getResultList();
        
        assertThat(users).hasSize(1);
        assertThat(users.get(0).getName()).isEqualTo("用户1");
    }
    
    @Test
    @DisplayName("批量操作事务测试")
    void testBatchOperationTransaction() {
        // Given
        List<CreateUserRequest> requests = Arrays.asList(
            CreateUserRequest.builder().username("batch1").name("批量用户1").password("pass").build(),
            CreateUserRequest.builder().username("batch2").name("批量用户2").password("pass").build(),
            CreateUserRequest.builder().username("batch3").name("批量用户3").password("pass").build(),
            CreateUserRequest.builder().username("admin").name("重复用户名").password("pass").build() // 会失败
        );
        
        // When - 批量创建用户，其中一个失败
        assertThatThrownBy(() -> userService.batchCreateUsers(requests))
            .isInstanceOf(BusinessException.class);
        
        // Then - 验证所有操作都被回滚
        requests.forEach(request -> {
            if (!request.getUsername().equals("admin")) {
                List<User> users = entityManager.getEntityManager()
                    .createQuery("SELECT u FROM User u WHERE u.username = :username", User.class)
                    .setParameter("username", request.getUsername())
                    .getResultList();
                assertThat(users).isEmpty();
            }
        });
    }
}
```

## 数据库集成测试

### 1. Repository集成测试
```java
// src/test/java/com/crm/integration/RepositoryIntegrationTest.java
@DataJpaTest
@DisplayName("Repository集成测试")
@Import(TestContainersConfig.class)
class RepositoryIntegrationTest {
    
    @Autowired
    private TestEntityManager entityManager;
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private LeadRepository leadRepository;
    
    @Autowired
    private CustomerRepository customerRepository;
    
    @Test
    @DisplayName("复杂查询测试 - 用户销售业绩统计")
    void testComplexQuery_UserSalesStatistics() {
        // Given - 创建测试数据
        User user = TestDataFactory.createTestUser();
        entityManager.persistAndFlush(user);
        
        Customer customer1 = TestDataFactory.createTestCustomer();
        customer1.setAssignedUserId(user.getId());
        entityManager.persistAndFlush(customer1);
        
        Customer customer2 = TestDataFactory.createTestCustomer();
        customer2.setAssignedUserId(user.getId());
        entityManager.persistAndFlush(customer2);
        
        Order order1 = TestDataFactory.createTestOrder();
        order1.setCustomerId(customer1.getId());
        order1.setAssignedUserId(user.getId());
        order1.setTotalAmount(new BigDecimal("5000.00"));
        order1.setStatus(5); // 已完成
        entityManager.persistAndFlush(order1);
        
        Order order2 = TestDataFactory.createTestOrder();
        order2.setCustomerId(customer2.getId());
        order2.setAssignedUserId(user.getId());
        order2.setTotalAmount(new BigDecimal("3000.00"));
        order2.setStatus(5); // 已完成
        entityManager.persistAndFlush(order2);
        
        // When - 执行复杂查询
        List<Object[]> results = entityManager.getEntityManager()
            .createNativeQuery("""
                SELECT 
                    u.id,
                    u.name,
                    COUNT(DISTINCT c.id) as customer_count,
                    COUNT(DISTINCT o.id) as order_count,
                    COALESCE(SUM(o.total_amount), 0) as total_amount
                FROM users u
                LEFT JOIN customers c ON c.assigned_user_id = u.id AND c.status = 1
                LEFT JOIN orders o ON o.assigned_user_id = u.id AND o.status = 5
                WHERE u.id = :userId
                GROUP BY u.id, u.name
                """)
            .setParameter("userId", user.getId())
            .getResultList();
        
        // Then
        assertThat(results).hasSize(1);
        Object[] result = results.get(0);
        assertThat(result[0]).isEqualTo(user.getId());
        assertThat(result[1]).isEqualTo(user.getName());
        assertThat(((Number) result[2]).intValue()).isEqualTo(2); // 客户数
        assertThat(((Number) result[3]).intValue()).isEqualTo(2); // 订单数
        assertThat(((Number) result[4]).doubleValue()).isEqualTo(8000.0); // 总金额
    }
    
    @Test
    @DisplayName("分页查询性能测试")
    void testPaginationPerformance() {
        // Given - 创建大量测试数据
        List<Lead> leads = new ArrayList<>();
        for (int i = 0; i < 1000; i++) {
            Lead lead = TestDataFactory.createTestLead();
            lead.setName("测试线索" + i);
            leads.add(lead);
            
            if (i % 100 == 0) {
                leads.forEach(entityManager::persist);
                entityManager.flush();
                entityManager.clear();
                leads.clear();
            }
        }
        
        // When - 执行分页查询
        long startTime = System.currentTimeMillis();
        
        Pageable pageable = PageRequest.of(10, 20, Sort.by("createdAt").descending());
        Page<Lead> page = leadRepository.findByStatus(1, pageable);
        
        long endTime = System.currentTimeMillis();
        
        // Then
        assertThat(page.getContent()).hasSize(20);
        assertThat(page.getTotalElements()).isEqualTo(1000);
        assertThat(endTime - startTime).isLessThan(1000); // 查询时间小于1秒
    }
    
    @Test
    @DisplayName("数据库约束测试")
    void testDatabaseConstraints() {
        // Test 1: 唯一约束
        User user1 = TestDataFactory.createTestUser();
        user1.setUsername("unique_user");
        entityManager.persistAndFlush(user1);
        
        User user2 = TestDataFactory.createTestUser();
        user2.setUsername("unique_user"); // 相同用户名
        
        assertThatThrownBy(() -> {
            entityManager.persistAndFlush(user2);
        }).isInstanceOf(Exception.class);
        
        // Test 2: 非空约束
        User user3 = TestDataFactory.createTestUser();
        user3.setUsername(null); // 用户名为空
        
        assertThatThrownBy(() -> {
            entityManager.persistAndFlush(user3);
        }).isInstanceOf(Exception.class);
    }
    
    @Test
    @DisplayName("级联操作测试")
    void testCascadeOperations() {
        // Given
        Customer customer = TestDataFactory.createTestCustomer();
        entityManager.persistAndFlush(customer);
        
        Order order1 = TestDataFactory.createTestOrder();
        order1.setCustomerId(customer.getId());
        entityManager.persistAndFlush(order1);
        
        Order order2 = TestDataFactory.createTestOrder();
        order2.setCustomerId(customer.getId());
        entityManager.persistAndFlush(order2);
        
        // When - 删除客户
        customer.setStatus(0); // 软删除
        entityManager.persistAndFlush(customer);
        
        // Then - 验证关联订单状态
        List<Order> orders = entityManager.getEntityManager()
            .createQuery("SELECT o FROM Order o WHERE o.customerId = :customerId", Order.class)
            .setParameter("customerId", customer.getId())
            .getResultList();
        
        // 根据业务逻辑验证级联效果
        assertThat(orders).hasSize(2);
        // 可以添加更多验证逻辑
    }
}
```

## 端到端测试

### 1. 业务场景E2E测试
```java
// src/test/java/com/crm/e2e/SalesProcessE2ETest.java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@ActiveProfiles("e2e-test")
@DisplayName("销售流程端到端测试")
class SalesProcessE2ETest extends BaseIntegrationTest {
    
    @Test
    @DisplayName("完整销售流程E2E测试")
    void testCompleteSalesProcessE2E() {
        // 模拟完整的销售业务流程
        
        // Step 1: 管理员创建销售员账户
        CreateUserRequest salesUserRequest = CreateUserRequest.builder()
            .username("salesperson")
            .password("password123")
            .name("销售员张三")
            .departmentId(2L) // 销售部
            .roleId(3L) // 销售员角色
            .build();
        
        ResponseEntity<ApiResponse<UserResponse>> userResponse = postRequest(
            "/system/users",
            salesUserRequest,
            new ParameterizedTypeReference<ApiResponse<UserResponse>>() {}.getType(),
            createAdminHeaders()
        );
        
        assertThat(userResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
        UserResponse salesperson = userResponse.getBody().getData();
        
        // Step 2: 销售员登录系统
        LoginRequest loginRequest = LoginRequest.builder()
            .username("salesperson")
            .password("password123")
            .build();
        
        ResponseEntity<ApiResponse<LoginResponse>> loginResponse = postRequest(
            "/auth/login",
            loginRequest,
            new ParameterizedTypeReference<ApiResponse<LoginResponse>>() {}.getType(),
            new HttpHeaders()
        );
        
        String salesToken = loginResponse.getBody().getData().getToken();
        HttpHeaders salesHeaders = createAuthHeaders(salesToken);
        
        // Step 3: 销售员录入线索
        CreateLeadRequest leadRequest = CreateLeadRequest.builder()
            .name("李四")
            .phone("13800138888")
            .businessType("注册会计师培训")
            .sourceChannel("SEM搜索")
            .intentionLevel(1)
            .remark("通过百度搜索找到我们，对CPA课程很感兴趣")
            .build();
        
        ResponseEntity<ApiResponse<LeadResponse>> leadResponse = postRequest(
            "/sales/leads",
            leadRequest,
            new ParameterizedTypeReference<ApiResponse<LeadResponse>>() {}.getType(),
            salesHeaders
        );
        
        LeadResponse lead = leadResponse.getBody().getData();
        
        // Step 4: 销售员添加多次跟踪记录
        for (int i = 1; i <= 3; i++) {
            CreateTrackingRequest trackingRequest = CreateTrackingRequest.builder()
                .leadId(lead.getId())
                .content("第" + i + "次跟踪：客户咨询课程详情和价格")
                .nextFollowTime(LocalDateTime.now().plusDays(i * 2))
                .build();
            
            postRequest(
                "/sales/leads/" + lead.getId() + "/tracking",
                trackingRequest,
                new ParameterizedTypeReference<ApiResponse<TrackingResponse>>() {}.getType(),
                salesHeaders
            );
        }
        
        // Step 5: 销售员将线索转化为客户
        ConvertLeadRequest convertRequest = ConvertLeadRequest.builder()
            .leadId(lead.getId())
            .customerType("个人")
            .customerLevel("A")
            .build();
        
        ResponseEntity<ApiResponse<CustomerResponse>> customerResponse = postRequest(
            "/sales/leads/" + lead.getId() + "/convert",
            convertRequest,
            new ParameterizedTypeReference<ApiResponse<CustomerResponse>>() {}.getType(),
            salesHeaders
        );
        
        CustomerResponse customer = customerResponse.getBody().getData();
        
        // Step 6: 销售员为客户创建订单
        CreateOrderRequest orderRequest = CreateOrderRequest.builder()
            .customerId(customer.getId())
            .productName("注册会计师全科班")
            .quantity(1)
            .unitPrice(new BigDecimal("4980.00"))
            .totalAmount(new BigDecimal("4980.00"))
            .serviceStartDate(LocalDate.now().plusDays(14))
            .serviceEndDate(LocalDate.now().plusDays(74))
            .remark("客户要求14天后开课")
            .build();
        
        ResponseEntity<ApiResponse<OrderResponse>> orderResponse = postRequest(
            "/sales/orders",
            orderRequest,
            new ParameterizedTypeReference<ApiResponse<OrderResponse>>() {}.getType(),
            salesHeaders
        );
        
        OrderResponse order = orderResponse.getBody().getData();
        
        // Step 7: 客户分期付款
        // 第一期付款
        CreatePaymentRequest payment1 = CreatePaymentRequest.builder()
            .orderId(order.getId())
            .paymentAmount(new BigDecimal("2000.00"))
            .paymentMethod("银行转账")
            .paymentDate(LocalDateTime.now())
            .remark("首期付款")
            .build();
        
        postRequest(
            "/sales/orders/" + order.getId() + "/payments",
            payment1,
            new ParameterizedTypeReference<ApiResponse<PaymentResponse>>() {}.getType(),
            salesHeaders
        );
        
        // 第二期付款
        CreatePaymentRequest payment2 = CreatePaymentRequest.builder()
            .orderId(order.getId())
            .paymentAmount(new BigDecimal("2980.00"))
            .paymentMethod("支付宝")
            .paymentDate(LocalDateTime.now().plusDays(7))
            .remark("尾款付清")
            .build();
        
        postRequest(
            "/sales/orders/" + order.getId() + "/payments",
            payment2,
            new ParameterizedTypeReference<ApiResponse<PaymentResponse>>() {}.getType(),
            salesHeaders
        );
        
        // Step 8: 验证最终状态
        ResponseEntity<ApiResponse<OrderResponse>> finalOrderResponse = getRequest(
            "/sales/orders/" + order.getId(),
            new ParameterizedTypeReference<ApiResponse<OrderResponse>>() {}.getType(),
            salesHeaders
        );
        
        OrderResponse finalOrder = finalOrderResponse.getBody().getData();
        assertThat(finalOrder.getPaymentStatus()).isEqualTo(3); // 已支付
        assertThat(finalOrder.getPaidAmount()).isEqualTo(new BigDecimal("4980.00"));
        
        // Step 9: 验证业务数据一致性
        // 验证线索状态已更新
        ResponseEntity<ApiResponse<LeadResponse>> finalLeadResponse = getRequest(
            "/sales/leads/" + lead.getId(),
            new ParameterizedTypeReference<ApiResponse<LeadResponse>>() {}.getType(),
            salesHeaders
        );
        assertThat(finalLeadResponse.getBody().getData().getStatus()).isEqualTo(3); // 已转化
        
        // 验证客户信息
        ResponseEntity<ApiResponse<CustomerResponse>> finalCustomerResponse = getRequest(
            "/sales/customers/" + customer.getId(),
            new ParameterizedTypeReference<ApiResponse<CustomerResponse>>() {}.getType(),
            salesHeaders
        );
        CustomerResponse finalCustomer = finalCustomerResponse.getBody().getData();
        assertThat(finalCustomer.getStatus()).isEqualTo(3); // 已成单
        assertThat(finalCustomer.getTotalOrderAmount()).isEqualTo(new BigDecimal("4980.00"));
    }
    
    @Test
    @DisplayName("权限控制E2E测试")
    void testPermissionControlE2E() {
        // 创建不同角色的用户
        
        // 销售员
        User salesperson = TestDataFactory.createTestUser();
        salesperson.setUsername("sales_user");
        salesperson.setRoleId(3L); // 销售员角色
        entityManager.persistAndFlush(salesperson);
        
        // 营销员
        User marketer = TestDataFactory.createTestUser();
        marketer.setUsername("marketing_user");
        marketer.setRoleId(5L); // 营销员角色
        entityManager.persistAndFlush(marketer);
        
        String salesToken = createToken("sales_user", Arrays.asList("ROLE_SALES"));
        String marketingToken = createToken("marketing_user", Arrays.asList("ROLE_MARKETING"));
        
        // 测试销售员权限
        // 销售员可以创建线索
        CreateLeadRequest leadRequest = CreateLeadRequest.builder()
            .name("测试线索")
            .phone("13800138000")
            .businessType("会计培训")
            .build();
        
        ResponseEntity<ApiResponse<LeadResponse>> salesLeadResponse = postRequest(
            "/sales/leads",
            leadRequest,
            new ParameterizedTypeReference<ApiResponse<LeadResponse>>() {}.getType(),
            createAuthHeaders(salesToken)
        );
        assertThat(salesLeadResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
        
        // 销售员不能创建用户
        CreateUserRequest userRequest = CreateUserRequest.builder()
            .username("new_user")
            .password("password")
            .name("新用户")
            .build();
        
        ResponseEntity<ApiResponse<Object>> salesUserResponse = postRequest(
            "/system/users",
            userRequest,
            new ParameterizedTypeReference<ApiResponse<Object>>() {}.getType(),
            createAuthHeaders(salesToken)
        );
        assertThat(salesUserResponse.getStatusCode()).isEqualTo(HttpStatus.FORBIDDEN);
        
        // 营销员可以创建活动
        CreateCampaignRequest campaignRequest = CreateCampaignRequest.builder()
            .name("测试活动")
            .startDate(LocalDate.now())
            .endDate(LocalDate.now().plusDays(30))
            .budget(new BigDecimal("10000.00"))
            .build();
        
        ResponseEntity<ApiResponse<CampaignResponse>> campaignResponse = postRequest(
            "/marketing/campaigns",
            campaignRequest,
            new ParameterizedTypeReference<ApiResponse<CampaignResponse>>() {}.getType(),
            createAuthHeaders(marketingToken)
        );
        assertThat(campaignResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
        
        // 营销员不能查看销售数据（根据具体权限配置）
        ResponseEntity<ApiResponse<Object>> marketingOrderResponse = getRequest(
            "/sales/orders",
            new ParameterizedTypeReference<ApiResponse<Object>>() {}.getType(),
            createAuthHeaders(marketingToken)
        );
        assertThat(marketingOrderResponse.getStatusCode()).isEqualTo(HttpStatus.FORBIDDEN);
    }
}
```

### 2. 性能集成测试
```java
// src/test/java/com/crm/e2e/PerformanceIntegrationTest.java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@ActiveProfiles("performance-test")
@DisplayName("性能集成测试")
class PerformanceIntegrationTest extends BaseIntegrationTest {
    
    @Test
    @DisplayName("并发用户登录测试")
    void testConcurrentUserLogin() throws InterruptedException {
        int threadCount = 10;
        int requestsPerThread = 5;
        CountDownLatch latch = new CountDownLatch(threadCount);
        AtomicInteger successCount = new AtomicInteger(0);
        AtomicInteger failureCount = new AtomicInteger(0);
        
        ExecutorService executor = Executors.newFixedThreadPool(threadCount);
        
        for (int i = 0; i < threadCount; i++) {
            final int threadIndex = i;
            executor.submit(() -> {
                try {
                    for (int j = 0; j < requestsPerThread; j++) {
                        LoginRequest request = LoginRequest.builder()
                            .username("admin")
                            .password("admin123")
                            .build();
                        
                        long startTime = System.currentTimeMillis();
                        
                        ResponseEntity<ApiResponse<LoginResponse>> response = postRequest(
                            "/auth/login",
                            request,
                            new ParameterizedTypeReference<ApiResponse<LoginResponse>>() {}.getType(),
                            new HttpHeaders()
                        );
                        
                        long endTime = System.currentTimeMillis();
                        long responseTime = endTime - startTime;
                        
                        if (response.getStatusCode() == HttpStatus.OK && responseTime < 2000) {
                            successCount.incrementAndGet();
                        } else {
                            failureCount.incrementAndGet();
                        }
                        
                        Thread.sleep(100); // 模拟真实间隔
                    }
                } catch (Exception e) {
                    failureCount.incrementAndGet();
                } finally {
                    latch.countDown();
                }
            });
        }
        
        latch.await(30, TimeUnit.SECONDS);
        executor.shutdown();
        
        // 验证结果
        int totalRequests = threadCount * requestsPerThread;
        assertThat(successCount.get()).isGreaterThan(totalRequests * 0.95); // 95%成功率
        assertThat(failureCount.get()).isLessThan(totalRequests * 0.05);
    }
    
    @Test
    @DisplayName("大量数据查询性能测试")
    void testLargeDataQueryPerformance() {
        // Given - 创建大量测试数据
        createLargeTestDataSet();
        
        // When - 执行查询
        long startTime = System.currentTimeMillis();
        
        ResponseEntity<ApiResponse<PageResponse<LeadResponse>>> response = getRequest(
            "/sales/leads?page=0&size=50&businessType=会计培训",
            new ParameterizedTypeReference<ApiResponse<PageResponse<LeadResponse>>>() {}.getType(),
            createUserHeaders()
        );
        
        long endTime = System.currentTimeMillis();
        long responseTime = endTime - startTime;
        
        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(responseTime).isLessThan(1000); // 响应时间小于1秒
        assertThat(response.getBody().getData().getContent()).hasSize(50);
    }
    
    private void createLargeTestDataSet() {
        // 批量创建10000条线索数据
        for (int batch = 0; batch < 100; batch++) {
            List<Lead> leads = new ArrayList<>();
            for (int i = 0; i < 100; i++) {
                Lead lead = TestDataFactory.createTestLead();
                lead.setName("测试线索" + (batch * 100 + i));
                lead.setBusinessType(i % 3 == 0 ? "会计培训" : "学历提升");
                leads.add(lead);
            }
            
            leads.forEach(entityManager::persist);
            entityManager.flush();
            entityManager.clear();
        }
    }
}
```

## 测试执行和报告

### 1. 测试执行脚本
```bash
# scripts/run-integration-tests.sh
#!/bin/bash

echo "🔗 运行CRM系统集成测试..."

# 设置测试环境
export SPRING_PROFILES_ACTIVE=integration-test
export TESTCONTAINERS_REUSE_ENABLE=true

# 启动必要的服务
echo "🚀 启动测试服务..."
docker-compose -f docker-compose.test.yml up -d redis postgres

# 等待服务启动
sleep 10

# 运行集成测试
echo "🧪 执行集成测试..."
mvn verify -Dtest.profile=integration -DskipUnitTests=true

# 运行E2E测试
echo "🎭 执行端到端测试..."
mvn verify -Dtest.profile=e2e -DskipUnitTests=true

# 生成测试报告
echo "📊 生成集成测试报告..."
mvn jacoco:report-integration

# 清理测试环境
echo "🧹 清理测试环境..."
docker-compose -f docker-compose.test.yml down

echo "✅ 集成测试完成！"
```

### 2. 持续集成配置
```yaml
# .github/workflows/integration-test.yml
name: Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  integration-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
    
    - name: Run integration tests
      run: |
        mvn verify -Dtest.profile=integration
        mvn verify -Dtest.profile=e2e
    
    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results
        path: target/surefire-reports/
```

这个集成测试实施方案为CRM系统提供了全面的集成测试策略，包括API集成测试、微服务间通信测试、数据库集成测试和端到端测试，确保系统各组件能够正确协同工作。接下来我将创建测试数据准备脚本。
