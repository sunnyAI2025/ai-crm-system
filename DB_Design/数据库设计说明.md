# CRM系统数据库设计说明文档

## 概述

本文档详细说明了CRM系统的数据库设计，包括表结构、字段定义、索引配置和数据关系。

## 设计原则

### 1. 基础规范
- **数据库类型**: PostgreSQL (Neon云数据库)
- **字符集**: UTF-8
- **主键**: 所有表使用`id`字段作为主键，BIGSERIAL类型，自增
- **时间字段**: 统一使用`created_at`和`updated_at`
- **状态字段**: 使用`status`字段，1表示正常，0表示禁用/删除
- **外键约束**: 不使用物理外键，应用层维护数据一致性

### 2. 命名规范
- **表名**: 使用复数形式，全小写，单词间用下划线分隔
- **字段名**: 全小写，单词间用下划线分隔
- **索引名**: `idx_表名_字段名`格式

### 3. 数据类型规范
- **主键**: BIGSERIAL
- **时间**: TIMESTAMP
- **状态**: SMALLINT
- **金额**: DECIMAL(12,2)
- **文本**: VARCHAR(长度) 或 TEXT
- **JSON**: TEXT类型存储JSON字符串

## 数据库表结构

### 1. 系统管理模块

#### 1.1 departments (部门表)
管理组织架构和部门层级关系。

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | BIGSERIAL | - | 是 | 自增 | 主键 |
| name | VARCHAR | 100 | 是 | - | 部门名称 |
| description | TEXT | - | 否 | - | 部门描述 |
| parent_id | BIGINT | - | 否 | 0 | 上级部门ID，0表示顶级部门 |
| manager_id | BIGINT | - | 否 | - | 部门负责人ID |
| creator_id | BIGINT | - | 否 | - | 创建人ID |
| status | SMALLINT | - | 否 | 1 | 状态：1-正常，0-停用 |
| created_at | TIMESTAMP | - | 否 | NOW() | 创建时间 |
| updated_at | TIMESTAMP | - | 否 | NOW() | 更新时间 |

**业务关系:**
- 支持多级部门层级结构
- 每个部门可以有一个负责人
- 支持部门的启用/停用状态管理

#### 1.2 roles (角色表)
定义系统中的各种角色和权限配置。

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | BIGSERIAL | - | 是 | 自增 | 主键 |
| name | VARCHAR | 50 | 是 | - | 角色名称 |
| description | TEXT | - | 否 | - | 角色描述 |
| department_id | BIGINT | - | 否 | - | 所属部门ID |
| permissions | TEXT | - | 否 | - | 权限配置，JSON格式 |
| status | SMALLINT | - | 否 | 1 | 状态：1-启用，0-停用 |
| creator_id | BIGINT | - | 否 | - | 创建人ID |
| created_at | TIMESTAMP | - | 否 | NOW() | 创建时间 |
| updated_at | TIMESTAMP | - | 否 | NOW() | 更新时间 |

**权限配置JSON格式示例:**
```json
{
  "dashboard": {"view": true},
  "sales": {
    "leads": {"view": true, "create": true, "edit": true, "delete": false},
    "customers": {"view": true, "create": true, "edit": true, "delete": false},
    "orders": {"view": true, "create": true, "edit": true, "delete": false}
  },
  "marketing": {
    "campaigns": {"view": true, "create": false, "edit": false, "delete": false}
  },
  "system": {
    "users": {"view": false, "create": false, "edit": false, "delete": false},
    "roles": {"view": false, "create": false, "edit": false, "delete": false}
  }
}
```

#### 1.3 users (用户表)
存储系统用户的基本信息和认证数据。

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | BIGSERIAL | - | 是 | 自增 | 主键 |
| username | VARCHAR | 50 | 是 | - | 登录账号，唯一 |
| password | VARCHAR | 255 | 是 | - | 密码(BCrypt加密) |
| name | VARCHAR | 100 | 是 | - | 真实姓名 |
| phone | VARCHAR | 20 | 否 | - | 手机号 |
| avatar | VARCHAR | 255 | 否 | - | 头像URL |
| description | TEXT | - | 否 | - | 个人简介 |
| department_id | BIGINT | - | 否 | - | 所属部门ID |
| role_id | BIGINT | - | 否 | - | 角色ID |
| last_login_time | TIMESTAMP | - | 否 | - | 最后登录时间 |
| login_count | INT | - | 否 | 0 | 登录次数 |
| online_hours | INT | - | 否 | 0 | 在线时长(小时) |
| status | SMALLINT | - | 否 | 1 | 状态：1-正常，0-停用 |
| creator_id | BIGINT | - | 否 | - | 创建人ID |
| created_at | TIMESTAMP | - | 否 | NOW() | 创建时间 |
| updated_at | TIMESTAMP | - | 否 | NOW() | 更新时间 |

**业务关系:**
- 一个用户只能属于一个部门
- 一个用户只能有一个角色
- 支持用户状态管理和登录统计

### 2. 销售管理模块

#### 2.1 leads (线索表)
管理销售线索的完整生命周期。

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | BIGSERIAL | - | 是 | 自增 | 主键 |
| name | VARCHAR | 100 | 是 | - | 客户姓名 |
| phone | VARCHAR | 20 | 是 | - | 联系电话 |
| business_type | VARCHAR | 50 | 否 | - | 业务类型(专业) |
| source_channel | VARCHAR | 50 | 否 | - | 数据来源渠道 |
| source_type | SMALLINT | - | 否 | - | 渠道类型：1-付费，0-免费 |
| campaign_id | BIGINT | - | 否 | - | 关联推广活动ID |
| assigned_user_id | BIGINT | - | 否 | - | 分配给的销售人员ID |
| assigned_time | TIMESTAMP | - | 否 | - | 分配时间 |
| intention_level | SMALLINT | - | 否 | - | 意向度：1-高，2-中，3-低 |
| follow_status | SMALLINT | - | 否 | 1 | 跟进状态：1-待跟进，2-跟进中，3-已转化，4-无效 |
| is_converted | SMALLINT | - | 否 | 0 | 是否已转化：1-是，0-否 |
| converted_time | TIMESTAMP | - | 否 | - | 转化时间 |
| converted_customer_id | BIGINT | - | 否 | - | 转化后的客户ID |
| creator_id | BIGINT | - | 否 | - | 创建人ID |
| status | SMALLINT | - | 否 | 1 | 状态：1-正常，0-删除 |
| created_at | TIMESTAMP | - | 否 | NOW() | 创建时间 |
| updated_at | TIMESTAMP | - | 否 | NOW() | 更新时间 |

**业务规则:**
- 线索可以来自多个渠道：SEM搜索、表单填写、海报活动、电话咨询
- 线索转化为客户后，记录转化关系
- 支持线索的分配和重新分配
- 跟踪线索的完整跟进过程

#### 2.2 customers (客户表)
管理正式客户信息和服务状态。

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | BIGSERIAL | - | 是 | 自增 | 主键 |
| name | VARCHAR | 100 | 是 | - | 客户姓名 |
| phone | VARCHAR | 20 | 是 | - | 联系电话 |
| business_type | VARCHAR | 50 | 否 | - | 业务类型 |
| source_channel | VARCHAR | 50 | 否 | - | 来源渠道 |
| source_lead_id | BIGINT | - | 否 | - | 来源线索ID |
| assigned_user_id | BIGINT | - | 否 | - | 负责销售人员ID |
| customer_level | SMALLINT | - | 否 | 1 | 客户等级：1-5星级 |
| customer_status | SMALLINT | - | 否 | 1 | 客户状态：1-潜在，2-跟进中，3-已成单，4-流失 |
| next_visit_time | TIMESTAMP | - | 否 | - | 下次回访时间 |
| total_order_amount | DECIMAL | 12,2 | 否 | 0 | 累计成单金额 |
| order_count | INT | - | 否 | 0 | 成单次数 |
| creator_id | BIGINT | - | 否 | - | 创建人ID |
| status | SMALLINT | - | 否 | 1 | 状态：1-正常，0-删除 |
| created_at | TIMESTAMP | - | 否 | NOW() | 创建时间 |
| updated_at | TIMESTAMP | - | 否 | NOW() | 更新时间 |

**业务关系:**
- 客户与线索：多对一关系（多个线索可以转化为一个客户）
- 客户与订单：一对多关系（一个客户可以有多个订单）
- 客户信息具有唯一性，避免重复

#### 2.3 orders (订单表)
管理客户订单和交易信息。

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | BIGSERIAL | - | 是 | 自增 | 主键 |
| order_no | VARCHAR | 50 | 是 | - | 订单号，唯一 |
| customer_id | BIGINT | - | 是 | - | 客户ID |
| total_amount | DECIMAL | 12,2 | 否 | 0 | 订单总金额 |
| paid_amount | DECIMAL | 12,2 | 否 | 0 | 已支付金额 |
| unpaid_amount | DECIMAL | 12,2 | 否 | 0 | 待支付金额 |
| order_status | SMALLINT | - | 否 | 1 | 订单状态：1-待付款，2-部分付款，3-已支付，4-进行中，5-已完成，6-已取消 |
| payment_status | SMALLINT | - | 否 | 1 | 支付状态：1-待支付，2-部分付款，3-已支付 |
| assigned_user_id | BIGINT | - | 否 | - | 负责销售人员ID |
| order_date | TIMESTAMP | - | 否 | NOW() | 下单时间 |
| completion_date | TIMESTAMP | - | 否 | - | 完成时间 |
| creator_id | BIGINT | - | 否 | - | 创建人ID |
| status | SMALLINT | - | 否 | 1 | 状态：1-正常，0-删除 |
| created_at | TIMESTAMP | - | 否 | NOW() | 创建时间 |
| updated_at | TIMESTAMP | - | 否 | NOW() | 更新时间 |

**订单状态流程:**
1. 待付款 → 2. 部分付款 → 3. 已支付 → 4. 进行中 → 5. 已完成
                                    ↓
                               6. 已取消

#### 2.4 order_items (订单商品表)
存储订单中的具体商品信息。

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | BIGSERIAL | - | 是 | 自增 | 主键 |
| order_id | BIGINT | - | 是 | - | 订单ID |
| product_name | VARCHAR | 200 | 是 | - | 商品名称 |
| product_type | VARCHAR | 50 | 否 | - | 商品类型 |
| price | DECIMAL | 10,2 | 是 | - | 商品价格 |
| quantity | INT | - | 否 | 1 | 购买数量 |
| service_period | INT | - | 否 | - | 服务期(月) |
| service_start_date | DATE | - | 否 | - | 服务开始日期 |
| service_end_date | DATE | - | 否 | - | 服务结束日期 |
| consumption_status | SMALLINT | - | 否 | 1 | 消耗状态：1-未开始，2-进行中，3-已完成 |
| consumption_progress | VARCHAR | 50 | 否 | - | 消耗进度描述 |
| remarks | TEXT | - | 否 | - | 备注 |
| created_at | TIMESTAMP | - | 否 | NOW() | 创建时间 |
| updated_at | TIMESTAMP | - | 否 | NOW() | 更新时间 |

#### 2.5 payments (支付记录表)
记录订单的支付流水信息。

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | BIGSERIAL | - | 是 | 自增 | 主键 |
| order_id | BIGINT | - | 是 | - | 订单ID |
| payment_no | VARCHAR | 50 | 否 | - | 支付流水号 |
| payment_amount | DECIMAL | 10,2 | 是 | - | 支付金额 |
| payment_method | VARCHAR | 50 | 否 | - | 支付方式 |
| payment_channel | VARCHAR | 50 | 否 | - | 支付渠道 |
| payment_time | TIMESTAMP | - | 否 | NOW() | 支付时间 |
| payment_status | SMALLINT | - | 否 | 1 | 支付状态：1-支付成功，2-支付失败，3-退款 |
| payment_type | SMALLINT | - | 否 | - | 支付类型：1-定金，2-尾款，3-全款 |
| transaction_id | VARCHAR | 100 | 否 | - | 第三方交易ID |
| remarks | TEXT | - | 否 | - | 支付备注 |
| creator_id | BIGINT | - | 否 | - | 创建人ID |
| created_at | TIMESTAMP | - | 否 | NOW() | 创建时间 |
| updated_at | TIMESTAMP | - | 否 | NOW() | 更新时间 |

**业务关系:**
- 订单与支付：一对多关系（支持分期付款）
- 支持多种支付方式：微信支付、支付宝、银行转账等

### 3. 营销管理模块

#### 3.1 campaigns (推广活动表)
管理营销推广活动的全生命周期。

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | BIGSERIAL | - | 是 | 自增 | 主键 |
| name | VARCHAR | 200 | 是 | - | 活动名称 |
| channel_type | VARCHAR | 50 | 否 | - | 渠道类型 |
| channel_name | VARCHAR | 100 | 否 | - | 渠道名称 |
| campaign_url | VARCHAR | 500 | 否 | - | 活动URL |
| qr_code_url | VARCHAR | 500 | 否 | - | 二维码URL |
| landing_page_config | TEXT | - | 否 | - | 落地页配置，JSON格式 |
| form_config | TEXT | - | 否 | - | 表单配置，JSON格式 |
| start_date | DATE | - | 否 | - | 活动开始日期 |
| end_date | DATE | - | 否 | - | 活动结束日期 |
| total_budget | DECIMAL | 12,2 | 否 | 0 | 总预算 |
| daily_budget | DECIMAL | 10,2 | 否 | 0 | 日预算 |
| actual_cost | DECIMAL | 12,2 | 否 | 0 | 实际花费 |
| pv_count | INT | - | 否 | 0 | 页面访问量 |
| uv_count | INT | - | 否 | 0 | 独立访客数 |
| leads_count | INT | - | 否 | 0 | 产生线索数 |
| conversion_count | INT | - | 否 | 0 | 转化数量 |
| conversion_rate | DECIMAL | 5,2 | 否 | 0 | 转化率(%) |
| roi | DECIMAL | 8,2 | 否 | 0 | 投资回报率 |
| campaign_status | SMALLINT | - | 否 | 1 | 活动状态：1-进行中，2-已暂停，3-已结束 |
| creator_id | BIGINT | - | 否 | - | 创建人ID |
| status | SMALLINT | - | 否 | 1 | 状态：1-正常，0-删除 |
| created_at | TIMESTAMP | - | 否 | NOW() | 创建时间 |
| updated_at | TIMESTAMP | - | 否 | NOW() | 更新时间 |

**支持的渠道类型:**
- SEM搜索：搜索引擎营销
- 表单推广：在线表单收集
- 海报活动：线下推广活动
- 电话推广：电话营销

#### 3.2 campaign_daily_stats (活动数据统计表)
按日统计推广活动的效果数据。

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | BIGSERIAL | - | 是 | 自增 | 主键 |
| campaign_id | BIGINT | - | 是 | - | 活动ID |
| stat_date | DATE | - | 是 | - | 统计日期 |
| daily_pv | INT | - | 否 | 0 | 当日PV |
| daily_uv | INT | - | 否 | 0 | 当日UV |
| daily_leads | INT | - | 否 | 0 | 当日线索数 |
| daily_conversion | INT | - | 否 | 0 | 当日转化数 |
| daily_cost | DECIMAL | 10,2 | 否 | 0 | 当日花费 |
| daily_conversion_rate | DECIMAL | 5,2 | 否 | 0 | 当日转化率 |
| created_at | TIMESTAMP | - | 否 | NOW() | 创建时间 |
| updated_at | TIMESTAMP | - | 否 | NOW() | 更新时间 |

### 4. 跟踪记录模块

#### 4.1 tracking_records (跟踪记录表)
记录线索和客户的跟踪沟通信息。

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | BIGSERIAL | - | 是 | 自增 | 主键 |
| target_type | SMALLINT | - | 是 | - | 目标类型：1-线索，2-客户 |
| target_id | BIGINT | - | 是 | - | 目标ID |
| record_type | VARCHAR | 50 | 否 | - | 记录类型 |
| content | TEXT | - | 是 | - | 跟踪内容 |
| contact_method | VARCHAR | 50 | 否 | - | 联系方式 |
| next_follow_time | TIMESTAMP | - | 否 | - | 下次跟进时间 |
| intention_level | SMALLINT | - | 否 | - | 意向度评估 |
| creator_id | BIGINT | - | 否 | - | 创建人ID |
| created_at | TIMESTAMP | - | 否 | NOW() | 创建时间 |
| updated_at | TIMESTAMP | - | 否 | NOW() | 更新时间 |

**记录类型包括:**
- 首次接触
- 跟进沟通
- 成单确认
- 回访服务
- 投诉处理

### 5. 系统日志模块

#### 5.1 operation_logs (操作日志表)
记录用户的系统操作行为。

#### 5.2 login_logs (登录日志表)
记录用户登录和会话信息。

### 6. 文件管理模块

#### 6.1 files (文件表)
管理系统中的文件上传和存储。

## 索引策略

### 1. 主要查询索引
```sql
-- 用户相关索引
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_users_department_role ON users(department_id, role_id);

-- 线索相关索引
CREATE INDEX idx_leads_phone ON leads(phone);
CREATE INDEX idx_leads_assigned_user ON leads(assigned_user_id);
CREATE INDEX idx_leads_source ON leads(source_channel, source_type);

-- 客户相关索引
CREATE INDEX idx_customers_phone ON customers(phone);
CREATE INDEX idx_customers_assigned_user ON customers(assigned_user_id);

-- 订单相关索引
CREATE INDEX idx_orders_customer ON orders(customer_id);
CREATE INDEX idx_orders_order_no ON orders(order_no);
```

### 2. 时间查询索引
```sql
-- 按时间查询的索引
CREATE INDEX idx_leads_created_at ON leads(created_at);
CREATE INDEX idx_customers_created_at ON customers(created_at);
CREATE INDEX idx_orders_date ON orders(order_date);
CREATE INDEX idx_tracking_created_at ON tracking_records(created_at);
```

### 3. 状态查询索引
```sql
-- 状态相关索引
CREATE INDEX idx_leads_status ON leads(follow_status, status);
CREATE INDEX idx_customers_status ON customers(customer_status, status);
CREATE INDEX idx_orders_status ON orders(order_status, payment_status);
```

## 数据关系图

```
部门 departments
    ↓ (1:n)
角色 roles
    ↓ (1:n)
用户 users
    ↓ (1:n)
线索 leads ──转化──→ 客户 customers
    ↑                    ↓ (1:n)
    │                 订单 orders
推广活动 campaigns        ↓ (1:n)
    ↓ (1:n)            订单商品 order_items
活动统计 campaign_daily_stats
                       订单 orders
                          ↓ (1:n)
                       支付记录 payments

跟踪记录 tracking_records ←──关联──→ 线索/客户
操作日志 operation_logs ←──记录──→ 用户操作
登录日志 login_logs ←──记录──→ 用户登录
文件 files ←──关联──→ 各种对象
```

## 数据安全

### 1. 密码安全
- 用户密码使用BCrypt算法加密存储
- 密码字段长度设置为255字符，支持复杂加密结果

### 2. 敏感信息保护
- 手机号等敏感信息在应用层进行脱敏显示
- 支持数据权限隔离，基于部门和角色控制数据访问

### 3. 软删除机制
- 重要数据采用软删除，通过status字段标记
- 保留数据完整性，支持数据恢复

## 性能优化

### 1. 查询优化
- 为高频查询字段创建合适的索引
- 使用复合索引优化多条件查询
- 避免全表扫描，合理使用分页查询

### 2. 连接池优化
- 配置合适的数据库连接池大小
- 设置连接超时和回收策略
- 监控连接池使用情况

### 3. 数据归档
- 定期归档历史数据，保持活跃数据表的合理大小
- 对日志表实施定期清理策略

## 扩展性设计

### 1. 水平扩展
- 表结构支持分库分表扩展
- 主键使用BIGSERIAL，支持大数据量

### 2. 功能扩展
- 预留扩展字段，便于新功能添加
- JSON字段支持灵活的配置存储

### 3. 集成扩展
- 不使用外键约束，便于跨数据库集成
- 统一的API接口设计，支持多系统对接

## 使用说明

### 1. 初始化数据库
```bash
# 使用Python脚本初始化
python database_init.py init

# 检查数据库结构
python database_init.py check

# 重置数据库（慎用）
python database_init.py reset
```

### 2. 连接配置
参考 `database_config.py` 文件获取连接配置信息。

### 3. Spring Boot集成
使用 `application-database.yml` 配置文件进行Spring Boot项目集成。

## 维护建议

### 1. 定期备份
- 建议每日进行数据库备份
- 重要操作前进行手动备份

### 2. 性能监控
- 监控慢查询日志
- 定期分析索引使用情况
- 关注数据库连接数和性能指标

### 3. 数据清理
- 定期清理过期的日志数据
- 归档历史订单和跟踪记录
- 清理无效的文件记录
